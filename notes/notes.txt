Protocol and design notes



Command packet format
Byte 0: header byte (0xFF default)
Byte 1: port ID (0x00 - 0x03)
Byte 2-3: command

Data packet format
Byte 0: header byte (0xFF default)
Byte 1: port ID (0x00 - 0x03)
Bytes 2-3: length in bytes



Jan 18, 2015

- Micron DDR3 sim testbench

D:\projects\cdp\libs\micron_ddr3>iverilog -g2012 -Dsg125 -Dx16 -Dden2048Mb tb.v ddr3.v -o ddr3_tb

D:\projects\cdp\libs\micron_ddr3>vvp ddr3_tb
ERROR: $urandom_range requires two arguments.
ERROR: $urandom_range requires two arguments.
ERROR: $urandom_range requires two arguments.
-> fixed, added 0 as 2nd arg in subtest.vh

Confusing pins on DDR:
    cs_n - can tie low
    dm_tdqs - connect to dm
    tdqs_n - can be high impedance


Compiling FIFO-DDR testbench:
D:\projects\cdp\fpga_projects\usb_fifo_ddr>iverilog -g2012 -Dsg125 -Dx16 -Dden2048Mb -o usb_fifo_ddr_tb -I "D:\projects\cdp\libs\micron_ddr3" -y "C:\Xilinx\Vivado\2014.4\data\verilog\src\unisims" -y "C:\Xilinx\Vivado\2014.4\data\verilog\src\retarget" -s usb_fifo_ddr_tb -f sources.txt -f mig_sources.txt

D:\projects\cdp\fpga_projects\usb_fifo_ddr>iverilog -g2012 -Dsg125 -Dx16 -Dden2048Mb -o usb_fifo_ddr_tb -I "D:\projects\cdp\libs\micron_ddr3" -y "C:\Xilinx\Vivado\2014.4\data\verilog\src\unisims" -y "C:\Xilinx\Vivado\2014.4\data\verilog\src\retarget" -s usb_fifo_ddr_tb -f sources.txt -f mig_sources.txt

Aug 1--12, 2016
---------------
See paper notes packet on "DA platform resumption"
Much progress was made: basic audio output on ZTEX platform working, but there are glitches
ADC hardware is probably bad; so is DAC I/V conversion
Started working on an I2S loopback test to get that aspect working (slot 1 has DAC, slot 0 has ADC)

Dec 30, 2016
------------
Resurrecting project (again).  Keeping electronics notes since they last longer.

Startup procedure:
- Ensure that boards are hooked up
- program FPGA using FWLoader or Vivado
- run python ztex_test.py

Current state:
- can (most of the time) write/read one chunk of a small number of samples (80)
- can't do anything after that (hard lockup), even after reset_slots
    Note: reset_slots work but slot write FIFO command doesn't
    which indicates that top level I/O might be alright, but slot isn't

Short term: review I/O protocol to see what the device is supposed to be doing
    Looks like we're doing the right thing; short global commands don't have checksum like per-slot commands

ILA debug
    When SW gets stuck, main module is in state 2 (handle output) with write_counter 0xf4
    That doesn't seem right... let's check after the small initial test -> state 0, word counter 1
    Receiving the start-recording command goes alright
    Then we get some output... maybe we started writing samples and read samples came back at the same time?
        No, I never trigger the handle input state after recording started
        Was I2S running, or was there some buffer with samples left in it?
    It's possible to read 512 samples before even writing anything.
        -> Yes, I2S is left running.
        It looks like this is by design.  I2S outputs for DAC are always running and the data is all zeros.
    There is probably some problem parsing the ADC audio messages in SW
    After testing fixed data, there is a 22 word message left in report_unparsed
        It is an incomplete ADC audio packet
        That's because we were flushing by using low-level read() and not update_receive_state()
        Using a new flush() function seems to get rid of the leftovers, most of the time?
        This allows us to at least proceed to continuous test
    Continuous test: gets through 3 chunks (768 samples each way) then hangs
        It seems there is too much data waiting to be read
        Try, for now, reading more data than we wrote
        See if we can at least get continuous operation...
        If I read 4x as many samples as I write, it runs without crashing... but there are tons of zeros
        How to get things running at the same rate?  Big FIFOs?
        It looks like there are basically no FIFOs internally.  da_platform has 16 word FIFOs, and connects directly to EZ-USB.
        -> Increase size of da_platform FIFOs... trying 1k words
        With 1k FIFOs, still need to read at 2x write speed to avoid lockup... why?
        Bringing chunk up to 256 and reducing read timeout to 10 allows continuous operation
    Now time to investigate sample errors
        First 256 samples look good, then there are 186 zeros, then 256 more samples, then more zeros
        In general, it looks like there are some hiccups at beginning and eventually it gets "into a rhythm"
        First 178 samples OK, then samples 178--255 are a repeat of samples 0--77; then we have a string of zeros before correct samples resume
        Run to run, the exact number of samples varies (e.g. 176, 246)
        Note: switched to ramp input (i.e. count 1 to 44100) to avoid ambiguity.
    Trying ILA debug in arbiter to see if that has anything to do with it.
    Could this be done in simulation?
        Once we have a more detailed sense of the problem.  No sense wandering aimlessly in sim.
    Experimenting with smaller chunks, to see if the error can be tracked down
        With chunk size = 128, caught error on Logicport. (Lesson: DAC output is messed up.)
        After sample 88, left channel outputs 89 then right channel 0, both channels 0, then both channels 1
        Error is hard/impossible to trigger with a chunk size of less than 120
        But I saw it happen as early as sample 67
        Arbiter FIFOs have a 64 word capacity (1 word = 32 bits = 1 sample for 1 channel)
        Read side of DAC port has 80 word capacity.  
        Arbiter fills that up, then writes short bursts of typ. 9 words at a time to RAM FIFO
    Try another ILA test looking more at arbiter port 1
        In the "bad" case, it looks like samples get read during the write burst?
        Sim has a problem I haven't seen in reality: 1 word gets dropped from host input, leading to 16-bit shift in audio samples
            This seems to be caused by a modeling issue - main I/O had a repeated word, but I don't think this happens in reality
        Look at data going into arbiter's main write FIFO?
        arbiter.ports_dup[1].write_fifo output doesn't wrap around
        Main write FIFO in doesn't wrap around... need to look at main read FIFO out
        Read FIFO output does wrap around.
        -> Problem seems to be in either those FIFOs or the DRAM FIFO
            Mem write FIFO doesn't wrap around (i.e. main write FIFO out)
            Mem read FIFO does wrap around (i.e. main read FIFO in)
        Confusion between slots, maybe?
        Check internal FIFOs within MIG adapter.
            Write side: Not wrapping around
            Read side: Wrapping around
        -> MIG adapter must be getting confused between the two ports somehow.
        Try disabling recording. -> no wraparound on MIG read
        So what exactly is happening, with recording enabled?
            When ADC is writing 0x12e, DAC is reading 0x21
            So when ADC was writing 0x21, what was DAC doing?
            When DAC was writing 0x1ca, ADC was writing 0x003 to location 0x161 [wraparound at sample 0x160]
            And DAC was reading 0x57...
        Errors seem to happen whenever the ADC starts to get nonzero samples
            i.e. DAC errors start as soon as ADC samples are nonzero
            If DAC-ADC latency is larger than entire signal, then we don't notice errors
            Actually, this isn't DAC-ADC latency, this is software latency from start_recording to write_audio
            So something goes wrong as soon as DAC and ADC are going at the same time
            Memory address aliasing?  (ADC data overwrites DAC data)
    -> There was a memory aliasing issue. 2 bugs:
        Memory address app_addr was coded as [23:0], needed to be [27:0]
        Address was zero-padded going into MIG, which cut off the upper bits
        
On to the next set of problems
    First 512 samples recorded are fine, but then there are gaps
    The gaps are especially large near the beginning, but they don't entirely go away with time
    Software shows that the time to write each packet goes down
    -> Is this purely an issue of software-lag in sending samples?
        Writes only (no recording) takes 40-50% of real time at chunk size 256, 20% at 2048, 7-10% at 32k+
        It would be reasonable to assume that when you add reading, you're too slow
        Some slowdown is probably due to the VM, but still.  
        This is just 44.1 kHz stereo (32 bit = 352.8 kB/s), it should work fast.
        Right now it's about 4.6 MB/s at most, and it should be 40.  (ZTEX test of VM clocked at 9 MB/s.)
        Maybe this is a problem for later.
    So, should reads be at the request of the host?  How does the system know when to read out data from a particular port?
        Imagine that it isn't at request of the host. We can
            a) Wait for a certain number of samples to accumulate in the mem FIFO
            b) If idle, wait for a certain number of idle cycles to discharge the next port (round robin)
        Currently we are doing (b)
        The problem is, the host doesn't know when to read.  
            It could be trying to write when there is read data being sent (which wouldn't work).
        Let's look at how USB device drivers (audio class) do it.
            First, it looks like these are meant to be stereo out / mono in only.  Not so versatile.
            In USB, the source and sink endpoints are independent.  In other words, it can send and receive audio concurrently/independently.

1/1/2017
--------

Some background research
    ALSA
        has an "external plugin interface" that could be used to create a user space PCM driver
        already has a "file" plugin which can pipe a stream to a file or to a shell command (i.e. Python audio playing script)
        A plugin, once created, can be used by putting the right stuff in the .asoundrc file
        A plugin can also act as a signal source
    -> It is alright to work purely in user-space for now; ALSA will allow a user-space program to connect to other Linux apps
    Windows
        There is a user-mode driver framework, but it's apparently no good for drivers
        Tim Roberts of Probo recommends AVStream, but an easier method is a Directshow source filter
        Microsoft has an updated driver example: https://github.com/Microsoft/Windows-driver-samples/tree/master/audio/sysvad
        More documentation on MSDN
        But Windows programming is hard.
    USB audio class
        Seems to not be what we need.  But sometime down the line, it would be possible to alter the hardware architecture
        to comply with this spec.  (Multiple endpoints)
    Strategy for now (1/1/2017): make the hardware as simple as possible, do everything in userspace (i.e. request data from ADCs)

Implementing audio read request

1/2/2017
--------

    First test: send separate msg instead of read request at end of write msg
        No ILA
        Looks like we get data back, but even with blocking slots there's a big batch of audio at beginning - why?
        Also, we get an extra word received which throws off receive parsing
        In all, we don't get any valid samples back (maybe with a larger chunk we get one chunk?)
        After making audio_read use update_receive_state and requesting exact number of words: it takes 100 ms to receive even 32 samples (same for 64 samples) -- something in the USB chain?
        Larger chunk size fixes that, but:
        - Received data starts around 500 - is there a lag when unblocking slots, or lost samples?
           (Stop using slot-blocking for now)
        - FIFO status shows what you'd expect: massive number of ADC samples piling up and not being read
        - With a long enough timeout, it's possible to retrieve all of those samples at the end
        - As you'd expect, in the recording there are wide gaps between the chunks of valid samples, due to the long latency as seen by software
        -> Latency was being artificially supported by pktend_timeout input to ezusb_io
           Setting that to min. reduces latency from 100 ms to 1.3 ms
        Now, there are some performance issues in the software (multiple roundtrips).  Need to fix later.
        But by making the chunk size large enough (2k samples / 45 ms) we can close the loop in real-time.
        Now we see additional artifacts:
        1. Dropped samples (gap of 2 sample periods with 0 values, then signal resumes as if it "forgot" one sample)
           Note: sometimes there are gaps spaced by just 1 valid (mono) sample:. we drop LR then have a good L sample then drop RL
        2. Wrong samples (word swap?) - look into later
        Simulation probably isn't going to reveal these artifacts, but in the testbench there was a clock bug.  Could we be seeing a clock bug?
            Current clock structure: 
            - ifclk (generated by ezusb_io) used as host interface and core clock
            - fxclk used to generate 200/400 MHz memory clocks within da_platform_wrapper
        Example of bug: 2k chunk size, gap from 1703-1707 with first nonzero = 1224, or 679-683 with 971, 679-683/1138
        The gaps show up at the exact same places (679, 1703, ...), plus or minus a couple of samples
        Sometimes the gaps appear to have a regular pattern (every 512 samples?) but not always
        Are these gaps in playback or recording?  Try playing ones and looking at ILA
        Can't see since ILA only gets about 3 ms / 130 samples, while first gap is around 340
        Seems data dependent: if I change from a ramp to something else, errors go away
        -> So why not make the ILA trigger on the data?
    With the ILA, things actually get better... don't see errors at 680 again
        Look for something regular though
        Sometimes there are errors on a chunk boundary, e.g. 4k
        It took many tries to get a gap within a single chunk : 13654/16k/1382
        Seems possible to get error at 10920
        These errors aren't sufficiently repeatable.  Try different input patterns.
        -> To investigate async FIFO issues, could use ifclk instead of fxclk to generate mem clock (then it would be 192 rather than 200 MHz... close enough?)
        DAC sample == 0 didn't trigger when there was a gap in the output, so this is *probably* on the recording side
        Bad I2S connection? Fiddling with the wires made the problem worse.
        -> Try soldering I2S wires
        That's where the glitches within a chunk were coming from; probably parasitics, rather than bad connection
            (since moving the wires around makes more difference than soldering)
        Now we have to deal with gaps between chunks
        -> Was buffer underrun.  Just writing 1 chunk before starting reads fixes that, though smarter SW arch will help in the future.
        
    Time for a song test (4 minutes / 11M samples)
        First run: there was a 64 sample long error at 16M/22M
        This corresponds with 2^24 samples since the start of recording
        -> Explore in sim with region depth of 64 samples
        In sim, data after 171 is a bunch of zeros, followed by 107 (only) then 108--171, e.g 64 samples of errors?
        At least debug the sim...
    -> Clean results on 2 different songs (4-5 min each); no longer term testing yet
    
Now, try listening and measuring.
    Yuck.
    Lots of gain.
    Left channel distorts really fast
    Right channel may be a bit cleaner, but both have lots of spiky artifacts?
    At idle there are lots of spiky artifacts, i.e. 0s going into I2S
    Rate of spiky artifacts goes up significantly when music is playing
    Let's see if the loopback test still works, then disconnect I2S jumpers.  I2S could be coupling into I/V.
    -> Aha. Millions of errors.
    Disabled recording; shoved I2S wires out of the way.  Now fewer artifacts, but still some.
    -> Try to desolder them now.
    Left channel has way more gain than right (test at some point by exchanging I/V boards)
        Confirmed, this is with S/N 1 on left, S/N 2 on right; swapping I/V boards changes the gain
        Scope app confirms: gain difference is about 6, or 16 dB
    I2S wires removed: still clicking artifacts, but less than before
    For now, use the louder channel and try to fix clicking
        THD doesn't look so bad, if you ignore the clicking
        Clicking is scaled down in left channel, so it's present in the DAC output (not IV induced), and seems to happen on the same samples in L/R channels
        Probably 1-sample spike with pre- and post-ringing due to lowpass
        I2S signals themselves are probably fine.  
        Low quality of clock reaching DAC?
        When I did the I2S loopback test I was probing the I2S lines after the register.  And since those were fine, my guess is the DAC is having issues with the clock.
    Also try slot 0?
    -> Much better.  Must have been something wrong with slot 1 (probably clock distribution)--check soldering and layout.
    No spikes, though there is some hum (not too bad
    Back to the FFT.
        See measurements.txt.  SNR 79 dB, THD is generally around -70 dB though better around -20 dBFS
        Good enough for now.  Let's fix that other channel.

S/N 2 I/V stage debug
    Bias checks....
        Output: -39 mV on left, +196 mV on right (note: L- output is 86 mV)
        Inputs: R 5.6/5.3 mV, L 3.7/5.4 mV
        Current source (base): R 13.58/-13.63, L 13.52/-13.61
    Inspection.  Differences:
        R13 and R16 = 82.5 (L) / 47.5 (R)
        R12 = 1k (L) / 82.5 (R)
        The lower channel (neg out) is consistent with pos
    So what do those differences mean?
        a) R12
            This sets bias current for Q12.  With 82.5 ohm, expect 10.5 mA.  With 1k, expect much less (and clipping).
            Is this dependent on the zero point of the DAC?
            Datasheet says the center current is -6.2 mA.  Maybe I had the sign wrong?
        b) R13/R16
            This sets bias current for MOS output follower
            47.5 -> 18 mA
            82.5 -> 11 mA
            Why not leave these as is and see which channel is better
            (Maybe I changed that value for Sourcemeter testing?)
    -> Removed R12, it looks like I had the wrong sign on the datasheet current offset.
    THD is better without R12 esp. at high output (see measurements.txt)

At this point, the hacky setup is working as 2-channel DAC (see pictures).
    Stereo output (with isolation transformer) is reasonably clean.  
    THD < -80 dB in both channels at -30 dB and up
    Added to rack and configured laptop for testing with speakers
    Initial listening impressions: (comparing to memory of modified RCD-855 CD player)
        Reasonably relaxed, haven't been driven out of the room.
        Midrange a little more spacious?
        Bass is lean (good) and clean, but perhaps doesn't have as much impact as RCD-855
        Treble: noticeably drier, doesn't have the same body as before
            This might motivate a voicing adjustment on the speakers?
            Clean and detailed, though something might be missing.
        Better than Ezra track 12 was beautiful.
    Second listening (note: a little sick)
        More polite, peaceful.  Kind of sleepy? (Bela Fleck, Lumineers)
        Easier to follow the melody of the secondary instruments
        Missing the sense of body and impact (at moderate levels)

== End of sprint winter break 2016/2017 ==

Revisions to try on initial setup
- IV stage antialias filter (1st order: 3.3 nF cap to ground from IVOUT node of 750 ohm resistor)
- Different clock or clock distribution


1/4/2017
--------
Tried music server setup
    MPD on Linux VM
    Files shared over Samba (host: Windows PC)
    MPDroid on Android tablet
Seems to work, but didn't check audio output
    Wish list: album art?
Plan is to run MPD on a Raspberry Pi 3, should have a footprint for it on PCB


1/6/2017
--------
Trying IV stage antialias filter
First try, blew up IV stage output buf with shorted output (maybe some protection would be nice...)
Replaced MOSFET
Second try, got a lot of the clicking artifacts (bad clk/I2S signal integrity? more debug needed)
-> Needs more debug, and probably a hardware rev

1/7/2017
--------
Started bringing up DAC 8 ch board
Refreshed memory on the circuit.  Distortion performance may need improvement.
Plugged it in and turned on - nothing blew up.  
SV changes:
    - open up 8 channel I2S port support (when dir=1 chan=1) -- done
    - will need to support different SPI formats - currently only 16 bit (8 bit addr, 8 bit data) for DSD1792
        AD1934 needs 24 bit (8 bit global addr +RW, 8 bit reg addr, 8 bit data)
      in theory, there is a way to do this (in spi_master interface) but slot_controller hardcodes the bits.
      Just spend some time in the sim to prototype.

Note:
    When you have SPI working, carefully go through registers in the datasheet and make sure the settings make sense.
        i.e. read all regs, see initial vals, reprogram and reread
    Reg 0 bit 7 is internal MCLK enable - needs to be set to 1 for DAC to work?
    Reg 0 bit [4:3] is MCLKO pin - we can disable (set to 11) since MCLKO is NC
    Reg 1 bit 0 and 1 select between PLL (0) and MCLK (1)
    Try internal PLL, see if it helps over direct input

1/14/2017
---------
Modified SPI command handling in slot controller - new msg format needs to be migrated to Python code
Seems to do something, although the bits of each byte read are shifted left one, and bit 0 is then repeated

Soldered a pigtail for 4 channels (no matter, with only 1 scaler board we can only get 2 channels)

Examining output of first 2 channels - DC offset
    1L  170 mV
    1R  640 mV
    -> bad
    DC level of DAC output pins is 1.58 V - same as CM

Now check AC...
    1L  ~40 mV (wandering... just hook up and see)
    1R  ~90 mV
    
8-ch I2S: Looks like it's working, according to ILA

Need to look at 
a) DC operating point of scaler
b) Whether DAC outputs are doing anything
    No.  Probing output 2L gives const ~50 mV
    Probably jibberish because of no clock lock

Viewing on  scope:
    1L output does... nothing, but noise and offset
    
OK, alt. strategy: try using the PLL
    If I leave registers in default config, AC on output goes away; supplyign audio doesn't do anything
    Now turn on MCLK?
    I can see a little signal at the output... and not as horrible noise.
    Hey, a 400 Hz sine wave!  But it's really small, and doesn't register on the multimeter (AC volts) either.
    That's because the level was set in SW at -60 dB.  -40 is bigger.  Big enough to look clean.
    Definitely some clipping - 1.2% THD at 1 kHz full scale
    At -20 dB?  0.1%.  Not horrible, but mediocre.
    Some may be coming from transformer due to DC offset.  But yay, DAC is working!
        Nope, still 0.1% when bypassing transformer.  0.3% at -10 dB, 0.08% at -30
        1% at full scale... Hmm.
        According to LTspice it should be 0.1%, and most of it is coming from the diff pair.
        But my diff pair bias is at 6 V instead of 8 V - 12 mA instead of 9?
        Main diff pair should be 20 mA if the right resistors were used.  Increasing bias doesn't hurt distortion in LTspice.
        0 dB FS spectrum really looks like clipping the sound card.  Back off..
        At -3 dB, No more clipping, but still 0.8% THD.  Fund at -3, H2 at -45, H3 at -74
            -> mostly 2nd harmonic, 3rd harmonic is in line with expectations
    Definitely 2 problems: DC offset due to poor MOS matching, and crappy SMD caps that leak?
        The caps could be the cause of the HD also?  Maybe not.
        
    
So, need to fix the scaler.
    DC offset may just be down to MOSFET matching.  Vgs is supposed to be 0.8-2.4 V, and I made no effort to match.
    though there's a creepy 300 mV voltage drop across the gate resistors - why is there DC current? (bad soldering/bad caps?)
    
Do all 4 channels work?  (Test and write THD at -20 dBFS)
    1L: Yes, 0.11%
    1R: Yes, 0.03%
-> NM, scaler isn't plugged in.  Need more scalers.  But can test 8 DAC channels by moving scaler once fixed.

Also, note that the DAC does not work when external MCLK is selected or when MCLK is used as the PLL source.
But how do the I2S signals get in?  maybe there is a bad connection.

1/15/2017
---------
Viewed the 11.2896 MHz clock at the DAC board on the scope today
Note: scope probe adds additional ~10 pF load; scope itself has 20 pF, but it's a 10x probe

With scope hooked up to clock, PLL recovering LRCK may not work as reliably? Not sure.

Waveform obs:
    Freq looks OK, but there might be a massive amount of jitter?  Can't resolve waveform properly on my scope.  Trigger settings seem to impact display.
    Exponential decay rising.  No flat top.  Looks like a sawtooth almost.
    Voltage range = 0.2 to 2.6 V
    Slew (1-2 V) time = 12 ns (note: scope bandwidth may be coming into play)
    

Probe elsewhere to see if the wave shape changed?
    At the oscillator, it's much sharper, 0 to 5 V, 4 V rise in 10 ns -> scope isn't the main factor
    
    With DAC in slot 0, it looks, possibly, a little less jitter, but peaks at 2.5 V

Note: 74VHC04 output current specced at 4 mA for 3.0 V supply
    So, with 20 pF load, that's a slew rate of 0.2 V/ns or 5 ns/V
    We see 12 ns/V which would mean the load is closer to 50 pF? 

Switching CLKSEL = 0x0D on other channels to other clock makes a difference
Faster rise time, but harder to trigger; why?
Closer to 8 ns/V; voltage range now 0--2.9 V
    e.g. we went from 50 pF to 35 pF
But then the DAC doesn't work (recovering from LRCK).

Wait: ADG1436 has some significant cap.
    Cs (off) = 23 pF
    Cd (off) = 50 pF
    Cd+Cs (on) = 120 pF
    ???
    So maybe the 7404 is fine and we're just loading the crap out of it.

Multimeter shows 195 pF from CLK0A to gnd, minus 31 pF from holding wire nearby -> 164 pF

What about from SCLK1 (output side of switch)?
    115 pF (minus about 20 from holding wire) - with DAC8 board in place
    100 pF without DAC8 board
    
Wow.  Alright, clock switching needs to be rethought.
No "smoking gun" for PLL clock and clicking issues, but it's pretty strong circumstantial evidence.

So what's the plan?  Some options (non-exclusive):
    a) Rev the scaler and IV boards for better analog performance with same DAC2/DAC8 boards.  (Need more scalers anyway...)
        This will make me feel better since I don't want DC offset going into the amps or into the analog XO input transformers
        Also provides a warmup for Eagle, PCB ordering and assembly (get the necessary tools for SMT)
    b) Do mods to the current isolator board to improve clk reliability i.e. cut/jump (say, eliminating clock switching; 44.1 OK for now)
    c) Try to get the 8 channel ADC working
        Note: LRCLK PLL trick won't work since I2S pin direction is set jointly for all 6 slot data pins
        So, if we want the ADC to output SDATA, it has to also output BCK and LRCK (i.e. I2S master)
        meaning the FPGA cannot supply LRCK
    -> This is unlikely to work given the current clock situation
       So, abandon ADC plans until next isolator rev.
    d) Try to get DAC2 and DAC8 working at same time
        Ideally this would make digital XO and analog XO possible without reconfiguring hardware--just move connectors
    e) While prototype is working with DAC2/8, design next isolator rev.
    
-- Plan selected: (a), (b), (d), (e) in that order


1/15/2017 (Later that day)
----------

Experimenting with I/V stage.
Using ideal current sources to identify fundamental distortion sources

Baseline signal is 6dB at 1k, dist is -78 dB at 2k (-84 dB), -114 dB at 3k
    Not bad, but let's see if we can knock down the 2nd harmonic

Does Wilson current mirror help?
    No.
    
How about a regular cascoded current mirror?
    No.
    
So what's the nonlinearity from?
    Base current?  Varies between 21-48 uA at full scale

Try 10x current.. (and 10x power supply)
    Now base current is 390-435 uA
    OK, that made a small difference in THD... 2nd harmonic is down to -81... obviously not worth it
    
Try 1/10 voltage gain (75 ohm resistor instead of 750)... same 10 mA bias
    This gives -14 dB signal and -109 H2 = -95 dB
    So maybe a second stage would help.
    BTW, with 20 mA bias, H2 is same
    So it's not the current but the voltage swing that seems to be causing the distortion
    Nonlinear Vce cap?
    Try boosting supply voltage, see if that's related
    30 V supply, H2 at -111, 2 dB improvement for 2x the supply voltage
    Try 1/5 voltage gain (150 ohm res)... H2 = -100, sig = -8 (-92)
    Looking at Q1 (closest to input), the emitter current is a sinewave, but collector current has distortion -94 dB down (150 ohm or 750 ohm)
    So there is some base current, and that is nonlinear
    Base voltage is moving up and down (as it should)... 88 uV
    Ic from 6-14 mA, Ib from 21-48u -> Beta = 500
    -> Darlington connect?
        This severely raises the floor of the FFT.  Why?
        Compression doesn't affect it
        Tightening abstol makes sim really slow.  Loosening it... makes no difference
        Ah. changed to save sim data starting at 1 ms, maybe there was some transient at the beginning
        Now we're talking.  H2 at -116 with 750 ohm / 10 mA (-122 rel.)
        H3 is a little higher? -134 ... so still better, just not relative to H2.

Now add the MOS follower output buffer, which will probably get replaced eventually.
    V(ivout): Signal at +6 H2 at -115 H3 at -125 (hmm.. higher H3 especially, from loading?)
    V(out):   Signal at +6 H2 at -107 H3 and higher under the numerical floor (-118)
    numerical issue (need to wait more?)
    Wait 10 ms instead of 1.... doesn't help.  Waah?  Simulation accuracy is a pain.
    For some reason, we're good at IVOUT but not on the other side of the cap.

Darlington might be too much gain, see how it introduces higher harmonics?
    -> Deal with this later.  Buy some space first.

Time for bed.  But one problem has been solved (current buffer nonlinearity).  Try the other 3 tomorrow:
    2) Output buffer without DC offset
    3) 2nd order or steeper antialias filter
    4) Practical implementation of current sources that were made ideal for this experiment
    1) Numerical problems preventing accurate sim

Also, what transistor to use?  Want high current gain that's flat with current, and low noise.
    May still have some 2SC2240 lying around.  NXP claims BC849/850 is low noise.  (BC849 = 30 V, BC850 = 45 V, C version has better current gain)
    Borbely recommends 2SC3329/2SA1316
    rljones: 2SA1015L and 2SC1815L
    Bob Cordell: 2N4401/4403
    Salas: "2N4401/4403 will come at circa 0.9nVrtHz and they are a dime a dozen. "
    Maybe noise isn't an issue here since the swing is so big.  It's not a phono stage input.



1/16/2017
---------
LTspice: examine MOS follower distortion
Bias = 1 mA, driving 10k load: not good
Bias = 10 mA, driving 10k load: good, sig -6 H2 -106 H3 -146
    But it probably won't be able to drive heavier loads: H2 = -52 H3 = -68
    -> Output needs to be complementary e.g. diamond-buffer
    Or what about a BJT?
    Nope doesn't help.
Now looking at diamond buffer with BJTs. 600 ohm load
    1 mA bias not enough
    10 mA bias: H2 -83 H3 -75
    Note: into 600 ohm, 2 V RMS = 2.83 V peak = 4.7 mA peak
    Now, with 100 ohm emitter resistors in 1st stage and 10 ohm in 2nd stage: H2 -89 H3 -101
        Note: bias currents are 2 mA and 14 mA
    I think that's good enough given the load.  With 10k: H2 -90 H3 -117
        Hmm, anyway to get H2 down a bit?  (Where does it come from?)
        
Mirroring around the input current seems hard? (what am I missing... I get -70 dB dist even with Darlingtons)

OK, for now, I give up and just hook the load resistor to the supply.
Performance simulated:
    THD in 600 ohm: H2 -97 H3 -110 (rel +6)
    THD in 10k: H2 -99 H3 -115 (rel +6)
    THD in 10k, -26 dBFS: H2 -151, others not visible (rel -20)
    Supply current: about 60 mA (1.8 W)
        Note: much of this is in output stage, can be reduced...
        Biasing = 2 mA
        DAC 16 mA neg, 11 mA pos
        Interstage buffer 4 mA
        Diamond buffer first stage 3 mA
        Diamond buffer second stage 25 mA
    Freq response
        (-3 dB) 1.6 Hz to 55k Hz
        (-0.1 dB) 11 Hz to 20k Hz
        3rd order rolloff
        70 dB stopband suppression (1--100 MHz, no parasitics)
    PSRR
        Pos supply: 0 dB (Adding RC filter just filters HF; cap has to be quite large for LF audio performance to be helped)
            Adding Darlington capacitance multiplier with 10k/10u gets us to 26 dB in most of band (21 dB at 20 Hz)
            MOSFET is same.
            However, this dramatically increases distortion because of the finite output impedance
                14 dbohm = 5 ohm, so 2.5 mA RMS gives us 7.5 mV RMS -> more than -60 dB distortion
            Power the two halves of the differential circuit from the same cap multiplier?
                With ideal current sourec there's about 500 uV left, and distortion is fine.
                -> A viable idea, I think.  Can't complain about 26 dB PSRR.
        Neg supply: 1 dB (why? current sources somehow)
            Yes.  Biasing is proportional to supply.
            Switch to LED based current sources -> 40 dB from neg supply, not bad.
            Still needs to be clean however.
            
            
Choosing output stage bias
    Decreasing the current makes THD go down with 10k load.
    3.5 mA is enough
    So what loads are we going to support?
    May also want power reduction in other places
    But deal with this later. PSRR first.  Leave at 3/20 mA (diamond 1/2) for now = 26 total for output.
    Default version: -95 -107 -140 -145 into 600 ohm, -97 -114 -140 -146 into 10k
        R16/R17 = 475 current = 2/20 mA
    Reduced version: -83 -63 -117 -99 into 600 ohm, -108 -115 -140 -146 into 10k
        R16/R17 = 2.2k current  = 0.5/2 mA
    So, choose based on whether you want heavy load drive or not.
    Also, don't overdrive internal buffer stage (or maybe you should to get more H2).  Reducing bias to gives -112 -115 -140 -146.
        R10 = 1k -> 1 mA
    Can we save any power on the input stage? (without hurting distortion)
    Not really.
    For now, compromised with 1/8 mA output stage, 2 mA internal buffer. 10k gets -101 -115 -140 -146 
        600 ohm load gets -96 -89 -141 -129
    Total power = 1.3 W -> 5.2 W for stereo DAC module
    
Noise is currently about 25 nV/rt(Hz).  -> 5 uV at output, or 112 dB SNR
    Most of this appears at V(IVOut). -> 24 nV
    What's the noise of a 750 ohm resistor? About 4 nV
    R19 and R20 are big contributors.  Investigate tomorrow.
    Interestingly, increasing them decreases the noise.  But does it have any other side-effects?
    Can get down to about 3 uV noise (116 dB SNR) with 220 ohms; doesn't seem to affect linearity (plenty of power burning headroom)

Adding some big decoupling caps on high impedance nodes helps...
    Down to 11.5 nV/sqrt(Hz) in mid/high freqs.  Knee around 100 Hz.  30 nV at 10 Hz. -> ~1.7 uV out, 120 dB SNR
    But that destroys PSRR.  Can't put any cap to ground on Vc node driving current mirror.
    With other caps, PSRR is now around 40 dB on both rails.  But output noise is back to 20 nV/sqrt(Hz).
    With Big Vc cap to negative rail it might work...22 uF (different values do different things)
        + PSRR now degrades at LF... still -26 dB at 20 Hz
        - PSRR is still good
        Noise is good
    -> We have a winner.
    
Also, we should survive an output short circuit for a time.  ~120 mA on supplies means 3.6 W for the channel with the shorted output.
    
TODO: See how much capacitance to load cap multiplier with
But otherwise this is ready to go, I think
    -> No cap needed due to filtering
    PSRR remains at 26 dB (+), 40 dB (-)

Noise is


2/11/2017
---------
Want to design an op amp I/V to compare to DSD1792 discrete version
But what op amp/topology to use?

AD844 - recommended by Pedja with TZ node loaded by resistor to reduce gain
But there are potential problems:
    1) Input stage linearity?  someone mentioned 0.03-0.07% THD which showed up in Ayre CDP output.  Stereophile review of CX-7e
    2) Buffer is bad.  Pedja said 0.5% THD.  So you'd need a buffer IC or discrete from the TZ pin.

What's wrong with AD844 or other fast CFB opamp used the standard way (resistor feedback)?
    Jocko Homo and Elso Kwak didn't like CFB 10 years ago.  Said it sounded bad.
    
Avnet has AD844 slightly cheaper than Digikey.

What to do for the lowpass filter?
    Only get 1 pole with the AD844
    Need a std op amp buffer.  georgehifi from diyaudio.com uses AD825 for 3rd order filter and likes it.  But likes discrete buffer (complementary JFET follower) better.
    Just use ADA4001-2 for the 2 differential halves.

By the way, how about AD812? Cheaper, plus 2 op amps per package.
    Specs?
    OL transresistance is 800k, -In resistance 65 ohm
    145 MHz unity gain bandwidth, 1.6 V/ns slew rate at +/- 15 V
    THD of -90 dB at 1 MHz, but fig 20 shows < -120 dB in audio band (and 2nd above 3rd)
    3.5 nV/sqrt(Hz) voltage noise, 18 pA/sqrt(Hz) current noise -> 13 nV/sqrt(Hz) at output for 2 V RMS single-ended
    This looks like the way to go

Should cancel current offset with a resistor from supply.  
    Experiment with different values?
    But the nominal should balance the 6.2 mA DC output
    And there is a DC blocking cap going into the LP filter also.
    
-> Plan. AD812 configured as recommended by AD844 datasheet for IV conv.  Then ADA4001-2 LPF with same components as discrete version.


2/12/2017
----------
3 PCBs have been designed:
    1. I/V for DSD1792 - discrete version (4 layer) 1.48 x 2.22 = 3.29 in^2
    2. I/V for DSD1792 - opamp version (2 layer) 1.48 x 1.285 = 1.90 in^2
    3. Voltage scaler/filter for AD1934 - opamp version (2 layer) 2.084 x 1.637 = 3.41 in^2

All boards DRC clean in EAGLE, CAM processed for OSHPARK

When to order boards?
    As soon as I'm confident I will be able to use boards in stereo for long term testing
    Prereqs:
        DAC2 and DAC8 working smoothly/reliably (no clock or major noise/distortion issues)
    Not prereqs:
        RPi music server (i.e. laptop hack is OK)
        ADC2 and/or ADC8 operation

What to do before ordering boards?
    1) Test DAC2/DAC8 in as-is configuration.  A) one at a time, B) both
    2) Try clock switch mod
    
Notes on the bringup process
DAC2:
    Lots of nasty noise (-66 dB) and a little sinewave (-40 dB) at 0 dBFS
    0.5 V DC offset... no, 1.15 V / 0.99 V
    Check DC op point: Where is the offset coming from?
        Supplies are OK
        Current inputs at -30, -40, -70, -180 mV
        Try reseating everything... still messy
        Try giving slots 1-3 CLK1 instead of CLK0.  OK, now I get a big sinewave with a lot of glitches.
        And the idle output is full of glitches.
        But this is a separate issue from the DC offset.
        Op amp issues with the cap there?
            LTSpice doesn't see a problem.  And I don't either since it doesn't affect feedback.  Except for stray cap.
            Check DC blocking.  Gate of MOS - either side of big resistor. R17/R27
            R17.  Top side 2.15/1.84 bottom side 2.39/2.10 top side
            R27.  2.08/1.86 bot 2.40/2.14
        Whatever.  Let's deal with clock issue first.

DAC8:
    DC offset looks familiar - 0.16 V in 1 ch, 0.76 V in other
    Got it working in slot 1 - 0.1% THD at -20 dB, 1% at 0 dB (right) 0.035%/1% at 0 dB (left)... not sure of L/R ordering
    with LRCK recovery.  Smooth operation otherwise.
    -> More confidence that clock dist is the main issue.
    
Notes on the clock hacking
    Plan: Remove IC35/36 (ADG1436), solder mini-wires across pads (adjacent) connecting CLK1
        (which is the one we are using now, it looks like... 0, 1 what's the difference)
    Got IC35 off, took several of the pads with it...
    Fortunately SCLK0/1 both have vias.  As does CLK1A.  Destruction is now accepted.
    IC36: Cleaner job the 2nd time around...
    Now we're ready to wirewrap.
        FROM: CLK1A via connected to top copper T-junction, corner of IC10
        TO: SCLK0 and SCLK1 vias - under what was IC35
        
After clock hacking mod
    Trying DAC8 in slot 1
    DC offsets about same as before
    SPI read/write fails - try reprogramming FPGA.  That fixed it.  (Bitfile stored in flash didn't support 16 bit SPI addr)
    Now we have analog out.... for a second at a time, it looks like.
    On the plus side, it looks like we can lock to MCLK as the PLL source (or LRCK)
    Audio cutting in/out might be more frequent when using LRCK?  Suggests bad connection on I2S or something.  
    More EMI floating around with faster clock edges?
    Glitches still happen after removing debug wires
    Try slot 0? -> SPI doesn't work.  Weird.
    This is slightly sad.  Try DAC2 in same slot.
        Output looks reliable, but lots of noise/HD - 2-3% at -20 dB.  Worse as ampl increases.  (But ampl is correct.)
        Probably offset related.
    Try DAC2 in slot 0
        SPI is broken.  Analog output is the same.
        -> So, it's time to fix the offset issue.
    Try both: DAC2 in slot 0, DAC8 in slot 1
        Either one works, to the same degree it worked before.
        DAC8 continuity?  Looks good.  Maybe it suppressed clock ringing or something to have them both plugged in?
        
Time to figure out what happened to DAC2 I/V (for now removed DAC8)
    Try removing antialiasing cap?  Just for giggle.  (One channel)
    Removed caps from board SN 2, and now offset is 0.21 V.  Huh?
    Check distortion..  Yeah, noise floor and distortion are lower in the right channel, which is the one I removed the cap from.
    But they are still not great (not what they were originally, in measurements.txt).  Figure out, what is going on?
    Now removed caps from SN 1.  Boom, 0.01% THD in both channels.
    Definitely a major screw-up going on with those caps.
    Try alternate mounting, one channel/polarity only?
    Tried on SN 2 (right), neater soldering under the board.  Now all kinds of shit shows up in the RTA.  0.6% distortion and some sidebands.
    Parasitics?  Offset is also back up.
    May have to do with supply somehow, but I'm not going to bother finding out.
    -> Giving up on antialias caps.  May need to leave them off 2nd version also, and use 2nd order antialias filter only.  If problem continued
    Well, what about putting them on the M1 gate?  Would that be better?
        Less offset, but still worse distortion - 0.22%
        Is it related to the kind of cap?
        Tried 1 nF polyprop cap instead.  Now we have 0.04%.  Still not right.  Backing out.
        
Installed Jung regs in all slots - seems fine
DAC2 only setup back in stereo
Listening impressions:
    Clean.  Midrange is relaxed as it should be.  Maybe a little hard (nasal?) on Eva Cassidy's voice.
    But I haven't listened in a while, and might be sick.  Ears need to warm up.
    Treble balance seems slightly off, but it's not grainy like I remember.  (Regulators?)
    Dynamics are at least making an effort.

Need to buy stuff.
    DONE PCBs (Oshpark for I/Vs-$42, ITEAD for scalers-$20)
        Except ITEAD is verifying the Gerbers for the scaler.
    DONE Parts
    DONE Tweezers
    DONE Hot air station
    DONE Raspberry Pi


2/14/2017
---------

Listening notes: 
    Alabama
        Voice sounds a little funky when loud and not in the sweet spot.  Not too familiar with the record, maybe this is baffle effects from the speaker?  Also studio processing.
        Bass sounds surprisingly lively and clean.  Again, unfamiliar record.
    Tom Harrell (trumpet jazz)
        Not grainy anymore (due to regulators, or clock changes?).  Still pretty chill, highs a little recessed.
        There is just a little edge missing, like the band is playing from within a cloud.
        The "air" is cool, like a more "analog" sound but it sounds a little fake.

Next up: Raspberry Pi music server setup for DAC2 and some software cleanup.

2/16/2017
---------
DAC doesn't work, suspecting clock issue.

2/17/2017
----------
Turns out the 5V LDO reg (which BTW has 21 V in) was putting out 1 V.  
Temporarily, replaced it with a 7805.  Listening impressions:
    Tone is more neutral, it seems.  Highs missing the fake air.  A little crisper.  
    Dynamics not impressive (but only listened to a couple of tracks).
    Overall pretty clean.  Maybe the 5 V reg was causing problems and it's got potential to be better?

Will have to debug the reg eventually.
Anyway, more important things to do: Raspberry Pi is here

2/18/2017
---------
Raspberry Pi is running (password = strawberry)
Running Python in a virtualenv might be a bad move

Got streaming working, controlled by MPDroid.  
    ALSA PCM file output piping to Python script
    Rearranged Python scripts to be more organized (SVN r116)
    
This is fun to use.  Problems:
1. Albums don't appear.  MPD thinks the only album is a Nine Days album that was MP3 instead of WAV.
    Hypothesis was that the tag parsing (ID3 format) was only being done on MP3 files.
    But WAV can contain ID3, and Windows Explorer seems to think the WAV files are properly annotated.
    -> Can try converting an album to MP3 and see if it gets picked up.
    Tried compiling latest version of MPD.  No change.
2. No volume control from the app
    Is this a client limitation or an MPD limitation?
    Long term, may need to write a separate app for controlling the configuration, volume, filters etc.

Sound seems same as before (hopefully)
    Hypothesis:
    - Using 78xx regs for +/- 15 V supply was causing grainy sound due to bad I/V PSRR
    - Bad 5V discrete reg was causing "fake air" on treble (but should probably listen to Tom Harrell again)
    - Any difference caused by clock risetime?

Need to think about the next steps, given hardware debug situation on the original DAC/ADC boards and isolator (and reg...).

2/19/2017
----------
Order of operations after thinking about planning:
1.  Try ADC boards and debugging other issues (SPI, 5 V reg) with current setup
2.  Assemble and test new DAC output boards
3.  Figure out Netflix streaming and other practical needs (i.e. someone's phone)
4.  Try digital crossover - work on speakers library

General goal: Get as far as you can with current platform, and do some extra SW/integration work for:
a) Risk reduction
b) So it's fun to use while working on next HW platform

Also consider working on measurement tools, e.g. noise amp to examine supplies/outputs.  Would help understand where problems are.

2/20/2017
---------
Listening notes: The Jayhawks
    Clean, balanced, easy to follow the counterpoint
    Highs may be a bit "crisper" than I'm used to, but not fatiguing at the low levels I listened at.
The Wallflowers
    Laid back at 80 dB.
    Didn't notice the same crispiness, but treble is generally softer on this album.
    Compressed.  Firm sound, though.  I think this is making the best of the record.
Eva Cassidy
    Amazing as always.  Hard to say anything about the sound.
Beethoven piano concerto
    Piano more engaging than I remember it.  Maybe this is just a lower noise floor (or masking?)
    Soundstage a bit unbalanced on this track (violins all seem to come from one place?)
    Acceptable microdynamics.  Overall dry sound which you'd expect from the speakers.
    
Overall, it was a very good evening.
Good time to take it down for ADC testing.

2/21/2017
----------
ADC debugging

Notes
    ACON should be 0x59 but I think I knew that already.
    Python script: runs fine, doesn't receive any audio
    Once I got a USB overflow error suggesting there was audio (intermittent if any, can't reproduce)?
    Probing nodes: 
        RST is high (good, it's active low)
        LRCK is high, BCK is low, SDATA is low
        This would seem to indicate lack of lock
    OK, the problem is that the 5 V rail is low.  Why?
        Overcurrent protection.  Why?
        Because the CM level of the input buffer is wrong.
        -2.5 V is dragging the op amp output negative, turning on the ESD clamps in the ADC.
        So the op amps are getting hot and the ADC is getting hot.
        Fixed, sort of.  Won't really be fixed until a PCB revision gives a proper input buffer.
    Now I can record samples.  But the frequency looks wrong.
    Stim freq = 1k Hz
    Recorded period = 15 samples?  Should be 44.1.. (using 500 Hz gives period = 30, same issue)
    What I do with ACON seems to not matter.  100 Hz, period = 146.8 indicating Fs = 14.68 kHz (44.1 kHz / 3)
    This would indicate that the chip is operating with the assumption of 768 Fs.
    -> Next time, check ACON for real.  (PCB probe)

2/24/2017
---------
It looks like you can only control ACON if you are in slot 0 or 2 (see slot_controller.v)
So, moved to slot 0.  Now what?
    No trouble reading samples, but they're all 0.
    Wait, now ACON has an effect.
        Default of 0x51 or no setting -> -20 dB RMS, jibberish data (wrong format?)
        Set to 0x59 -> all zeros
    Why don't we use the Logicport...
        Bad connection on I2S? Looks like I2S with noisy LRCK/BCK and zero data.
        Reseated, now LRCK/BCK look better,  but data is all zeros. (Regardless of ACON)
        
2/25/2017
---------
Investigating FPGA pinout as potential cause of ACON issue
    Spreadsheet says ACON0 is ZTEX pin D26 (FPGA P2) and ACON1 is D25 (R2)
    ACON0 -> FACON1 net on PCB
    ACON1 -> FACON2 net on PCB
    ACON0 serialized version looks fine... 0x59 at the moment.  Now probe deserialized nets?
    DC level of serialized net post-isolator is 1.65 V when 0x59... 1.24 V when 0x51. Probably working.
    It goes to pin 7 of slot 0 connector (HWCON) then into IC3 on ADC board.  I guess we have to probe that.
        It's a 74164 shift reg (clocked by MCLK) tied to a 74574 reg (clocked by SRCLK)
        DC probes on ADC board: MCLK = 1.68 V, SRCLK = 3.11 V, looking good.. ACON0 = 1.24 V, meaning things are probably connected to it
        What about ACONs going into ADC?  Have to probe across the upper pins of IC2...
        Far to near...         0001010
        With ACON set to 0xFF: 0101011 
        Let's reflow the connections on those registers...
        Now with ACON0 at 0xFF: 0011101
    Maybe there is something wrong with the ADC? I did abuse it.
        SDATA DC = 0.42 V... Logicport?  Shows 1 bit high for each of L/R, maybe the 8th bit?
        Try different ACONs...  First experiment with format.
        0xFF - 1 bit high in 8th cycle; FMT = 11 = DSD
        0xFE - 1 bit high in 8th cycle; FMT = 10 = PCM standard
        0xFD - all zeros, FMT = 01 = I2S
        0xFC - some kind of data (reasonable noise like stuff)... FMT = 00 = left-justified
    Plug in a sinewave and see.
    Small sinewave with noise on it... period = 874 cycles at 100 Hz, indicating 88.2k sample rate.
    Try changing upper bits of ACON?
        Good thing bit 2 (M/S) was stuck low?.
        0xF8 =  - looks like left justified at 88.2k  1 1 111 0 00
        0xD8 = 1 1 011 0 00.  Now LRCK is very glitchy.  (But maybe 44.1k?)
        0xE8 = 1 1 101 0 00.  Same - very glitchy.
        0xC8 = 1 1 001 0 00.  Glitchy and slower.
    Try changing HPFD? 0x38 same as F8.  
    Maybe it's still having trouble with the clock input.
        At 0x60 I get clean I2S at 29.4 kHz... 0x70, 58.8 kHz
        With everything at 0, cycle through OSR options (bits [5:3]) to see which are clean and which are glitchy.
        000 -> 0x00, clean 14.7k (single rate 768fs)
        001 -> 0x08, glitchy (single rate 512fs)
        010 -> 0x10, glitchy (single rate 384fs)
        011 -> 0x18, glitchy (single rate 256fs)
        100 -> 0x20, clean 29.4k (dual rate 384fs)
        101 -> 0x28, glitchy (dual rate 256fs)
        110 -> 0x30, clean 58.8k (quad rate 192fs)
        111 -> 0x38, clean 88.2k (quad rate 128fs)
    Trying slot 1 to see if clocking or I2S makes any difference.  
    Slot 0 DIR pin is grounded.  ACON controlled via slot 0.
        000 -> 0x00, clean 14.7k (single rate 768fs)
        001 -> 0x08, glitchy (single rate 512fs)
        010 -> 0x10, glitchy (single rate 384fs)
        011 -> 0x18, glitchy (single rate 256fs)
        100 -> 0x20, clean 29.4k (dual rate 384fs)
        101 -> 0x28, glitchy (dual rate 256fs)
        110 -> 0x30, clean 58.8k (quad rate 192fs)
        111 -> 0x38, clean 88.2k (quad rate 128fs)
    Now, can we get I2S to work?  Add 01 to end...
        Logicport looks plausibly I2Sey.

Wait: Datasheet says "The PCM1804 needs RST = low when logic levels on the OSR2, OSR1, and OSR0 pins are changed."
    Likewise for the other config pins.
    So, let's implement this... now have ENTER_RESET (0x4B) and LEAVE_RESET (0x4C) commands.
    Reset functionality works.  But I2S output is still glitchy in the clock modes we care about.
    CLK0 reaching FPGA is stable 11.28953 MHz

Options..
    Look at clock signal reaching ADC pin?  (Then can decide to adjust clock dist)
        Before that, try adding 18pf cap on CLK line.  Doesn't seem to have an effect either on working or nonworking mode.
    ACON0 pins could be flaky... I did get some anomalous readings with the multimeter, but it's hard to tell if I'm probing accurately.
        Adding solder paste and reflowing digital ICs, ADCs and connector didn't help.
    ADC could be bad (heat damaged?)
        Have another one.  Try the SMT heat gun tomorrow, I guess.
        May want to retry current one- maybe some solder underneath chip (it's not flat on the board)

2/26/2017
---------
Tried more hardware debugging around ACON:
    Replaced ADC.  No difference.
    Replaced registers.  Now can't get anything besides all zeros for ACON (i.e. 14.7kHz).
    Check pinouts: LVTH574.. bad OE?  No... but maybe bad VCC.  Add a wire connection in case PCB pad is lifted.
        Fixing that didn't affect behavior.  ADC acts like its control pins are low.
        But it's worth checking the other connections around those chips.
        SRCLK to reg: OK
        data, clock to shift reg: data is OK, clock is OK
        CLR is high
 
Are there other places I use this deserializer circuit, and do they work?
    Pattern is SRCLK falls for half a cycle during positive phase of MCLK
    Yes: clock selects, and ADC/DAC chip select for SPI
    Have had some SPI problems...
    Since clock select mux is removed... can experiment with that.
        Setting CLKSEL to 0x03 (0011) shows:
            CLKSEL3 = 0.05 V
            CLKSEL2 = 2.41 V (0.72x)
            CLKSEL1 = 3.32 V
            CLKSEL0 = 2.07 V (0.62x)
        Hmmmm...
            CLKSEL = 0x01: 0, 0, 2.24, 1.94
            CLKSEL = 0x02: 0, 2.57, 3.32, 0
        Looks like a timing violation to me... or a misunderstanding of how the shift reg is supposed to work.
        Output (574) is a DFF positive edge triggered.

Much debugging (2+ hr) later...
Looks like there were 2 problems
    1) Bad timing going into shift reg. due to launch on rising clock edge
    2) Bad connectivity on PCB between shift reg and DFF
Now, I can get good data at 44.1k.  There might be a bit shift though.
How's the performance?
    Datasheet says to expect around -102 dB THD+N.
    I see a lot of power supply crap.  Also other odd spurs (can't tell if they're from the soundcard or not).
    And the harmonics are around -90 dB (HD2/3 each around -93 dB).

OK, let's bring the DAC back.
    Had to modify RTL to allow slot 1 to set ACON0
    Reason: for mechanical clearance of PCBs (I/V stages), DAC must be in slot 0 and ADC in slot 1.
    Now there's a problem: ADC output is intermittent when both it and DAC are plugged in.
    Presumed reason: bad connection
        But try it the other way round, anyway.
        DAC appears to work.  But ADC doesn't come up and do anything with its I2S port.
        Scope?  Clock is OK.
        A5V is at 1.69 V... (isolator board has 5.01)
        Bad connection.  Reflowed slot connector pin, seems OK.  
        But there are still a bunch of other bad connections on the ADC board, relating to ACON at least.
        -> Retire this board.  The concept was proven, the execution was bad.

Time to look at the new I/V
    Doesn't blow anything up.  
    Follow up.
        Supplies: -15.42 +15.45
        Offset (mV): IIN- 25 IIN+ -163 VOUT- -108 VOUT+ -80
        Bias: voltages across (pos half)
            (pos rail) R26=15.45/13.90 (1.55)  R27=15.45/14.09 (1.35) R28=14.49/0.35 R14=14.1 
            (neg rail) R23=-9.85 R22=-9.85 R15=-14.1 R17=-14.1
        LTSpice expected for R22/23 was -11.4
        Others are reasonable.  1.3 V drop across res is... possibly heating up bias?
            Vpb = +13.65, Vnb = -13.64 (1.8 V drop on LED)
            LTspice expects 1.7 V across the LED and 1.03 V across the resistors.  I have 1.8 and 1.35 or so. (+30%)
                -> BC817 have lower Vbe than expected.  OK.
            LTspice expects 6 V (13.5 - 10 mA * 750 ohm) at IVOut.  I have 0.35 V (14.5 - 19 mA * 750 ohm).
        Now instead of 16.5 mA in 62 ohm and 10.3 mA in 100 ohm, I have 21.7 and 13.5.
        220 ohm resistors show Wilson mirror current is 25 mA instead of expected 16.5.
            -> Mirror appears to be working.  But R26 has too much current due 1.55 V drop instead of 1.03.
            Replace with 100 ohm?  That would bring current to 15.5 mA.

    Given drop on R26 (1.55 V), R27 (1.35 V), to get 16.5 mA and 10.3 mA, I need 94 ohm and 131 ohm.
    But I only have 100 ohm, 200 ohm, and higher values. Paralleling?
    First investigate other half:
        R46: 15.45 - 13.95 = 1.50
        R47: 15.45 - 14.08 = 1.37
    All LEDs are around 1.8
    Let's try:
        R26 -> 100 ohm (15.5/15 mA mA)
        R27 -> 162 ohm (8.3/8.5 mA)
        Difference of currents = 7.2/6.5 mA
        Meaning: upper half will sink 1 mA too little, dragging output up by 0.75 V.
        But that's better than what we're doing now, which is sinking 9 mA too much and collapsing the output entirely.

Maybe I need to switch from green to red LEDs?  Red may have smaller voltage drop.
Nope, trying 100/162 ohm.  Seems to fix the most egregious issue.  IVOut is now 7.88 V which is OK I guess (target was 6).
    Note: fix on negative half also.  But should be able to test THD as is.  (Nope... then cap multiplier won't work.)
    
Performance: Some quick measurements
    Looks like -95 dB or so at full scale.  -100 dB at -14 dB and lower.  Mostly 2nd harmonic.  Some 3rd.
        Note: Sound card loopback shows the floor is around -106
    Almost what I was hoping for.  Investigate more later?  Maybe.   Want to listen first.
    Worse at higher/lower frequencies - could be isolation transformer, could be something else
    
Listening notes: Purple I/V boards
    Tonally, back closer to what I remember from the CD player.  But not quite.
    Bass was loose at first (amp warming up?) and treble a little hard/opaque e.g. "I Feel Lucky"
    Still laid back, but not as much as previous version.  Especially in the mids
        Guns and Roses still sounds squashed, with a piercing guitar, but more tolerable than I remember
        Toy Matinee is relaxed except for the one part towards the end of "Last Plane Out"
        Wallflowers is relaxed
    Highs a little sharper/shimmery.
        Eva Cassidy tracks more alive
    Surprising ass kicking capability.
    Piano leaps out from the darkness (spent a while listening to quiet Schubert)
        Classical may be as engaging as previous version, will have to listen more
-> Seems more neutral, but its possible something has been lost since the last version.
    Will have to listen more.

2/27/2017
----------
Some more listening, didn't pay close attention.  Sounded fine.

Soldered op amp IV board.  Not tested yet.


3/2/2017
--------
Did a quick comparison of "old" and "new" discrete IV stages while friends were over.
    Jenny Scheinman, relatively quiet
    Old was definitely softer IMO.  Mike thought this was a negative, but I thought it was a positive.
    Should investigate more carefully on the bench and experiment with discrete IV.   
        Cap related distortion?
        DAC loading difference with 3.3n IV conversion bypass?

Tried opamp IV.
    Turned on, was quiet for a few seconds and made some nasty sounds.  (No damage apparent.)
    Appears to be oscillating.  Fixed some solder joints, didn't help.
    Need to try with fewer caps.  Might just need more careful layout.

Next up:
    a) DSD1792 I/V comparison experiments
    b) AD1934 prep/testing - prepare digital crossover using speakers library
        (want to be ready to try it out when the XLR connectors arrive)

3/3/2017
--------
A little more listening to V2 discrete I/V.
    Seems to be growing on me.
    Amazing treble (realism? maybe) on Stanley Clarke Trio
    Everything seems in balance, even at a higher volume level.
    Not relaxed, but not fatigued either.
    May be more transparent in the mids.  Bass could be a little light?  Hard to tell.
    Is it breaking in, or are my ears breaking in?
    Should probably listen more when people aren't around.
    
Another try for opamp I/V.
    Current FB op amps don't like caps in the feedback network.
    Removed 3.3n lowpass caps.
    Changed 4.7n to 3.3n in LPF to keep response reasonably flat.
    Result: Distortion
    The circuit is really sensitive to stray capacitance.
    -> Next thing to try will be fiddling with power supply bypassing - remove (short) ferrite bead L52?  
    But do this next time you have the platform on the bench.

3/4/2017
--------
Plan: 
    a) Test 8-ch DAC and try speakers lib (so we're ready for XLRs)
    b) Explore variants on discrete IV stage in more detail (caps as distortion source?)
    c) Try 8-ch ADC again.  Loopback would be great.
    
Discrete IV stage comes first
Captured spectrums at 1k and 5k.  
    Some extra spurs at HF, would like to see them gone.  
    Also want higher order HD gone.
    Left and right are similar.
Also found that turning on soldering iron makes the noise floor go up.
Also found that LF distortion (-60 dB at 50 Hz full scale) was mostly caused by isolation transformer.  
    About -86 dB without isolation transformer.  Decent, but maybe should be improved?

1. Right channel was a little less linear.  So, mess with it.  Then we can compare with untouched left channel.
    a) try removing 3.3n filter cap - C14/C34
        THD up to 0.004 (vs. 0.0013 orig.)
        All harmonics are higher it looks like
        When I put the caps back, I get .002 THD.
        Good to know.
    b) Try adding cap at input.
        I have some 4.7n caps... but larger polyprop ones may be better.
        Trying 10n ... DAC is not happy.  Undo.
        Still broken after undo?  Maybe I broke something independent of this.
        Yep. shorted something coming out of FPGA.  Try again.
        OK, the distortion is 0.01%. 2nd and 3rd got worse.
        When I go down to 1.5 nF, distortion is .0027%.  So the caps hurt.
    c) Try 5V discrete reg instead of 7805
        No change in distortion, but it might be worth listening to.
    d) Compare to V1 I/V stage.
        At -20 dB, it has no 3rd order and almost invisible 5th order.  But other harmonics are higher (0.04 total).
            10th, 14th, 16th, 18th are surprisingly high.
            Also higher noise floor (bad PSRR?)
            Actually with 1k full scale tone, 8.3k is there (-128.1) and 10.3k (-129.5)
            Whereas with V2 they are -8.3k (-127.3) and 10.3k (-145.5)
        Also, doesn't appear to have anything that's not a harmonic. (But V2 doesn't either; see below.)
    BTW, at -20 dB, V2 has nothing above the noise floor.  -110 dB or better.
    e) Try removing filter caps from LPF. (C16/C17--on back)
        No change in spurs or linearity.  But more hash appears in top octave (10k-20k).
        Went back to original config.
        May also be a tone at 13.9?
    f) Try figuring out where 8.3k/10.3k spurs come from
        1.1k tone: shift to 8.2k and 10.4k
        1.5k tone: 7.8k, 10.8k
        ->  F1 = 9.3k - Fc
            F2 = 9.3k + Fc
        What is the significance of 9.3k?
        With 5k tone, I see spurs at 18.65k, 13.9k, 11.35k, 8.65k, and a little at 14.3k
        With no input, I see something at 13.9k
        Could this be the measuring setup?  Check loopback...
            -> Yes, 8.3k and 10.3k spurs visible in loopback
            as well as a lot of intermodulation with 100 Hz?  Weird.
    g) Account for baseline harmonics
        1k 0 dB: -5.9 dBFS
        HD2 -102.8
        HD3 -116.2
        HD4 -115.1
        HD5 -123.1
        HD6 -125.6
        HD7 -125.5
        HD8 -137.1
        HD9 -130.5
        HD10    -142.6
        HD11    -133.8
        HD13    -136.6
        HD15    -142.4
        2k 0 dB: -5.9 dBFS
        HD2 -101.0
        HD3 -115.4
        HD4 -120.5
        HD5 -128.7
        HD6 -126.5
        HD7 -130.6
        HD9 -131.9
    h) Measure bias in output stage and see how it matches spec. and/or affects performance
        R14 1.364 -> 1.3 mA
        R17 1.362 -> 1.3 mA
        R19 0.343 -> 23 mA
        R20 0.341 -> 23 mA
        Hmm, a little higher than I wanted.  Other channel?  Similar (0.33 V).
        Try cutting the current, see if it affects distortion?
        On right channel, pos.  R19/R20 -> 47 ohm
        After that change V drop down to 240 mV -> 5 mA, so I overshot.
            But there is no difference in the distortion spectrum.  Maybe a touch more 3rd harmonic?
    i) Try changing MOS buffer bias current
        R15 (475 ohm): 1.34 V -> 2.8 mA
        Hard to say if it wants more current, or less.
        Try more.  Then less. 200 ohm -> 6.7 mA, 1.5k -> 1.0 mA
            More: No big difference.  HD3/5 a little lower, HD4/6/7 a little higher?
            Less: No big difference.  HD2/3 a little higher, HD5/6 a little lower?
        Not a big difference either way.  Go back to the original.
    j) Try changing DC coupling cap
        I have a 1 uF MKP lying around somewhere
        2.2u tried.  No significant difference.
    Congratulations, you've optimized everything except the input current buffer.
    What to do there?
    k) Check DC at current input (mV)
        Left: 85.0 74.4
        Right: 91.8 70.7
        Reminder: DC sink current is... R22 3.24 V -> 14.6 mA
        Whereas source current is... R27 1.33 V -> 8.2 mA
        That means on one side of the current buf we have 8.2 mA, and on the other side there is 11.01/750 = 14.7???
            I thought the DAC has a DC output of 6.2 mA.
            Actually, I got 6.50 V (8.7 mA) while the DAC was playing.  So maybe it powers down.
        962 mV at base of Darlington. 73 mV at current input (right), 78 mV (left).
        Would DAC be happier if it was zero?  Can try changing current.
            Should put a little more current in the right side to move the offset up.  That comes from R26 (currently 100 ohm).
            Current is presently 14.6 mA.  Add a couple milliamps by putting 500-1k ohm in parallel? 
                Sure... 825 ohm.
                Now I have 57 mV at the base.  And at 0 dB, dist is .0019%
                So maybe a little better, but not much.
                In other words the DAC isn't extremely sensitive to DC at that node.
    l) Check AC and cap multiplier output
        Multimeter says 0 mV.  But who knows?
    How do I tell if the distortion is coming from output stage or not?
    If I could probe THD at an intermediate node...
    Try the input to the LPF/output buffer.
    From this point, distortion looks much worse. (0.016%)
    -> Give up.  Too hard to tell what's going on.
    
Random other idea: Maybe the difference between left and right is not the IV stage, but the DAC board?
    The traces to the right I/V are longer.
    -> IV PCB swap channels
    Yes.  That's it.  The difference between 0.0015 and 0.0020 distortion is from the DAC PCB layout.
    This means the DAC layout can probably be improved... 
        and it may be that some of the distortion I'm seeing is coming from the DAC.
        
Alright.  Enough tweaking on the V2 IV.  It's good.
Time to try DAC8 board.

Problem: can't talk to it over SPI, even with latest firmware.
    Probe SPI signals... C24, C27-29
    CS is possibly OK if it's being serialized right.
        (Look at SRCLK too.  D29)
    DMDI is undriven?
    Now we have massive stream of data coming back.  My guess is CS is messed up on the board side.
        According to multimeter, it's fluttering around and mostly low.
    DMDO is slave out of DAC.  It's going nuts.
    Do a quick FPGA ILA debug.  Hard to tell what's happening in there.
    Top level gets the request packet, SPI does something.
        SS counter counts out 24 cycles
        DMCS parallel data goes from F to D 1101 - good
        But serial data is unclear, and parallel "estimated" data that is used to mux the port and control MOSI output is stuck at F
        Bit counter is set to F , then decrements to E, but then doesn't go anywhere.
    Simulation doesn't have a problem...
        Adding dmcs_des nets to debug.  trying ILA again.
        data_int reg in deserializer looks like it should
        Q is E.  Why ?  what does the clock look like
    Hmm, I didn't have CLK0/1 in the constraints.  That was a problem.
    Now SPI and analog output works like a charm
    
Other problem: providing data in 8 channel form
    For some reason, 2 channel works well and 8 channel doesn't.
    Intermediate thing to try is 4 ch.  What happens is the output turns on and off.
    When I use MCLK as PLL input source, it works with 4 ch, still doesn't work with 8 ch... Odd.
    When I bypass PLL... doesn't work.
    Anyway, this is odd. Maybe simultaneous switching is impacting MCLK/LRCK integrity when all 8 channels have same data.
    For now, use "fake 2 ch" mode.
    At 1 kHz, 0 dB: 0.004% THD (-88 dB), mostly 3rd harmonic (2nd, 4th, 5th all around -104)
    Reasonably low noise, maybe 6 dB higher than the DAC2 with discrete IV
    THD improves to .001 at -10 dB, .0008 at -20 dB (good...)
    THD is 0.004 at 2k, 4k, 6k... good
    THD is about the same across all 4 populated channels.
    DC offsets are small (1-10 mV)
    So now the challenge is identifying channels.
    OK, try to play 1.1/1.2/1.3/1.4 kHz in the 4 channels.
    Seems to work.  Lots of low level IM products in the output make the THD+N more like 0.01% when THD is 0.004%.
        Just as the datasheet says.

-> So, should try listening to it for a bit, with 2 channels hooked up.  This will help debug things on the Raspberry Pi.
    This works, will listen more tonight

Planning ahead, to digital crossover...
    How to get the transfer function of the analog active crossover?
    Inspect the components in there now.
    Notes copied down:
        Tweeter
            Near IC140 - 2.2n + 420 ohm
            S140: 6.8n 22.1 1u 670
            S160: 6.8n 174 4.7u 2.64k (R160 = 1.49k)
            S190: 10n 10n 26.5k 5.57k
            S181: 6.8n short 200 10k
        Woofer
            S110 0.1u 0.1u 27.1k 10k (bypassed HPF?)
            S131 16.1k 10k 6.8n 15n
            S130 6.75k 10k 6.8n 10n
            S150 6.8n 24.1k 1u 100k (R=47.5k)
            S170 10k 21.9k 22n 10k
    Made an LTspice model that looks plausible.  analog_xover.asc
        The only part missing is knowledge of the gain for each driver/channel.
        (Potentiometer settings)

Tomorrow: Load these filters into speakers library.  Test each filter going through analog crossover so I can listen to the FR.
    And then work out some scheme using the analog crossover as volume control?
    That's the main problem: how to protect amplifier and ears from issues on the tweeter output.

3/5/2017
--------
Some listening to AD1934
    Competent.  Reasonably clear and relaxed.
    Nothing jumps out at me.  But I haven't listened too loud or carefully.

Constructing filters
    Exported freq responses from LTspice.  Modeled in Ipython notebook.
    Mid tracks exactly with no changes.
    Tweeter needed some tweaking to get magnitude to track, and phase doesn't track.
        About 30 deg off at the crossover point[!]
    Needs an allpass, but there is probably an issue with the impulse response time scale.
    Will probably need to delay mid to get good tracking.
    
Trying out filters
    Main problem is how to get sound into/out of the filter library.
    Mike's code interfaces directly to audio devices in C.
    So I can make a device for C to talk to, or I can write a different interface
    Or, I can just do everything in Python (using code I already have?), hope that it's fast enough, and ask Mike for integration help.  Or do the integration myself, but later.
    What about creating fake Alsa devices to use with the existing libfilter scheme?
    That should work... my write_to_file device shows up in the list of "python -m sounddevice"
        Need to create an input device.  And in my first write_to_file
        Then create a 2nd output device that handles the multichannel stream

Implementation notes: ALSA config for runspeakers with fake devices
    It seems there is no way to get loopback without using the "loopback device" which is a loadable kernel module snd-aloop
    But this device seems to only support 48k sample rate?
    It's loopback... who cares what the sample rate is
    This is a kernel limitation?
        https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/sound/drivers/aloop.c
    For now, try converting to 48 and back.
    Whoops, Frank is asleep in the living room.  Not a good time to make a bunch of static.
    How to test without actually making noise?
        Direct output to a raw file.
        Send input from a wav file.
    Got it.  Output looks... to have wrong endianness.  Or to be a botched floating point conversion.
    PA_SAMPLE_TYPE in runspeakers is paFloat32.  What does that mean?
        ALSA may be doing a conversion for us... or it may not.
        Need to generate a ramp and display samples received by C code.
        They are floating point in the range of -1 to +1... good, I guess.
    But I have to tell ALSA to reformat the data going back to the file?
    
FIR digital filters - works
    Safety precautions:
        Used -30 dB volume setting in DAC SPI registers
        Used 22 ohm resistors (initially) in line with tweeters
        Wore earplugs (initially)
        Made Python play_stream script error out if the input format was wrong
        Measured DC+AC voltages on amplifier outputs before hooking up speakers
    Practical notes:
        Had to set up softvol PCM device in ALSA to create volume control.  Eventually it worked.
        No hum, but noticeable hiss (and some buzz) in tweeters.  
            Can barely hear from listening position, can clearly hear with ear up to speaker.
            As expected.
        Had to do a lot of ALSA magic with loopback.
            Currently forced to use sample rate conversion to 48k and back - will need a better solution.
    Listening notes:
        Only a little listening, just to prove the concept.
        Sounds clean.  Detail not impressive.
        Mids not the same since phase didn't match up to analog xover transfer function (~30 deg off).
        
What's next?
    Try the 8 ch DAC (and maybe 2 ch again?) and then it's time to start the next rev.

3/6/2017
--------

Looked into some clock distribution options
    SN74CB3Q3257 seems like the right set of muxes to replace ADG1436
    DS90LV011A single LVDS driver, output is 350 mV diff with 0.5 ns risetime (maybe it should be faster?)
    ADN4661 does the same thing... 360 ps risetime it looks like (15 pF load)
    ADCLK925 has 2 PECL outputs with 60 ps risetime and 60 fs jitter
    PECL and CML are the same thing?

    Si53340 has 50 fs jitter, 4 outputs, shared 2:1 input mux
        That would be good if clocks didn't have to be independently selectable

    DS08MB200 has a 2:1 mux 
    Also check out SN74CB3T3125 and CD4066B

So maybe the first question is whether to use LVDS or CML
    LVDS: easier, lower power, cheaper... slower
        Apparently LVDS input can receive anything including CML: http://www.ti.com/lit/ml/snla187/snla187.pdf page 35
    CML... opposite
        But could use any old mux, since they're just like SPDT switches?
            e.g. switch the fanout buffer output between real load and dummy load

And the second question is whether to support independent clock for different modules
    i.e. some modules playing/recording at 44.1 while others are at 48/96/192
    Supporting that is a [big?] hassle
    
3/11/2017
---------
Clock distribution planning


Rev 2 platform planning
    Chassis: Plan to use Hifi2000 Slimline 2U with 3 mm Al covers (280 mm depth)
        $119 shipped from DIYaudio store
        Also keep in mind a cheaper option, the Pesante 2U... $64, but 1 mm steel panels
    Floorplan: PCBs are as follows
    -   RPi/FPGA holder
    -   PSU
    -   Clock board (4 layer?)
    -   Isolator (4 layer)


3/12/2017
---------
Some listening notes from the last few days (DAC2 with IV v2)
    I feel like the v1 IV had a fog of sweetness about it, and the v2 has a light mist of fatigue
    But maybe this is mostly a tonal thing; the top octave is a bit "etched"
        -> AA filter difference?  Should just measure the frequency response.
    It handles compressed music well, effortless
    Other harebrained idea: maybe a diff to SE converter is needed and the distortion products will cancel?
        The v1 IV stage could have been masking them with noise and/or 2nd order
    Need to do more serious (somewhat loud) listening to get a better handle on this.  It's... hard to get a handle on.
    
Cranking up on v2.  PCB design todo list:
    Spec out all the interfaces and mechanicals (working on that today)
        May as well make the footprints in EAGLE after sketching
        Did iso-mod connector... iso-clk connector...
        
    
    Order more transformers - screw to plywood for now (though a chassis is attractive)
    Design PSU board
    Design clock board
    Design v1-v2 module adapter board
    Design carrier board
    Design main isolator board

Notes on mechanicals/interfaces
    Flip the RPi upside down, that will prevent me from having to remove/replace the header, yet still
    Plan to use standoffs with #4 screws, in general.
        Some places will not allow that.  Example: Rpi probably needs #2 screws.
    Ribbon cables are cool, but what about interlocking boards via edge connectors?
        e.g. S5534-ND, 8.5 mm long female 2x20 for $2.80
        0.1" headers will allow either edge to edge connectors (right angle), or ribbon cables (vertical)
            ... maybe.  Check cable geometry.
        This might make sense for the carrier-isolator connection 
            just because the only reason it's there is to avoid an L-shaped PCB
        PSU can be ribbon cable.
        Clock board... 
    -> Proposal: Iso board goes on bottom.  Clk board, carrier and DA modules piggyback on top of it.
        Boards cannot be horizontally mated with RA connectors at same height; one would be top, one bottom to get pin matching.
        There will probably be a way to get ribbon cables to work also.
        So, get pinouts to match from top.
    Will reflections from 0.1" connectors be a problem for clocks?
        FR4 dielectric constant is 4.2, so (according to Mentor Graphics) the motion is about c/2 = 165 ps/inch
        The overall length of the line is going to be about 12" (maybe a little more?) -> 2 ns one-way
        If the risetime is 100 ps... we have some potential problems.
        But these boards aren't going to be controlled dielectric anyway.
            Estimate... 10 mil of prepreg between top/bot and inner layer (there is a thicker core between the inner layers, like 40 mil)
            It actually depends a lot on the dielectric thickness.  
                With 7 mil prepreg, 8 mil trace at 6 mil space is close to 100 ohm
                It looks like the width and separation needs to be similar to the dielectric thickness to get 100 ohm
                Increading space rel. to width gives higher imp.
                Apparently Oshpark has 6.7mil.
            9 mil wide, 7 mil space: impedance as a function of prepreg thickness
                7mil -> 95 ohm; 9mil -> 104 ohm; 11mil -> 110 ohm
                So that should be fine.

    Random note: For Rpi/FPGA carrier geom.
        Rpi HDMI should be along the back.  Then use the following cables to bring connections out from the other edge.
            https://www.adafruit.com/products/909 - Ethernet
            https://www.adafruit.com/products/908 - USB (note: 907 is the B version for USBStreamer)
            https://www.adafruit.com/products/978 - HDMI
        Power should all come from within
        Make sure there is easy access to JTAG port on FPGA board - either solder to card edge or put on carrier.
        
Queued up for tomorrow
    Finish specing out interfaces and put them in EAGLE: iso-carrier, iso-PSU
    * Add drill pads and outline to the iso-clk footprint

Queued up for after that
    Make more detailed mechanical drawings and review

Risks
    Clock distribution
    Layout complexity / grounding / isolation
    2-level ser/des -> should just simulate it, along side the current one
    
3/19/2017
------------
Realization: should have a separate transformer (+ buck converters?) for 5 V (RPi, FPGA) and 3.3 V ("dirty" isolator supply)
    to minimize capacitive coupling with the audio supplies; otherwise, would have interwinding capacitance
    -> separate power board as well?  Can be same PCB, but maybe use separate connectors? 
    i.e. JST for reg. 5V to carriers and 3.3 V to isolator; std 0.1" header for the unregulated "clean" supplies
    Inadvertantly, I had this already: 12 pin header didn't include the dirty supply
    
Drew up the headers... next would be mechanical
    4-40 screw is tight fit .116" free fit .1285" - use .125 for PCB with 0.25" dia pad for screw head contact
    Carrier connector 24x2 has 2.9" between hole centers - min expected PCB width = 3.3"
    Clock board connector 16x2 has 2.1" between hole center - min expected PCB width = 2.5"
    Module connector 26x1x2 has 3.0" (V), 2.0" (H) between hole centers - PCB width = 2.375" space = 0.125"
    Chassis internally 80x415x280 mm = 3.15 x 16.34 x 11.0"
    Transformers:
        - F8-28 is 2.562" H x 4.031" W (tabs; 3.062" body only) x 2.25" D (excl connectors) with 2 holes spaced 3.562"
        - VPS10-4300 is 2.688" X x 3.125" W (tabs; 2.312" without) x 2" D (excl connectors) with 2 holes spaced 2.813"
    But I can probably get away with smaller ones. e.g. Rpi+FPGA should be <10 W, so should the rest (25 VA OK).
    And +/- 15 V... realistically, 1 A is fine. (50 VA)
        - VPS10-2500 is 2.312" H x 2.813" W (tabs; 2" without) x 1.938" D (excl connectors) with 2 holes spaced 2.375"
            Call the footprint 2.5 x 3
        - FD7-28 is 2.25" H x 3.687" W (tabs; 2.687" without) x 1.812" D (excl connectors) with 2 holes spaced 3.125"
            Call the footprint 2.5 x 4
        -> Goign with these for now
    Depth space in 280 mm chassis... with 5" isolator there's only 6" left
        RPi+FPGA width is ~4.2" so there needs to be 4.5" behind, 1.5" in front.
        Hopefully, can reduce the depth taken by isolator (from 5")
        This also reduces space available for clock board.
        -> Does this mean we need 350 mm depth instead? (Slimline comes in 280/350, Pesante in 300/400)
        Should probably do some PCB layout work to see...
        
    Width space: isolator should probably be 14" wide not 15"
        This leaves about 1.5" for PSU board
    
    PCB Overlap: looks like 0.4" is good
    That puts 0.15" from pin center to board edge, leaving some space for routing, and leaves clearance around mounting holes
    -> Clock board can be up to 3.75" x 1.9" if we have 1.5" clearance at front
    -> Carrier can be up to 3.75" x 4.9" if we have 1.5"
    Note: width should actually be a little smaller than 3.75" for clearance from optional shielding barrier
        Maybe 3.625" would be good.
    
    Where are the transformers going to go?  They aren't that narrow...
        ~2" D
        If the carrier board is narrower that would help.  (But it needs space for power connector and isolator connector.)
            And RPi is 3.3" long.
            -> Make carrier no wider than it needs to be to support RPi/FPGA.
            Power input connector can be at the front corner
        In fact, current plywood supply enclosure has the VPS10-2500 in it. (And F8-28, slightly larger than FD7-28)
            And it's 8" x 10" without seeing that empty.
            And I was planning to add another VPS10-2500.
        So, there is drastically too little space for the power transformers.
        What about placing the carrier on top of the isolator?
            Would lose RPi connector placement at the back.
            But Adafruit has that too.  (Added to link list above.)
            So, no problem.
            Just have to make sure that
                a) there is nothing tall on the isolator in that area
                b) there are other mounting holes for the carrier
                c) there is clearance for power supply connections to isolator at edge
                    (this would be why we should keep the carrier slightly narrower)
            What depth to expect for carrier board?  How about... 4.5", in other words, all of isolator
            -> 3.3" x 4.5"
        Just keep the connectors facing to the outside (and not the left).
            With RPi in the rear, upside down, HDMI faces rear, Ethernet/USB face right.  Connector in front/left.
                Be careful with flipped upside-down arrangement.
                Also, there are mounting holes.  Which we should use.
                    Hole dia = 2.75 mm pad dia = 6 mm -> #3-48, #3-56 or M2.5x0.45 (M2.5 recommended)
                Standoffs all the way down?  Or just local connection to carrier?  (With nuts?  Ugg.)
                    What about a standoff threaded at both ends?  Then use 2 short screws.
                    Need almost 2 cm  (3/4") spacing between carrier and RPi board to clear Ethernet connectors
                    AE10863-ND  should fit the bill..  Yay for Assmann.
                    Maybe instead of a "Pi-Hat" this is a "Pi-Shoe"
            FPGA... doesn't really matter.  Connectors nearly symmetrical, doesn't have mounting holes.
        Now the space for transformers (+ AC inlet, switch, fuseholder) is 6 x 4.5"
            That seems sufficient for 2 transformers but not 3.
            Any way to avoid sharing a transformer for the dirty supply?
                a) Ext connector on the back for a 5 V wallwart - simple, but not very elegant.  About $10.  
                    Connector like CP-039BH-ND
                    Can use existing supply I have for the FPGA probably
                    If ordering, consider Triad Magnetics WSU050-3000
                b) Small open-frame supply?  2.5 A SMPS on Digikey costs $21 and is 2.91 x 1.64"
        PSU board: 1.5" x 5" - assume aligned with isolator
    
    What about the alternate configs
        USBstreamer = 2.4" x 1.4" with USB connector at center of narrow edge
            Intended to be mounted to the same chassis surface as the USB connector with M3 screws.  No vertical mounting holes.
        Ministreamer = 2.3" x 1.4" with USB connector at center of narrow edge
            Same mounting as USBStreamer.
        Where to put them?
            a) if using RPi - want them internal
                Then there should be a short USB cable to the RPi.  And there should be a carrier option to hold it.
                But will have to deal with mounting (3D-print a piece that screws into alt carrier for mounting?)
                Deal with this later.  It doesn't seem hard to make an alt carrier that works.
            b) if not using RPi - no carrier, want them at the rear (but there's no space due to transformers)
                But could probably:
                - reconfigure transformer placement to make room, or
                - mount above the transformer? (sketchy), or
                - continue using alt carrier, just leave out the RPi and use a panel mount USB cable
        Connectors should be just below the main carrier connector - connecting to slot I2S signals
    
    Note on standoffs
        4-40 standoffs are available, about 40 cents each
        Will need approx. 28 - get a bag of 50 from Ebay
        Height should be determined by max. component on bottom of isolator board.
        But will need different heights - look at stacking height of headers for modules/clock/carrier
        
    
    I feel like this floorplanning will go badly without an actual chassis, connectors, transformers.
        Everything takes up more space than you think (e.g. connectors)
        But this is a good initial shot.
        

Also, switched back to V1 I/V for time being.
    Definitely more relaxed, but highs are slightly hashier.  Seems to have slightly less clean impact up and down the spectrum.
    Not sure whether I really prefer V1 or V2, maybe it depends on the speakers.
    Probable course of action is to tweak the speakers a bit once this is all said and done

Started writeup - see writeup.txt

Made up plan for v2 HW platform - see planning.txt
    But don't forget to try ADC boards again on v1
    And tweak DAC2, see if anything can be learned performance wise
    And work on software stuff, e.g. streaming from services or casting Netflix

3/25/2017
---------
Laid out PSU PCB.  Simple enough.

Started to design clocking.
    Analog Dialogue article very helpful.
    Mentioned ADCLK series has lower jitter than AD951x, which I had noticed but hadn't paid attention to
    ADCLK846 has a CMOS output, so that seems like the way to go for the module side
        Needs AC coupling on the CML input, which is not a big deal
        Needs 1.8 V (no higher) clock supply.  Problem there?  Yes...  That may be the reason to use AD9515 which is 3 V

3/26/2017
---------
Worked on clock PCB - footprints/schematics

Have the ECL/CML parts picked out.
LVDS part selection
    Receiver is easy: DS90LV012A. $1 in SOT23-5
    That's the one without on chip termination.  DS90LT012A has on chip 100 ohm resistor.
    -> Use DS90LV012A and put the resistors (and if necessary coupling caps) on the board.

    Transmitter: Hmm.
    SY89847UMG  576-1618-ND  is $5 each.  Looks actually like a cheaper version of the ADI parts, supporting LVPECL.
        But it doesn't have CMOS inputs?  Could probably tie neg. input to ground through a cap, like ADCLK948 datasheet suggests.
    LMK00105 has CMOS outputs. So that won't work.
    -> What about plain old LVDS transmitters and a CMOS mux?
    LVDS transmitter x4:  	FIN1031MTCXCT-ND $1.27
    LVDS transmitter x1:    FIN1001M5XCT-ND $0.85 - pin compatible with DS90LV011A
    CMOS mux: SN74AUP1T157DCKR 296-27393-1-ND $0.36
        OR  	296-14909-1-ND SN74LVC1G3157DCKR $0.36 - already has Eagle symbol in 74xx-little-us
    
    Low cost oscillator?
        EPSON specifies their phase noise... -145 at 1k, -158 at 100k, -161 floor (only 10 dB worse than CCHD-957?)
        SER3827-ND (22.5792) SER4123CT-ND (24.576)
    
    Supply regulator
        What's a good regulator?  3.3 V.
        Low cost?
            296-21112-1-ND  TLV1117-33CDCYR  $0.62
            Output noise is specced at 0.003% of VOUT from 10-100k which for 3.3 V would be 100 uV
            UA78M33 has typ 40 max 200 uV... better?
            296-13424-1-ND  $0.58  DCY pkg is SOT-223 (footprint in Eagle)
            
        High performance?
            ADM7154 ADM7154ARDZ-3.3-R7CT-ND SOIC-8 with exposed pad. $6.10.
            NSD at HF is 1.5 nV/rt Hz or 1.6 uV RMS from 10-100k
            LT3045 is 0.8 uV RMS.  About the same price.  Seems to have better low freq performance, not high freq?
        -> Go with the ADM7154. I think the HF NSD floor is more important in this application.  Oscillator/buffer PSRR is probably better at low freqs (or the difference will get swamped in the 1/f phase noise).


Power budgeting
    Oscillators: 50 mA
        TENT XOs: 10-20mA, call it 20, x2 = 40
        CCHD-957: 15-25 mA, call it 25, x2 = 50
        SG-210STF: 3 mA + loading.  Less than others.
    Clock drivers: 350 mA
        ADCLK948.  Pos supply current max = 330 mA. (Neg is 120 mA, probably due to termination)
        FIN1031 25 mA
    -> 400 mA is a good budget.

... Time for footprints/symbols
    ADCLK948 - done
    AD9515 - done
    FIN1031 - done
    FIN1001 - done
    SN74LVC1G3157DCKR - done
    Already had TENT XO.  Crystek CCHD-957 - done. SG-210STF - done
    ADM7154 - done

Let's hook this shit up.
    1) Regulators.
    2) Oscillators.
    3) LVDS.
        What's the termination/coupling?
        Need the 4 combinations of LVDS/CML to work properly.
        AD9515 says inputs should always be AC coupled.
        Is there a problem with having 2 caps in line when using CML on both ends?  Yes, I think so...
        TI app note suggests cap goes at the receiver side.  So 1 cap is fine.  Receive side only.
        
        200 ohm resistor from each output to ground on driver side.  Sets DC level to 0--3.2 V.
        Unused outputs: y-termination with 50 ohm resistor x 3

Let's lay this shit out.
    ADCLK948: Any way to route power ground and signals with a 2-layer board?
    You need ground in an adjacent plane basically everywhere
    But how to route power to the 4 corners of the chip?
    -> Silly shaped polygons.  The bottom is not going to be anything like a solid ground plane.
    
    How to route the isolator connector's power/ground and also the LVDS clock outputs?
    Again... 2 layer.
    This would be much easier in 4 layer.
    But don't you like a challenge?
    Hard to tell what the performance impact would be.
    
    How to route ground for the LVDS drivers?

Component numbering so you know what to stuff:
    1xx stuff always
    2xx stuff for high-perf only
    3xx stuff for low-cost only
    4xx for completely optional - don't populate by default
    

3/30/2017
---------
Need to think about clock testing setup.
    Include module adapter in this?
        That would require having some way to hook all the other signals up, in order to test a module.
        -> Not worth it.
    Just check that you can get a clock out of each of the 4 combinations of src/dest
    Have a LVDS receiver and LVPECL receiver and having 2-pin headers that have to be connected with wires.
    
    Any way to evaluate performance without special equipment?
    Can look at things on the scope through a battery powered LNA, if an SMA is placed on board
        Although the bandwidth limitation of the scope is an issue
    

Ferrite bead article from Analog Dialogue was helpful.
    Looking at 732-1623-1-ND bead: DCR = 0.1 ohm
    Rated current = 2 A. Only use to 20% (400 mA)
    Needs damping RC.  Probably.  Because it's still inductive up to 30 MHz or so.  L = 1.5 uH!
    For 1 dB of peaking, put 3 ohm in series with the 1 uF cap.  Gives 10 dB atten. at 1 MHz, 36 at 10M, 70 at 100M
    Output impedance has broad peak of 3 ohm from 200k-10M, before 10n cap takes over.
    Is that OK?  Or, keep 1u+10n and add 1 ohm + 10u.  Then peak is at 1 ohm at 100k.
    For clock, I don't think we care.  This is an oscillator so it won't draw anything below the osc. freq.
    -> Just put 3 ohm res. in series with 1u cap to prevent peaking
    (OVERRULED - SEE BELOW)
    
    a) Osc
    If DC current is 25 mA, what's the AC part?  Let's say it's charging/discharging 100 pF.
    So if we have 10 nF of local cap, it will lose 1% of its charge from a current impulse.
    
    b) ADCLK948
    DC current is expected to be 330 mA.  So, that will drop 33 mV or more.  Not sure what the AC content is.
    
    It looks like we want more "direct" cap, on the load side of each bead.  Though the beads are still necessary to prevent
        the regulator and/or other loads from seeing the load current.
    Charge/discharge 100p in the load-> 1u cap loses 0.01% of charge -> 0.33 mV
    Well, what's the power supply rejection of the oscillator?  Not specified.
    For all I know, they have internal decoupling. Let's swamp it out.
    -> Added 10u+1R in parallel with decoupling after each ferrite bead
    
3/31/2017
---------
Started schematic and LTspice model for clock test setup

4/1/2017
-----------
Working out LTSPice model for clock test
    What are RCLG params of transmission line?  
        Assume 9 mil trace, 7 mil space, 1.4 mil thickness, 10 mil height above plane.  
        (This gives about 107 ohm according to http://www.multek.se/engelska/engineering/pcb-structures-2/differential-microstrip-impedance-calculator-2)
        CircuitCalculator.com: 0.054 ohms per inch series R (single-ended); 108 mOhm/inch diff.
        Single microstrip: 1.94 pF/in from http://emclab.mst.edu/pcbtlc2/microstrip/ (implies 10 nH/in)
        Diff. microstrip will have twice that to ground, plus some coupling.
            -> L = 20n, C = 2p, R = 100m (gives 100 ohm nominal) - assumes 1p/in coupling
    Anyway, now why aren't the DC levels what I expected?
        Diff. input not symmetric and not 0-centered
        CM drive is constant at half-rail as desired
        Also, simulator also appears to give a non-physical growing oscillation, even with Gear solver
        I guess the lesson is to just try it and see what the real world behavior is.
        This is why you're doing a test board run.
        TI AC coupling guide page 4 shows LVPECL to LVDS connection
        ADI shows coupling caps on the near end, TI shwos them on the far end.  Just need to keep consistent.
        AD9515 includes internal DC bias, so just couple and terminate.
    AD9515 configuration bits
        S0 = 0, delay bypassed
        S1 = 1, low-swing LVPECL + CMOS
        S2 = 0, output 0 off
        S3 = 1
        S4 = 0
        S5 = 0, output 1 divide = 1
        S6 = 0
        S7 = 0
        S8 = 0, doesn't matter since S0 = 0
        S9 = 0, doesn't matter since S0 = 0
        S10 = 0
        -> S3 and S1 are high, rest are low

Finally placed some orders.
    Clock, clock test, PSU boards from EasyEDA... $43 incl. shipping for 3 different 2-layer boards
    Digikey parts $170 ish
    Allied transformers $46
    Ebay SMA/BNC cables $18
    -> Total = $277
    But V2 is under way.

4/2/2017
--------
I think it's time to take another look at that 5 V regulator.
Constructed circuit in LTspice.  Startup problem seems to be the base current buffer, which I may have added relative to the original Jung design?
    Adding 1k resistor from input to that node fixes thing.
    But I don't get what my design was attempting to do.
    It's a PNP, how is that going to source a positive base current?
    If I flipped the E/C around it wouldn't be a follower anymore and would affect the transfer function
    I added a connection that was missing .  Now it oscillates.

Op amp - I have an AD8655 (AD825 doesn't work with such low supplies)
    28 MHz gain/bw product, 11 V/us slew rate, 2.7 nV/rtHz noise; RRIO
    And it drives +/- 220 mA output current.  So why does it need buffering again?

-> Just remove that buffer.  It makes no sense.
    That makes it similar to the std pos regulator (non-LDO) except without LM317 prereg, and with ADR441 ref instead of LM329.
    
How to try this out?
    First, test the reg as is.  But alligators are too clumsy to connect it - ordered some hooked leads.
    Will solder wires on for now..

Initial test: Doesn't start.  Not surprising.
    Try hacking the board.
    Replace R7 with short.
    Still doesn't work.  Probe around a bit...
    In = 19.33
    Q1 base = 17.46 emitter = 19.35 collector = 0.5
        -> no current through R4
        Is transistor busted?  Not exceeding Vce limit.
        Try resoldering.

Seemed to work for a while then cut out.
    Tried replacing with new BC856.  Initially works.  Going to load test.
    Expected load in current setup:
        Call it 25 mA from oscillator
        DSD1792: 40 mA at 44.1k
        -> only 65 mA.  Let's load it at 200.
        For 5 V, 25 ohm will do it. (Power = 1 W)
        Expected reg dissipation = 15 V * 0.2 A = 3 W
            So it might get hot.  But that's the point.
        Q1 appears to be hot very soon.  Still hot after load removed (Vbe = 0.4, Vce = 14).  How much collector current?
        
        Connecting 22 ohm resistor saw output voltage go up to 10 V then down to 3.3?
    Probably that fried the AD8655.  The max supply is 6 V.
        AD8655 supply = 3.4 V; amp out = 0.9 (despite the fact that input is positive), D1 is turned on
            and Q1 is sourcing current into the amp output
    But why did that happen?
        Oscillation would be one reason.
        The peak in line transfer function appears related to the output cap,
            but it's still -70 odd dB at its peak.  (and goes higher if caps are smaller)
    
    Replaced AD8655 (last one...)
    
    Now work more gradually.
        1) Startup with 680 ohm-7 mA OK
        2) Startup with 220 ohm-23 mA OK but voltage went up to 5.11?
        3) Startup with 100 ohm-50 mA OK 5.10 V
            But when I touched the resistor it went up to 5.15?
            
        4) Startup with 47 ohm-100 mA  OK
        5) Startup with 22 ohm-200 mA  OK
            Pretty hot though
        Long term test?  Monitor with IR gun
            Voltage is drifting up... 5.17 after 2 min.
            Ended the test after pass transistor was showing >100 C on the case.  Toasty.
            But that's a separate issue.  For now, should reinstall and see if it works with 65 mA load.

End of (eventful) day...            
Back in the system, will see how it goes.

In the future, will have to think about heatsinking for those regs. (And PSU?)


4/3/2017
--------
Some morning regulator research: Just use LM317/337
    LT1086 is available in D2PAK (pos. adj. reg)
    RMS output noise is 0.003% of Vout integrated from 10-10k Hz
        -> At 15 V, that is 450 uV, which is 4.5 uV/rtHz
    LT3088: D2PAK 800 mA adj reg
        Nonstandard architecture gives 85 nV/rtHz (27 uV from 10-100k Hz)
        But it costs $4.70
    AZ1084CS-ADJ is the cheap option (I guess like an LM317)
    
Some morning reference research: Use LM4040
    In my circuit 500 ohm / 120 uF gives corner at 2.6 Hz.  So the LF noise matters slightly more.
    LM329 has 7 uV from 10-10k (at 6.9 V)
        Looks to be about 75 nV/rtHz... going up to 125 at 10 Hz.
        But the scope trace of 0.01 to 1 Hz looks good. < 5 uV pp
    I was using ADR441: $6.45.  Rated 1.2 uV pp 0.1-10 Hz.  I guess that's what matters since ref is filtered?
        48 nV/rtHz. -> 4.8 uV from 10-10k
    Cheap option: LM4040 (Micrel) 35 uV over 10-10k at 2.5 V.  (350 nV/rtHz)
    ADI makes ADR5041 (2.5 V): 3.2 uV 0.1-10 Hz, 150 uV 10-10k Hz
        ADR525: 18 uV pp (3 uV RMS? -> 1 uV/rtHz) 0.1-10 Hz, $1.46
    Need a good compromise of cost/noise... help
        -> LM4040D25FCT-ND $0.50  SOT23-3 
        35 uV from 10-10k.  Noise density up to 480 nV at 0.1 Hz, not bad. (Corner around 1 Hz).  This is at least close to LM329.
        1% voltage tolerance but whatever
        https://www.diodes.com/assets/Datasheets/LM4040.pdf
        
AD825 ($4.98) and AD8655 ($2.57) have same pinout in 8 pin SOIC.  That's good.
    AD825: 12 nV/rtHz -> why not use something lower noise?  ... may not exist, at least not for desired GBW and cost
    AD8655: 4 nV/rtHz
    -> Keep as is.
    
Prereg / low cost reg: keep LM317
    Bypass with 1206 jumper for LDOs
    Just remember to get the pass transistors in D2PAK for height match

Next: Look at Jung's 1995 article and design test apparatus for reg boards.

Seems to rely on an AP machine.
1) Line rejection: Superimpose AC on the input


BTW: get shielded twisted pair cable from 
    http://www.markertek.com/product/l-2t2s-bk/canare-l-2t2s-audio-cable-black

Low noise measurement preamp (4x 9V battery?)
    PM Carl_Huff for boards?
http://www.diyaudio.com/forums/equipment-tools/287604-groners-low-noise-measurement-amp-linear-audio-vol-3-spare-boards-15.html#post4744070
    Need to decide how much effort to go to.
    See Linear Audio vol 3 pg 143
    It looks good and it's unbalanced.
        -> Input: Floating with ground tied to source ground
        -> Output: Connect to sound card through isolation transformer
    
Alternative is poor man's measurement amplifier (PMMA) - Linear Audio vol 7 pg 133

4/4/2017
--------
Contacted Carl about boards, he says he's about to order more and will follow up with me.

4/6/2017
--------
Morning circuits: drew up the test part of schematic for regulator prototyping
    Now I just need to put in the actual regulators (including 1-side layout)

Also, the 5V regulator was broken again
    Dammit.
    It lasted a couple of days.
    I'm going to assume this is heat related and not a fundamental problem with the circuit, for now.
    
Now porting the circuit over.

Reference redux: MAX6220 looks like a good deal at $2.42 (MAX6220ASA-2.5+-ND )
    1.5uVp-p 0.1-10 Hz
    1.3uVrms  10-10k
    15 nV/rtHz above 100 Hz... needs 1 uF cap from NR to ground

How to mount the D2PAK devices when there are caps on same side?  (cap height = 10.2 mm D2PAK height = 4.4 mm)
    1) Find shorter caps
    2) Make a metal spacer (requires layout to put all the D2PAKs in a zone of no caps)
    3) Put the caps on top of the board (then modules have to clear them)
    
Not an easy layout... take time on the first one, get it right

4/8/2017
---------
5 V LDO failed again.  Thinking about why... what about Q1? (BC856)
    Dissipation is rated at 225 mW at 25 C
    556 K/W thermal resistance junction-to-ambient -> implies 150 C junction temp
    In the circuit... green LED bias over 47 ohm resistor (1.2 V?) gives about 25 mA
    And if input is 20 V, output is 5 then emitter is at 18.8, collector at 5.6 -> Vce = 13.2 V
    So, power is 330 mW
    Ding... that's a problem.
    Start out by ~tripling that resistor.  Startup should still happen.
    (Don't forget to replace Q1, may as well remove Q3 while at it)
    
After reducing Q1 current and replacing: 2.14 V out, not quite started up
    2.73 V at base drive.  Think the zener voltage needs to be bumped up.
    Can do 2 LEDs in series to get 3.6 V?
    (Op amp AD8655 is rated to 2.7 V, so Zener voltage should be at least 3.4 V.  Maybe 3.6 to be safe.  But that does limit min. voltage to around 3 V.)
    Note: Work backwards for required base drive current.
        DC current gain  = 60 at 2 A, Vce = 1
        1 A out -> 16 mA in
    What I have now is 6 mA.  So hopefully the load isn't too big.
    Real fix is probably to use a beefier device there, and give it 20 mA.
    -> BC807 should work.  Rth = 272 (about half that of BC856).  Use 20 mA.
    I have some of these lying around from discrete I/V stage
    
Anyway, the hack of using 2 LEDs in series got me going again.
    Listened in the afternoon with friends
    Need to listen more to evaluate.
    
Finished a 1-sided layout of pos reg
    Much time spent on making this layout to my liking.
    Dimensions = 2.2 x 1.3 in

Now copy over to make the other regs

4/9/2017
---------

Copied over the positive reg and removed LM317 prereg on the LDOs
    Much EAGLE hassling.
    Any way to recover area for LDOs with those big caps?
    Fine if I can't.

TODO: Fix up negative reg.
    It should probably be drawn with GND on top.  Otherwise quite confusing.
    Problem: Generating a negative reference
        The MAX6220 is a series reference and thus can't be used the same way as the LM329
        The LM329 would work but it's TO-92
        There are SMT shunt references like the LM4040 and ADR5041 but with much worse noise
        How about LT1236CCS8-10#PBF-ND ? $4.52
        
4/11/2017
---------
Negative reg: compared to v1 schematic
    Looks good.  OK to implement layout.
    
4/23/2017
---------
Listening session last night
1) Vertical Horizon
    Smooth, detailed and relaxed.
    Compressed, syrupy sound of the recording comes through.  A little "glow".
    Diversity of drumset sounds was preserved.
    Felt a little distant, as if I was listening through studio monitors as a recording engineer, rather than "in" the music. 
        Maybe it wasn't loud enough.
        But I was still pretty involved, with say "Grey Sky Morning" and "Finding Me"
2) John Williams
    Man, this music is overkill.  It's so good, but no one notices because they're watching the movie
    Chorus on Home Alone overture is good.  Sounds like cute children.
    Strings free of grain, though as I recall this recording may already be equalized for easy listening
    Gentle on the low bass, but it's there
    (These are as much comments about the speakers as the source)
Overall verdict: Pretty good.  Hard to motivate further work when I can listen like this.
    If the relaxed non-fatiguing behavior keeps up, the main issue to look for will be emotional involvement.

More work on negative reg layout
    Way too much stuff has to be re-done vs. positive reg.
    
Also, need to add stuffing options for LM317/337 only. (not prereg, just reg)
    Including on LDOs where it isn't usually there.  See how that goes...
    Does bump the boundaries out a bit but not too bad.
    
Ugh, now I have to place and route all of the testing stuff..
    Try to have top and bottom independent... but there are some through hole parts.
    SMT substitutes can be found for everything except: transformer input, snap-in capacitor
    Did a rough placement
    
Some thought to mechanicals/thermals
    Overall footprint of regs is about 5 x 3 -> will span (underneath of) 2 modules
    Heat spreader: 3/8" thick, 1-1/2" wide Al bar (~6" long - holes drilled on centerline at 2.5" intervals (.5/3/5.5)
    D2PAK is 0.175" (nom.) thick - makes PCB to chassis clearance 0.55"
    Caps are 10 mm high = 0.4"; sounds about right  (note : 1/4" thick Al would give 0.425", not enough clearance)
    Will need an odd length spacer for the isolator PCB, then (unless the heat spreader can be custom milled to the right height)
    Assume holes in spreader align with chassis and it's just secured under chassis with nuts
    Assuming 5 V drop across each reg, and 1 A, the losses are 20 W total... sounds risky, but whatever
    
TODO: 
    Convert jumpers/headers to SMD footprints
    Do a placement within board outline (think about which things need to be outside of regs)
    Hook up everything

5/6/2017
---------
Man, I really haven't spent enough time on this.  Time to finish up the regulator test board while I'm not sleepy.

Listening notes:
    This is dumb, but at some point I turned off the old CD player.
    It was sitting on top of the amplifier.
    I think this made a noticeable difference.
    A bit more relaxed and liquid -- this might have been the configuration that I first listened to with the v1 I/V stage.
        (Except now I have the v2 I/V stage and all Jung regulators.)
    Put on a series of rock music with the volume control vertical.
        Foo Fighters, quite clear and not really anything objectionable.  When I had listened to it at lower levels I was worried that it would be an intense mess if cranked up.  Upper bass on "Aurora" is overkill, but I think that was intentional
        Even Bush (Comedown), extremely hard and grungy recording, not as fatiguing as I remember.
        Gin Blossoms, vocal sounded a bit hard at times, but really melodic and I liked the lively bass.
        Guns N' Roses mix is insane, but I can actually follow the guitar and singing at the end of "Catcher in the Rye" when they're brought out in front of the band.  It still sounds a little squashed compared to more easy going speakers, but I'm not trying to escape the room.
        Live (They stood up for love), seems a bit hard, but nothing's bothering me.
            I think I can hear the distortion from my ears and/or tweeters at this level.
            But the fact that I wasn't driven out of the room is a good sign.
            And I really got into it.  "Masters of every time" indeed
        Dave Matthews "Ants Marching".  Sounds big, but I'm not appreciating details the way I usually do.  It's just loud.
        (88--90 dB average with the Dave Matthews, which is less compressed than the others for the most part.)
        Eva Cassidy, amazing as always.  (Thicker balance than usual, maybe I broke in the woofers.)

5/7/2017
--------
Finished layout and ordered boards for reg test.
My specialty: making 2 layer boards for things that really shouldn't be 2 layer

Still need to prepare lists and order parts.  Don't forget:
    - Enough parts to make 2 boards, one with LM317 only variant and one with Jung
    - Multiple types of through hole Zener diodes for adjusting input DC
    - Mini test points and jumpers in addition to those SMT headers
    - Op amps may be cheaper from Arrow
    - Fuses (and connectors?) for Mike
    - Barrel jacks for separate RPi/FPGA supply input
    - Different values of 2512 SMT resistors (0-1 ohm)
    - Syringe tips - the one I have is stuck (if it's cold? seemed to work fine on Sun 5/14)
    DONE (Ebay) SMAs, didn't get enough the first time
    - 0.1uf 0603 caps, got 1206 for some reason
    - Standoffs and shit
    - Extra 50V 1000uf caps to replace the 16 V ones on PSU board

5/13/2017
---------
Assembled PSU and clk test board (still need to do the 2 variants of the clock gen)
Need to get a chassis platform and put the transformers/PSU on it to get started

5/14/2017
---------
Assembling clock gen boards
    ADCLK948 is a pain to solder, but looks good once on there.  ADM7154 -  not sure if I got the bottom pad attached without killing it.

What to do with oscillators?
    2 boards -one LVDS one LVPECL
    2 oscillator footprints each
    LVDS board: Crystek vs. Epson
    LVPECL board: Crystek vs. Tent
    But don't solder the Crysteks yet, get them working with the Epson/Tent
        Hopefully the 24.576 Tent isn't actually broken.
        If it is... Compare with the 11.2896 one, when I'm confident I won't bust it.
    
Cut the boards for the proto-chassis
Marked holes and cutouts, need to drill/dremel/file

Next steps:
1) Order parts (things you need for clkgen, and parts for pwr test)
2) Drill/cut boards - wire up supplies to heart's content

5/19/2017
---------
Half-day off from work
Assembled the protochassis transformers and AC input stuff (only cracked the acrylic a little...)

5/24/2017
---------
Have the regulator test PCBs now.  Better get moving on ordering those parts.

5/29/2017
---------
Put together BOM for regtest PCB.
    About $50 in chips from Arrow--trouble logging in to place order, will retry tomorrow.
        -> Done
    $140 for Passives and some discretes/chips from Digikey
    SMA connectors from Ebay 10 for $9
    
Also discovered wrong voltage caps on PSU PCB - will order replacements.  Good catch before powering it up.

Zener options: 3.75 + zener voltage (+/- 2 from control)
    Desired range would be about 7 to 25 V
    Max : 20 V zener is fine 1n5250b
    Min: 3.3 V 1n5226b
    Other options:
    Out     In     Zener
    15      20     16       1n5246b
    15      22     18       1n5248b
    15      25     20       1n5250b
    5       15     11.2     1n5241b
    5       10     6.2      1n5234b
    5       8      4.2      1n5229b
    3.3     7      3.3      1n5226b
    
PSU bringup
    Probing around
    VPS10-2500 primary resistance is ~ 7 ohm
    F7-28 output AC at no load: 34 V (CT balanced) - 21% above nominal
    VPS10-2500 output AC at no load: 6.30, 6.28 V - 26% above nominal
    +22 output at no load: 23.4, -22 is -23.4 (total 46.9) -> rectifier drops 1.18 V
    Each +7 output is 8.43 V -> rectifier drops 460 mV

Got some sparks, need to properly bleed off current when powered down.
    -> Discharge and for now, add some through hole resistors
    Takes a few minutes to run down all the cap.

So, before I hook things up, probe around the clock test board.
    Dig. 7 V input - OK
    3.3 V supply to ECL receiver - shorted
        Where's the short?
        Probably under the AD9515, but it's so hard to see..
        Removed AD9515 - short gone.
        Replaced AD9515 - looks like it's at a slight angle, but short gone.
    3.3 V supply to LVDS receiver - OK

At least it doesn't look like any of the supplies on the clkgen boards are shorted...

Goal is to get some clock going (LVDS)

First, powered up with only clktest board connected
    Unreg 7.9 V
    ECL supply 3.3 V
    LVDS supply 3.3 V 
    So far so good. Nothing burned.
Next, plug in LVDS source, with clksel for the osc that's on there.
    Unreg 7.84 V
    Supply on clkgen board 3.3 V
    Osc output 1.63 V
    ECL receiver output 0.8 V
    LVDS receiver output 3.3 V
    Diff clock trace output P 3.3 V , N 0.55 V
    -> Need to investigate clk board more.
    
5/30/2017
------------
Continued clk debug
    CLK_SE (after mux): 3.3 V
    Verified clock going into mux is 1.65 V.
    Tried cleaning up soldering, no difference.
    Did I get mux/inv wrong?
    Try again with the solder cleanup.  Now I've got CLK_SE.
    But diff?
    Now P 2.25 , N 2.05
    And outputs 1.6 V DC - both LVDS and ECL

Note: using SG-210STF osc. only

Logicport: Both outputs (LVDS, ECL) are the right frequency 22.5792 MHz
Oscilloscope: Both outputs are 3.3 V CMOS
    ECL output shows more ringing (bad scope connection, or just faster?)
    LVDS signal: a little ringing, but mostly just a 1st order filtered square wave
In both cases, probably limited by scope bandwidth (I thought it was 50 MHz...)

To-do list:
    DONE Should probably try to look at the diff signals also.  If there is a DC balance issue, I want to see it.
    DONE And why not put on the Crystek?
    DONE Add 0603 decoupling caps when they come
    DONE And why not try the ECL source board?
    DONE And mount the boards to the plywood (small wood-screws with 1/4" spacers?)
    DONE And why not test all combinations of outputs/traces and receivers?
        If trace makes a difference, also try putting 0 ohm resistors under board to see what happens without flying-wires.
    Write phase noise testing procedure.
    In other words, get everything ready for phase noise testing.

6/1/2017
--------
Crystek seems to work.  Output waveform looks the same on the scope.
Added decoupling caps, no apparent difference.
    Except ECL output waveform looks smoother?  Maybe due to less ground bounce coming from source board?
What about the diff traces? (LVDS source)
    9" trace: With 10x scope probe, looks like a triangle wave from 1.5 to 2.5 V
    3.5" trace: A slightly sharper triangle wave? 0.8 to 2.0 V
    -> Probe load is probably distorting that.  Will be fun to check with ECL source.
    But in the end, will have to check duty-cycle of output clock on a faster scope
What about using different traces and looking at SE output?
    a) LVDS receiver
    All 5 traces look the same (OK; slightly rounded, slight ripple)
    b) ECL receiver
    All 5 OK, slightly different looking ripple from ECL receiver
Duty cycle: looks symmetrical, but I'm going to need a faster scope and/or better way of measuring.

Alright, tomorrow try the ECL source and mount things up.
If time allows start assembly of reg test

6/2/2017
--------
Trying out ECL source board
    Tentlabs 24.576 is busted, but 8.472 works (at least according to DC voltages) - use that
    Check waveform...
        8.4 - clean squarewave with slowed rise/fall
        Similar looking ripple to the other source
        ECL and LVDS receivers - same
    Supply output is 7.04 or so, instead of 7.84, so it's drawing a lot more current...
        Wow, how much?  
    Differential trace?
        Waveform doesn't seem to rise much above 0... how were the receivers working?
        Looks that way on either side of the cap.  Bad probe conn?
        Never mind, it was just the 10x probe. Diff trace is square wave from 1.6 to 2.4 V.
    Try Crystek to get an idea of what it looks like at 24.576
        CMOS output looks basically the same as the 22.5792s.
        But diff traces?
        Looks like a little sinewave from 1.7 to 2.5.  Surely scope limited.  (affected by loading?)
        Scope isn't much good for looking at the CMOS outputs either, to be honest.
        Though with 10x probe, ripple is reduced.
    -> No surprises here, though I would like to measure the supply current.
    

Got the PSU board mounted up.  I guess the positioning is fine but it would be happier with a vertical header instead of a horizontal term block.

Tomorrow:
    DONE Mount clocktest board for phase noise testing
        Think about how to separate source from test board
        Figure out where it should go
        Drill holes (whatever drill used for PSU is perfect)
        Mount test board - 1/4" standoffs
            -> oops, should have got 5 since src board seems
        Will need some longer #4 screws to hold source board down.  And longer standoffs/spacers?
            Board to board spacing is about 7/16".
            Spec out any missing parts on shopping list for next time.
        -> Need 2 more 1/4" standoffs for board to board interface
            and 2 3/4" standoffs for clock source overhang
            and 2 7/16 spacers + long screws for that
            
    DONE Assemble PSU test boards.
    NOT DONE Help with bookcase.

6/3/2017
---------
Mounted clocktest board

Started regtest boards.  Shopping list:
    *NM* Need more 10u 1206 caps 1276-6767-1-ND (10 more) - left out C1, C14 (output coupling) on board boards -> Found. (previous order)
    *NM* Missing 1u caps for Jung - C36/44/54 (near MAX6220 refs U2/4/6) -> added, some others still needed
    ORDERED - DK Need more D2PAK LM317s/337s, since they're used on both Jung and LM317 based regs (need 1 more of each)
    ORDERED - Ebay Need more test points (though the mini test points are too small, get regular test points) - red/black and some other color for neg?

What's left?  As components arrive...
    Jung board
        DONE Top SMAs
        DONE    D44H11s 
        DONE 1u caps: C46 C48 C49 C37 
    LM317 board
        DONE Top SMAs
        Some test points for top
        DONE    1 LM317 and 1 LM337

What transformer to test with?
    Desired: 20 V input to 15 V regs
    Which requires about 25 V at the input
        Note: LM317 has about 2 V dropout

6/4/2017
--------
What about having a single carrier board, with stuffing options for the USB streamers, FPGA/no FPGA, Rpi?
    USBStreamer and Ministreamer have similar looking mounting - check
    Want to support async FIFO with FPGA, even if using streamer instead of Rpi
    Also, streamers produce their own clocks
    
Todo:
    DONE Rpi footprint incl. holes/keepouts
    POSTPONED Streamer footprints and mounting adapter design -> flip over also?  6x2 header for USB, 5x2 for mini
    DONE Update carrier pinout to have a 3.3 V power pin for "dirty" side of isolator -> pin 48+46
    Check mechanicals and place board edges and mounting holes
    DONE Figure out supply connection (JST?) and regulation (78M33 DPAK)
    Draw/experiment with schematic

Need to limit myself here.  Too many options
    USB to I2S: RPi/FPGA, Ministreamer, USBstreamer, WaveIO
        WaveIO cost = EUR 100 + shipping
        Ministreamer+USBstreamer cost = $130+20 shipping
        Already have Rpi+FPGA but these would cost ~225 (of course this provides both USB-I2S and async FIFO)
    Async FIFO: None, my FPGA, iancanada FPGA
    Want the first set of boards to cover the extremes of cost/performance
        Most expensive: RPi/FPGA
            This is already part of the plan
        Least expensive: ministreamer
            The carrier connector is a header--what about using wires to hook it up to the isolator?
            Just need the ability to have the carrier supply the clock -> buffer+SMA on carrier to link to clock source?
                That isn't a very elegant solution, but how else to manage the fanout issue?
            Also, where to mount?
                I think it should just be a specialized carrier board.
                    2-layer, pretty cheap.
                    Carrier is 3.3 x 4.5 " -> $30 for 10, i.e. $3 each.  Not bad.
        -> Fine, design a 2nd carrier for the "streamers" later.  It just has to be thought out / tested.
            Features will include: Same power connector for separate 5 V input (since you don't get it from the streamer)
                (drives the power pin on carrier connector)

Connector hunting
    JST VH series: 3.96mm pitch, 10 A rated, cheap.  
        455-2947-ND PCB header.  455-1183-ND wire conn housing.  455-1133-1-ND crimp pin.

6/5/2017
---------
A bit of schematic drawing
    Both FPGA and Rpi have onboard 3.3 V regs.  So, don't need my own.
    This board is going to be really simple... just get it out the door.
    
JTAG connector on carrier, or edge of FPGA?
    Edge of FPGA looks like a good option, except for conflict with module and/or chassis divider
    Of course, that's just for debug; USB can be used to program FPGA
    
    
Mechanical notes
    FPGA board width 3.305" height 2.010"
    FPGA board should overhang isolator connector at top edge of board
    RPi width 3.348" (3.520" with USB connectors and SD card sticking out) 
        height 2.211" (2.302" with audio 3.5mm jack)
    Need about 0.3" of clear space at the bottom for mounting holes
    ... so actually, 3.3 x 4.5 is about the perfect size.  OK if FPGA/Rpi overhang a bit.  Especially to the right.
    Rpi needs to be spaced up quite a bit to make room for USB connectors
        Height = 0.611" from top (bottom when flipped) surface of board
        -> 5/8" mating height for header will be needed
        -> Get a stacking header, and 5/8 long spacers, and solder with the boards screwed together so the pins contact at the right point.
        SD card protrudes by 0.088"
    Or, let Rpi hang over right side of board.  That requires 0.837" clearance for Ethernet conn; probably too tight.
    
    Collision of USB cable/connector with caps on PSU board?
        Think about this tomorrow.

6/6/2017
---------
Looked up transformers on Ebay in case the  ones I have aren't suff.
    There's a guy in NJ who sells cheap transformers.  Want about 38-40 Vct.  
    One of those costs $27 shipped and could be here in a week.
    
6/7/2017
--------
Got remaining SMAs, regs, and caps on regulator test boards
They're ready to go, some test points are missing from the LM317, but whatever

Order of operations:
    - Get carrier PCB out
    - Begin testing regulators
    - Recheck clock setup and write phase noise test procedure
    - Design heat spreader (ask Ed?)

6/10/2017
---------
Dealing with mechanical layout issues
We have 2 problems:
    On left, there is the first module board (and chassis divider)
    On right, there is the PSU
    Also note: below is clock source, above is transformers
Initial design has USB connectors and Pi Ethernet connector on the right
    This looks fairly certain to conflict with PSU caps, even with right angle cable 
    (and I don't think there are right angle Ethernet cables)
Board could be extended up a little bit, without hitting the transformers (with current transformer placement)
Oh wait, there is a debug header and PSU connector to the right
    (isolator extends 0.4" to right of carrier edge--total distance to PSU is ~0.75")
    So maybe that is the best for clearance
    USB right angle connector looks like it needs about .6--.7" 
    So it might work.  But it's tight, especially with SD card sticking out, and what if you want Ethernet?
    Also, one of the USB connectors is (nearly?) over the PSU connector on the isolator - conflict with power conn/cable?
What about soldering my own USB wires?
    It's only 480 Mb/s, right?  No big deal.
    Potentially, could also remove USB connectors from Rpi and/or FPGA
    This would make it harder for others to assemble though
Other idea: "T" mounting with Rpi flying above FPGA, mounting holes don't collide
    Distances: top of FPGA board to top of male header = 0.35"
    Height of male header sitting on board (through hole) = 0.1"
    Clearance of RPi needed for USB conn = ~5/8
    Tallest component on FPGA board in overlap zone = 0.08" (SOIC pkg.)
    Let's call it 1.25" spacing and get a female connector for the stacking header to snap into 
        (it's not long enough by itself)
        Quick test using the female header under the FPGA board (fully inserted) gives a spacing of 1.21.  Perfect.
Added bonus of this is that there's room for a vertical JTAG header and for the power input jack

Okay, whew.  Next steps:
    - Add footprint/hook up JTAG header
    - Figure out which FPGA pins to connect to isolator connector
    - Figure out connection of GPIOs to FPGA, and add debug header
    - Add PG test points
    - Ship it
    
Impl. notes
    JTAG header should be S9019-ND $1.20

6/11/2017
---------
Making progress on carrier PCB.

Ideas:
- What about adding SPDIF input/output?  Bluetooth input?
    These could be wired to FPGA or Rpi
    SPDIF can be handled by DIX9211, application note circuit is fine (optical input? TORX1355) - about $10 each
    Think about it... only add after rest of board is done and it looks like there's space
    This might make sense since these protocols provide their own clocks and wouldn't want to be on the isolated side
        (they're digital inputs after all)

- To do SPDIF input, would need/want a tiny board with:
    the TORX module with decoupling
    pg conn (2-pin 0.1" header fine)
    BNC+RCA (right angle PCB mount) connectors
    SMA to the carrier, which would have a PCM9211
How would it connect to the FPGA?
    I2S.
How would it integrate with the rest of the system?
    Anyone's guess.

This could be a bit of a science project.  BT module may generate SPDIF not I2S.
    -> Consider playing around and adding later, via debug connector? (after all, it is pins connected to FPGA+Rpi)

But these would be valuable features:
    SPDIF for interfacing to old style CD players
    BT for casual streaming from phone/laptop/etc.

Also, just discovered that I have the FPGA footprint rotated 180 degrees from what I want.
    oops.  Have to re-do a bunch of stuff
    
6/12/2017
---------
Redoing a bunch of stuff.

Also decided to
    a) Make SPDIF input and BT input one board, so BT module can output SPDIF
    b) Leave that for a separate board, using the expansion connector (for now--integrate once successful)

Ordered carrier boards. $22.12
Parts from Digikey.. $22.09

Want to try a BT module... got one for $10

Hardware notes:
    RPi: need to get female/female spacer and screw from both sides
    There aren't any screws long enough to get a 1.25" board spacing
    Also, spacer lengths are metric with the longest being 30mm (1.18") - got washers to try to bump out spacing

Todo from now:
    - Begin testing of power supplies
    - Design heat spreader
    - Write phase noise test plan when it seems like I might be able to test phase noise soon

6/14/2017
---------
Towards PSU testing
Put in AC from first transformer, see what we get.

Note: 7805 max input is 35 V.  Don't exceed.

Power up operating point
    Unreg: +/- 22.1
    Reg input:  +/- 21.8
    +/- 5 V rails: OK

Let's try setting the reg input voltage to 19.75 V -> 16 V zener
    Which one is that? 1N5246B
    Put it the right way round...

    OK, now we have +20.4 and -20.7 at reg inputs.
        Pos. zener 17.94 to 2.49 (15.45 V)
        Neg. zener -18.42 to -2.49 (15.93 V)
    This is more than I expected from adj to out.  What's going on?
        Maybe the issue is that there's no load?
        Start with a 10k load by connecting pos reg input #1.  (and neg reg input #1-- the socket)
        Good, now we have -19.67 and +19.22.  Adj to out is as expected.  Not much load needed.
    Oops, sockets were headers instead.  Doh.  Oh well, won't be able to try 3-terminal regs.  
        (Order sockets with next parts.)
    
    So the next thing to test is driving the input?
        0.168 V AC at line input (1 kHz)
        Also at Zener diode and LM317 ADJ terminal (on LM317, in has 23 mV, out has 57 mV)
        ARTA shows... something, but not much and not sinusoidal
        DC output up to 19.46 from 19.30 -> getting rectified?  Maybe we need more load.
        So, return to this once we have a reg and load hooked up.
        First hookup the pos reg 2 which is +15 V (LM317)
        DC reg in = 19.26 out  = 15.26 -- OK
        Now, how about a 100 mA load?
            Thermal check: dissipation is going to be
            input reg dropout = 3 power = 0.3
            main reg dropout = 4 power = 0.4
            load transistor drop = 12.5 power = 1.25
            resistor drop = 2.5 power = 0.25
            total = 2.2
            -> should be OK short term.  Will need some kind of heatsinking long term possibly.
        With load: same I/O voltages and there is now a sinusoidal signal at input port (only -102 dB for ARTA...)
            Multimeter says 148 mV, vs. 168 mV drive.  Ah, whatever. -1.1 dB.
        Check sound card connections?
            Yep, wrong channel.  Now I can see much more signal.
            -27.8 dBFS for -20 dB drive configured.
            Let's make life easy and adjust so it's -20.  Still sinusoidal.  (Wow, 0.018% THD...)
            Noise floor is around -105 with no FFT averaging.  -109 or so with averaging.  Some 60 Hz harmonics visible.
        Load transistor isn't too hot... note, ceiling fan is on
    
    So, line rejection.
        Now looking at the output port with the same drive, amplitude is -97.7 and noise floor is -140 to -146
        So, 77.7 dB at 1 kHz?
        Try 10 kHz.  RMS is -84.5, that's 64.5 dB rejection.
        Check input port to see if it's still -20... this FR needs to be characterized.
            Yep, well, close. -20.4.
        Cool, it works.
    
    Now, how about output impedance?  This is a fun one...
        Now driving the load input with the same stimulus.
        Output port shows -74.4 dB at 1k.  What's the actual load current RMS?
        Multimeter shows 0.412 V AC at the 25 ohm resistor (2.5 V).  That would be 16.5 mA RMS.  (-35.6 dBAmp)
        -> Output impedance of -38.7 dBOhm = 12 mOhm.
        Not bad.  Let's try 10k.  Output ampl = -65.6 -> output impedance = -30 dbOhm = 31.6 mOhm.
    
    Now, how about noise?
        Short the line and load inputs.
        Now I see some odd spikes in the spectrum but you can see the floor and its shape (still -140 to -146)
        Better results when connecting the line input and not driving it - just connects the grounds together.
    
    So, what's the actual scale in dB to Volts?
        Multimeter shows input port AC of 411 mV in this scenario.  Which we read as -20 dB after the isolation transformer.
        -> 0 dBFS = 4.11 V RMS, if we trust the multimeter.  So, to convert to dBV, add 12.3.
        Not needed for line rejection.  For output impedance scale by 25 ohm load (i.e. add 28 dB to ampl difference in-out)
            -> 48 mOhm at 1k, 132 mOhm at 10k
        
        For noise, I can read RMS off ARTA: -101.6 (and the spectral density which is -140 to -146 but with 32k points at 44.1k Fs)
        0 dBFS = 4.11 V = 12.3 dBV.
        So -101.6 dBFS = -89.3 dBV = 34 uV.
        Noise spectral density: FFT spacing = 1.346 Hz (2.6 dB), so -140 dBFS/FFT = -142.6 dBFS/Hz = -130.3 dBV/Hz.
            305 nV/rt(Hz).
        Does it add up?  20 kHz = 43 dB rt(Hz).  -130.3 + 43 = -87.3 dBV.  
            But the noise floor was lower than -140 over much of the band so the numbers make sense.
            
    Can't wait to try the other regs and the Jung regs.
    And script this to cover the entire band and generate plots.
    Which to do first?  Decide tomorrow.
    
    
Good day.

6/25/2017
---------
Finally getting back to it.
Need to automate power supply measurements

1. Input amplitude
    a) actual level (drive)
        How about 100 mV RMS?
        For ARTA, that is -16.2 dB when the Windows volume control is at 50
    b) soundcard input sensitivity -- max
        ARTA shows -32.2 dBFS for 100 mV
        (Note: at 500 Hz, -112 dB on the output which is -80 dB rejection. Consistent with earlier meas.)

NOTE: Remember to set Windows volume control to 50 as part of procedure.
OTHER NOTE: Remember to turn on ceiling fan for cooling.  Load transistor case temp was 90 C without it.  About 60 C with it.

2. Getting Python code to work.

So, why does Pyaudio just return the samples we provided (or something like them?)

Not sure that's what it's doing.  Let's get some FFTs.
Latency at startup seems to be around 8k samples.
Looks like a sinewave with 16-bit noise below it.  Not what I was hoping for.

Ah, changed the "default device" to line in in the Windows audio settings.
Now I see a noise floor with a tiny 1 kHz peak above it.
    Ampl at 1k = -119 dB; ARTA had shown -112
    Ah, let's adjust output level now.
    -> No change necessary.  Multimeter showed 100 mV.
With 10 averages:
    1k peak at -119 still.  Rest of noise floor went down.
    Definitely need 24 bit res. (but first, get ampl right with out-in FB)

Fortunately switching from Pyaudio to Sounddevice is easy
    But Sounddevice is still giving 16-bit data?
    All right.  WDM-KS devices (whatever those are) have 24-bit res.

Now for some freq sweeps.
    a) Calibration sweep at input port.  Saved to stim_freqs.txt / fr_input_port.txt
    b) Line rejection (LM317, 15 V)
    c) Noise spectral density - got around 100-200 nV/rtHz, 17 uV RMS.
        TODO: Check scaling.
    d) Output impedance
        Drive of 100 mV RMS across 25 ohm = 4 mA RMS (-48 dBA).  Maybe increase this?
        May not be necessary.
        
OK, I seem to have the procedure down.
Try out the procedure for all 4 regs on this board, then repeat it with more points (1/24 oct spacing)
    LM317 board: results in jun25b dir for low-res meas.
        pos2 (+15) - done
        pos3 (+5) - done
        pos4 (+3.3) - done
        neg2 (-15) - done, but performance needs investigating - worse HF line rejection, higher noise
            Walton's measurements don't show anything wrong like this
            I checked the board and the bypass cap is still there
            -> just needs some playing around/ ARTA debugging

Why not try out the Jung board?
    Eek... well, maybe this will help debug neg meas issues.
    Install Zeners for LM317 setting, test without connecting any regs.
    pos2 (+15) - nom out  14.97,
        Input port cal is showing ~3 dB less than before... 75 mV.  Wonder why?
        Line rejection is good, ~100 dB assuming the setup is working.  (What you'd expect.  Walton measured 120, with 110 at 10k.)
        NSD 30 nV/rtHz?  Integrates to 4.6 uV, which sounds reasonable.
        
    pos3 (+5) - nom out 4.76 <- needs investigation
        Input port cal is now back to normal.  Bad SMA connection before?
        Line rejection is no good at -60.  Why?
        Output impedance is no good at 370  mOhm.  Big problem with this reg.
        Noise same as pos2, but with 60 Hz stuff.
        
    pos4 (+3.3) - nom out 4.75 -.... wrong res divider?
        C51 pos end is 2.57, thats fine
        C53 pos end is 3.18 - bad connection around op amp?
        R57 0.3 V - op amp driving low
        C38 pos end 5.35 - wrong Zener diode?
            Schematic is labeled MMSZ5226B; diodes labeled CK
            BOM is listed MMSZ4684; consistent with CK labeling
                Orientation looks good.
                This is rated 3.3 V at 50 uA
                Actual operating current = 15 mA.  Problem?  Probably.
            All of this range of low voltage Zener diodes have that issue.
            So, we should actually have used MMSZ5226B like the schematic said.
            Have any lying around?
                no, but I do have the through hole version 1N5226B; try that.
        After "fix" nom out is 3.03 V.  See how it performs...
            Result: shitty, even worse than the 5 V one.
    neg2 (-15) nom out -15.03
        Cal for this doesn't roll off at HF like the positive ones on this board.
        Poor line rejection.
        Output impedance is OK though, 10m
        NSD looks like it might be reasonable but with lots of 60 Hz stuff, and rising at HF unlike the pos one.
        
        
Re-test pos2.
    Cal measurement is messed up.
    When I move the jumper to pos5 it's normal at low freqs and masssively rolls off at HF.  
    But with pos2, it's suppressed except for peaks at 60 Hz?
    Something odd about the input impedance?
        ARTA shows: tons of 60 Hz stuff showing up at input port when pos2 is connected
        Mixing with the input in a nonlinear fashion?
        With pos5 hooked up, we can see just the input tone but also many harmonics 15% THD
        So maybe something about the line input on this board is messed up?
        Tried re-heating some solder joints, nothing fixed.

    Looking at output port, see lots of 60 Hz junk.
        But when I turn off the generator it goes down a lot
        -> Line input driver dumping into ground?

        Really bad at 2k.  Output shows 2k tone, harmonics, mixing with 60 Hz.
        Which is a lot like what the input port shows.  So maybe this is about current going into ground.

Getting tired.  Will have to ponder the results and continue tomorrow.
Summary of things that are broken:
    LM317 -15 V reg suspiciously bad performance (line rejection and noise)
    Jung test board - line input screwed up (high THD, FR depends what reg you connect to)
    Jung +5/+3.3 regs  high output impedance and poor line rejection
    Jung +3.3 reg high HF noise
    Jung -15 reg poor line rejection and noise (esp HF); output imp looks OK
    
1st priority is dealing with bad line input on Jung board.

And consider whether regs should be a separate board for modularity?
    I don't think so, but what if I screw up?

6/27/2017
---------
Thinking about bad line input on the Jung board:
    See what happens when I use a lower voltage Zener setting the input
        With 11 V zener, I get 14.09 at pos input
        Now, with input driven, I see distortion (20% THD) but not mixing with 60 Hz.
        See what happens with pos4 reg performance?
        
    Cal showing rolloff at HF might have something to do with distortion.  Cap loading?
        60% THD and rolled off at 5k
        21% THD at 2k
        0.1% THD at 1k
        0.04% THD at 500 Hz
        Indeed.
            C32/C50 are at the reg input since 3.3/5 V regs have no prereg.  TRy removing them.
            
        While warming up, what happens when we drive pos2 (+15) input?
        6.7% THD at 1k
        0.4% THD at 500
        0.12% THD at 200
        And the amplitude looks OK.  So, probably just need more voltage overhead to properly test +/- 15 V Jung regs.
        
    After removing C32/C50: pos4 testing
        Input THD = 0.03% at 2k and 5k
        Cal FR = normal
        Line rejection = still shit, investigate that in ARTA
            Smoother over freq than before, i.e. better at HF.  Probably related to cap removal.  Still in the -50 to -60 range.
        Output impedance = still shit
        Noise = OK except for lots of 60 Hz stuff and peaks at HF (4k, 8k, 12k, ?)
        First, investigate line rejection.
            ARTA doesn't show anything odd at 1k, about -60 line rej.
            Perhaps this is a circuit design error?
            1. Figure out why Vout= 3.01
                Opamp input voltages = 2.24 and 1.80
                Check reference?
                    Well, the supply is only 3 V.
                    MAX6220 says it has an 8 V to 40 V input range.  HMM......
                    Datasheet really means it.  No wonder it was cheaper.
                    Can keep it in the 15 V reg.  But for 5/3.3, need something that works at 3.3.  Digikey that.
                    So, we have the ADR441 again.  $6.26 on DK, $5.08 on Arrow.
                    Noise is reportedly 1.2 uVpp 0.1-10 Hz.  48 nV/rtHz wideband.  (but we filter it)
                    ADR4525 is $4.73 and 41 nV/rtHz.  And hooray, pin compatible with MAX6220.  (disconnect NR cap)
            This pretty much explains the  shitty performance of the 5 V and 3.3 V circuits.
            
    Let's try connecting the pos2 reg up to see what its input looks like.
        0.06% THD at 1k, right input level.
        1.3% THD at 5k, same input level
        0.04% at 500, 0.06% at 200
        So, maybe some loading issues, but over all not bad.
        With the original Zener back, input looks clean?
        Try re-measuring pos2...
            Looks pretty clean now, in all respects (cal, linerej, noise, outimp)
            Though output impedance is higher now around 15 mOhm.
        So maybe removing those caps mattered somehow?

So, need to order new voltage references for Jung +5/+3.3
    ADR4525. MAX6220 is out unfortunately.

And see if we can figure out what' up with the -15 V regs?
    Start with Jung...
    Input port is clean.  run tests.
    Line rejection improved, but degrades above 1k, and the floor is only -90 in the midrange
    NSD still bad at HF and 60 Hz stuff
        Could reflect ground error.
    Output impedance is good.
    So what's going on?  Observe line rej. in ARTA
        At 5k, some 60 Hz mixing is apparent. and line rej is ~62 dB; would want ~100
    Insufficient dropput?
        Vin = -19.85 Vout = -15.04
        Prereg output = -17.35  (note: on pos2 it's +17.34)
        Base drive = -15.26 (collector of Q7).  Hm.
        -8.36 at R53
        Base of Q7?  -15.48, maybe Q7 is saturating.
        
Take a break, it's time to cut wood.

6/28/2017
---------
Received carrier boards, starting assembly but got sidetracked.

6/29/2017
---------
If you want a higher voltage transformer for testing, just get it.
    Done.  $26 for 2 small 38VCT toroids.

Assembling carrier
    Power connectors don't fit the supplies I have.  What's up?
    Supply output plug: OD = .215 ID = .068 (hard to meas.) = 5.46 mm, 1.72 mm
    Circular Connector: OD = .240 ID = ~.085 = 6.09 mm, 2.16 mm
    -> The pin in the center is too big.  Need 2.1 x 5.5 to match supply.
    Shit.  Do I have any of these lying around?
    For now, can just cut off the output plug and put it back on later.

Wired up a huge kludge to test carrier.
    On the plus side, nothing blows up.
    Carrier-isolator header is connected via jumpers, to FPGA header pins on the ZTEX breakout board, which then has wires soldered to v1 isolator
    DAC is in slot 0.
    Active oscillator in IC20 (CLK1B on v1 isolator, connected to )
    DIRCHAN is all zeros and SPI transactions don't work.
    Concerned that there might be a clock problem.
    
Will need to debug with Logicport tomorrow.
Wow, so many wires.

6/30/2017
---------
A note on the Jung regulators: Why not use cheaper op amps?
    5 V: MAX4475 has <5 nV over 1k, 20nV at 10 Hz MAX4475ASA+-ND $1.28 GBW=10
    15 V: NE5534 has 4 nV over 1k, 10nV at 10 Hz 296-26239-1-ND $0.88 GBW=10
    Compare: AD8655 has 30 nV at 10 Hz, 3 nV over 1k, GBW=28 $2.57
    AD825 not specified, but 12 nV at 10k, GBW=26 

Maybe the default used AD825 because Jung worked at ADI.  The AD797 made sense but AD825 didn't.
Even the LM4562 is $2.85.  3nV to 300 Hz, 8nV at 10 Hz.  Works from 5 V to 34 V.  Maybe not going to work for 3.3 V reg.

Shopping list:
    Female SMT 0.1 headers for putting in 3 terminal regs.
    Op amps
    Proper sized (2.1x5.5) DC power connectors
    
Heat spreader: 1-3/4" will fit, 2" just barely
    Caps are 0.40" high
    D2-paks are 0.182" high -> 0.25" bar will work, not much clearance
    
    Bought a .25x2x6 bar for $6.60

OK time to work (10 am...)
OK back from work (4 pm...)

Op amp: reconsidered due to GBW product being low on the cheap options
    I guess faster op amps are more expensive...
    Keep AD8655 since it's cheap and has low noise and appropriate GBW.
    AD825, consider replacing with the cheaper LME49710. 296-38149-1-ND  $2.03 GBW=55 noise=2.5nV at 1k, 6.4 at 10 Hz
    Also Jack Walton found it was an improvement in performance and worked fine.

Let's move on to debugging the carrier.

Clock hookups.  On isolator, only CLK1 is active.  That used to be connected to D27 - showing 11.289 MHz now.
    Now connected to carrier pin 47
Our SCLK output (used to be called MCLK) should be half that freq. Connected from carrier pin 43 to C24.
    Now showing 6 MHz.
    Oops never mind, that's what it should be.  USB clock (48 MHz) / 8.
How about SRCLK?  Carrier pin 38 to D29.
    Reads 750 kHz - OK.
Let's look at some signals.  SRCLK / MCLK / DIRCHAN.
    DIRCHAN is C30 to carrier pin 36.
    See some pulses on DIRCHAN, but not as many as I'm supposed to.
    -> Poor signal integrity?  Wouldn't surprise me.
    Only 1.14 V on CLK1B after the translator.
    That's because there is 2.34 V on the supply. Hmm.
    I didn't hook up the power from the carrier to the isolator.  That explains... something.
    Carrier pins 46/48 to C18/D18 on old breakout board.
    Now that's hooked up, we have 3.3 V, and DIRCHAN signal looks more reasonable.  I can do SPI reads too.
    But there may be some timing issue.  Something is a little sketchy.
    
Playing tone doesn't work although it does seem to have DIRCHAN right.
Probe I2S also?  Just going to do a reset so we don't have to deal with SPI.
    Need to probe: C14, C19, C20
    Those are always low.  Even though things appear to be hooked up properly.
    Read FIFO counts?  FIFO seems to be draining at the proper rate.
    Check constraints.  This is slot 1.
    This may be a problem; in the old HW... for DAC2...
        BCK   is slotdata1[5] or slotdata[11] - this is going to become slotdata1[0] or slotdata[6]
        LRCK  is slotdata1[3] or  slotdata[9] - this is going to become slotdata1[1] or slotdata[7]
        SDATA is slotdata1[4] or slotdata[10] - this is going to become slotdata1[2] or slotdata[8]
    So, we need to re-wire carrier connector for now (don't mess with constraints).
        BCK (brown) from 10 to 13
        LRCK (purple) from 9 to 11
        SDATA (green) from 12 to 14
    We have a tone now!  A clean one amazingly.
    Now test from Rpi.  Looks like it plays music.
    
OK, what next?
    I want to get rid of this breakout board before putting it back in the stereo.
    Plan: Solder header pins in the holes of the isolator FX2 connector footprint, where the ribbon cable is soldered in now.
    Which ones?
        Power 3.3 V - carrier 46/48 (orange) - red wire, leftmost
        
        Ground - carrier 8/32/etc (gray) - black wires, inner rows away from PCB edge
        
        LRCK - carrier 11 (purple) - blue wire, 5th from left, 1st row
        BCK - carrier 13 (brown) - brown wire, 7th from left , 1st row
        SDATA - carrier 14 (green) - 2nd yellow wire, 8th from left, 1st row
        
        RESET - carrier 44 (yellow) - white wire, 3rd from right, 2nd row
        DIRCHAN - carrier 36 (white) - gray wire, 4th from right, 1st row
        SRCLK - carrier 38 (blue) - purple wire, 4th from right, 2nd row
        DMDO - carrier 40 (purple) - blue wire, 5th from right, 1st row
        CLKSEL - carrier 42 (yellow) - green wire, 5th from right, 2nd row
        DMDI - carrier 39 (orange) - yellow wire, 6th from right, 1st row
        CLK1 - carrier 47 (green) - orange wire, 6th from right, 2nd row
        DMCS - carrier 35 (blue) - brown wire, 7th from right, 1st row
        MCLK - carrier 43 (red) - 2nd yellow wire, 10th from right, 1st row
        
Also, don't forget to flash the FPGA with the new bitstream (pinout changes).
    The program to flash the FPGA is ~/software/ztex/java/FWLoader/FWLoader
    Options : -f -um ~/projects/cdp/xilinx/da_platform/da_platform.runs/impl_1/da_platform_wrapper.bit

Hooray, seems to work.  Maybe more junk in the output than there used to be?
Time to install back in the stereo for now.
    Actually, nasty distortion.  (At least it plays music...)

7/1/2017
--------
Finished writing up the phase noise plan, sent to work.
    Remember to ask Frank to ask around this week.  And e-mail Kimberly.
    
Things to do:
- Fix distortion issue with carrier and v1 isolator
- Test regulators with higher voltage input
- Test 3.3/5 V regulators with ADR4525 references

Working on fixing things with the carrier
    Problem: Now there is no sound
    Playing a 60 second tone is suspiciously fast.
    Also SPI registers are all zero
    DIRCHAN is properly detected (but maybe that's luck?)
    My guess is that the clock isn't getting through.
    
Probably needs some Logicport debug.  Laptop?
    After moving the shelf down to the ground, DIRCHAN is wrong but the tone generator takes the normal amount of time,
    suggesting that there are some bad connections going around.
    
Got it working on the ground, now it's broken again when in the shelf.
    Silly bad connections.
    A good proxy for "broken" is when it detects the AD1934 instead of DSD1792

Got it working, it's just a matter of shoving the boards around in the right places.

Time for 3.3/5 V reference replacement
    ADR4525 datasheet: 1/3/5/7 = NC, 2 = in, 4 = GND, 6 = out.  Interesting thing is pin 8: test pin. "Do not connect."
    Current hookup: 2 = in, 4 = GND, 6 = out, 1u cap to pin 3.  Everything else unconnected.
    Looks like the cap won't hurt anything.
    
Components to remove = U4, U6.

After replacing references, output voltages are correct (5.01 / 3.31)
Time to do the sweeps.  Data dir is jul1a
    Pos4: cal is wonky
    Line rej. is fluttering around at LF, then comes out around 85 dB at 200 Hz and decreases smoothly to 55 at 10k
    Output impedance is ~const at 11 mOhm.
    Noise is flat at 100 nV with 60 Hz spikes.  (~10x more than expected).
    Line rejection and output impedance improved, but:
    still some head scratching to do.
But let's try pos3.
    Same shit with the cal.
    Line rejection is better than pos4: -100 in the low/mid freqs.  Degrades to -82 at 10k
    Output impedance flat at 11m - same.
    NSD 30 nV - good, though I wonder why it isn't better. 4 uV RMS.

So let's figure out this cal issue.  Multimeter says?
    Multimeter gives me 40 mV whether I connect it to the input port or not.
    However it does show 100 mV at the adjust terminal of the LM317.
    So what is the reg doing to slow it down?
    ARTA spectrum shows input port is suppressed, super distorted and mixed with 60 Hz.
    But it's that way now for pos2 also.
    Negative reg?  clean.
    With pos5 (10k res only) - lots of THD but no mixing.
    
Maybe the unconnected regulators are screwing things up?
    With input to pos2, output to pos3, output is 2.49 V?
    That's from the load current thing.  Turn that off for a minute?
    Still a distorted input port when driving pos2.
    OK, the unused regs are still off.  so it's probably something about the active reg.
    
Say, what about the dropout on the LM317?  Not enough (due to transformer voltage)?
    Bingo.
    Put in 11 V zener, for 14 V reg input, and input port is clean.
    Re-test LV regs.
    pos3:
        - cal normal
        - line rejection not as good (maybe because the input is being driven properly?).  100 at 100, 82 at 1k, 63 at 10k
        - noise 30 nV with 60 Hz stuff, total 4 uV
        - output imp this time 13m (again, probably due to stronger input)
    pos4:
        - cal normal
        - line rejection similar to pos3 (almost exactly same, looking at graphs).  95 at 100, 84 at 1k, 62 at 10k. 
        - noise still 100 nV.  Problem needs to be investigated.
        - output imp 10m

Well, that certainly sets the stage for testing with a higher voltage transformer.

But, looking at pos4 noise:
    ARTA averaging with no input shows: noise floor around -150, RMS of -104.
    Compare to pos3.  Immediately you can see it's 10 dB lower.
    Whaaat
    So there's that Zener diode I soldered on.   1N5226B instead of MMSZ4684
        But I doubt that has anything to do with the noise.   The error amp fixes the noise.
        Bum reference?  Or reference filtering?  Doesn't look like it.
    One thing to try would be changing the resistor divider that sets the output voltage.  See if that makes a difference?
    Kind of stumped by this.
    
So, just move on to testing with the higher voltage input.  And see if I think of anything for the pos4 noise.

7/2/2017
----------
New toroid.  Testing 40VCT winding:
    No load - 42.7 VCT
    This should give us about: +/- 29 V DC.  Good.
    Note: 7805 abs. max is 35 V, and recommended is only up to 25.  So let's hope that sags a bit..
    I bet nothing bad will happen.  Let's see...
    No.  Use the blue ones.  40.2 VCT will give +/- 27.8 instead of 29.6.  Feel better about this.

So, some testing.   
    First pos2 with 16 V zener (19.7 V in)
    ARTA shows clean input.  Test results seem similar to the initial ones (jun27b).  In other words, good.
    Now try neg2 with 16 V zener.
    Noise has gone down a bit, but still bad (80 nV?) with lots of 60 Hz
    Line rejection and output impedance are the same.
    Line rejection is way worse than the pos reg. at mid/high freqs. ARTA shows basically what you'd expect.
    Similar to the pos3/pos4 where there is no prereg.
    So, something wrong with the prereg?
    Prereg in: -19.83 adj: -16.11 out: -17.34
    Reg base: -15.33 out:-15.04
    Both error amp inputs at -10.03 which is good
    
Notes from board inspection:
    neg2 (-15) and pos4 (-3.3) regs are both along bottom edge of board, and thus share ground
    The output port is connected to the ground on the top.  So it has to go all the way around to get to neg2.
    Also, small ground currents from the voltage disturbance circuitry go into the ground on the top.
    Let's ballpark:
        100 mV RMS
        Assume current dominated by the 1k resistor R4. -> 100 uA RMS
        Assume trace is 0.2" wide and 3" long - 15 square at 0.5 ohm/square -> 7.5 mOhm
        So the voltage error is 0.75 uV RMS, or -102 dB
        Plausible.
    Want to try adding a better ground lead to the output connector?
    Interestingly, input port connector is grounded near the neg2 reg.  So that would be a place to solder
    What thickness wire is needed?  Length = 3 in.
        12 awg is 1.6 mOhm/ft.
        16 awg is 4 mOhm/ft.
    Using 12 awg, why not.  SMA to SMA.
    ARTA showed the output spectrum is suddenly much cleaner.  Let's re-run the sweeps on neg2.
    Line rejection now gets to -105 like pos2, in the midrange.  Starts degrading faster at HF over 1k, -72 at 10k vs -92
    And the noise is back to what I would expect, 30 nV/rtHz, 5 uV RMS.
    
Now I'm reasonably content with the neg2 meas.  Try pos4 again.
    Line rejection same as before (gradual degradation at HF)
    Noise went down a bit to 60 nV, but lots of 60 Hz in there.
    Problem is probably that lots of little currents are getting injected into ground between the reg and output conn
    
What to do about this?  Anything?
    Try more heavy wire soldering.
    C50/51 seems like a good place to attach wire.

Also, the NSD measurement floor is higher than I thought.  RMS = 3.7 uV, ~30 nV, a few spurs.
    Can anything be done about this?
    Short of adding an LNA, no.

Adding the wire from pos4 ground to output connector actually made the noise worse.
    HF line rejection improved by about 6 dB.
    Weird.

What's next?
    Do some plotting of the latest data for the different reg types.  Then decide what to do.
    Try to wrap up this regulator testing stuff today.

Plotting is done, initial writeup given to Frank for review.
Also reading Jung's articles (hardcopy).

If I can get the regulators out of my hair, I think it's time to move on to the isolator.

OK, not quite out of the hair:
    Try with the rectifier on the other board.
    3.3/5 V only.  (DC input is reduced due to reduced transformer voltage, plus the extra rectifier.)
    ARTA: Some 60 Hz harmonics present but not as much as before.
    Sweeps: Big difference in both noise and line rejection.
    To try getting rid of the 60 Hz, let's remove filter caps from the test board.  (They are on the rectifier board.)
    Hmm, the big cap doesn't want to come out.
    Uh oh, even after taking it out, there is 60 Hz stuff in the output.  Ground loop?
    Try disconnecting line input. -> Even with line/load inputs shorted, more 60 Hz stuff.  Why does it matter?

Got some better looking results.
    1) line rejection now >100 for pos3/pos4 at LF, degrades somewhat but better than before
    2) noise for pos3/pos4 now indistinguishable from noise floor

Updated the writeup.  Now I think I'm really done.
    But, there are 2 loose ends: 
        1) substituting LME49710 on the +/- 15 V regs, and 
        2) adding female 3-pin sockets to try out v1 regs (and 7805 etc.)
    Another time.

For now I think I'm ready to move on to the isolator.

7/3/2017
--------
Indeed, time for the isolator.
First question is what isolators to use?
I have a tube of ADUM3402CRWZ.  Qty = 39.  Should probably use those.
    But what are they pin compatible with?
    First, specs.  2 in/2 out.  Pin 7/10 are active high enables.  3.0 to 5.5 V.  Up to 90 Mb/s.  34 ns prop delay.  <16 ns skew.
    Package: RW-16, 7.5 mm wide SOIC, 16 pins.  0.05" pin pitch.
    I have 39 of them left.  I guess I used 8 for the v1 isolator. (to make 2 slots work)
    Compare to what I had penciled in earlier: ADUM142E0 (which is cheaper--10%?)
    2 in/2 out. Pin 7/10 are active high enables.  1.8 to 5 V.  Up to 150 MB/s.  6.8 ns prop delay.  <7.5 ns skew.
    Package: Either R-16 or RW-16. (RW-16 is same as ADUM3402.)  
    -> Should spec ADUM142E0BRWZ, but use ADUM3402CRWZ that I have on hand.
    
    Output current/speed:
        ADUM3402C: Rise time  = 3 ns with 15 pF load.  If at 3.3 V, 20-80 rise is across 2 V, so 3 ns is 0.66 V/ns -> 10 mA.
        ADUM142E0: 2.5 ns, 10-90 with 15 pF.  15 mA.
        
BTW, I paid $275.87 including shipping/tax for the 47 ADUM3402CRWZ that I have.  ($5.59 each)
    So, better use them.  Just keep in mind that ADUM142E0BRWZ will be faster.
    
Need to come up with steps for transforming old schematic
    DONE Label nets from carrier, then slots, supplies, clocks
    DONE Fix signal naming around unidirectional isolators
    DONE Fix signal naming around bidirectional isolators
    DONE Do direction control (isolate the serialized signal and deserialize?)
    DONE Add logic for serializing/deserializing of relevant things (CS_N, DIRCHAN, HWCON, HWFLAG)
    DONE Add power supplies (copy schematic and layout) - and make modifications from errata
    DONE Add debug header (will wait to assign pins until layout)
    WONTFIX Add test points (will just drop pads on layout)
    DONE ERC
    Review and add labels/rearrange sheets
    [Then on a future day] Begin layout

7/5/2017
--------
Some notes from looking at the (nearly schematic-complete) isolator:
    Supply regs need to be rotated relative to what I was expecting.
    This will require more routing area, and obviously blocks the bottom layer.
    Also, heat spreader needs to be wider and it isn't clear how it will be secured given the module standoffs need to come from within that area.
        Could just put big through holes in it so the spreader fits over the standoffs, I guess.
    Not a lot of routing area available...
        In vicinity of modules, layers are used up like this:
        1.  Clocks, plus other digital routing (shield in between)
        2.  Digital ground plane
        3.  Supplies
        4.  (Modules 1/2) Regulators; (Modules 0/3) Open
        How many unique signals to each module?
            Exclude diff clocks, supplies.
            Shared digital signals: [5] MOSI, MISO, !RESET, SCLK, SRCLK
            Unique digital signals: [11] !CS, D3, D2, D1, D0, LRCK, BCK, HWCON, HWFLAG, DIR, CHAN, 
        This means # signals crossing = 49
        There is space for 25 signals in the gaps of the module pads,
            so if we had 2 layers, it would work.
        Also, top layer is going to be off limits due to diff clocks, in a lot of places.
        
    Need to think about floorplanning the right end - is there going to be a clear shape to the "carrier supply region"?
    
        
7/9/2017
--------
Some isolator schematic review and floorplanning.

Where to tie AGND/DGND together?
    First, the PSU connector on the isolator ties the AGNDs together.
    Didden's companion to the Jung regulator article shows grounds being tied together at the most sensitive location
        the input stage of an amp
    But I can't do that.  And also, that was referring to separate +/- grounds, which I don't have (but perhaps should).
    Sometime down the road I'll have to deal with the various AGNDs.
    But right now I'm concerned with AGND and DGND.
    They need to be at the same DC level but otherwise isolated.
    AD1955 data sheet shows use of a 600 ohm ferrite bead between the DGND and AGND (as well as in series with each supply)
    Place 1 at supply connector, or 1+ at each module?
        It's basically an inductor with 0.3 ohm DCR, up to 30 MHz.
        Max current = 200 mA.  Will it carry any current nominally?  No, those nets are totally isolated otherwise.
        How much DC current would flow?  Assume max 1 amp DC flowing into each ground.
        Also note: bead should be used at 20% of rated current (probably less).  Oops, this means I need larger beads elsewhere.
        -> should use 732-1623-1-ND (2 A) instead of 732-1625-1-ND (200 mA)
        Let's just put 1 at the supply connector with the option to replace with resistor. 1206.

Note on costs (for isolator):
    EasyEDA is $90 for 1 oz copper, $150 for 2 oz copper
    So, tough decision.
    Actually, no.  Their stackup images show the inner layers don't get thicker with 2 oz.  (only outer)
        So, the internal impedances of the regs would change but the internal planes (ground/power) wouldn't.
    -> Going to order with 1 oz and see how it goes.
    
    Resistance over the 9.5" length of one of the power traces is 0.1 Ohm. (half that to each module)
    So there will be some drop at high load...
        Example: AD9515 draws about 100 mA from D3V3.  Two of those = 200 mA over half the length = ~10 mV.
    
    
7/14/2017
---------
Did phase noise measurements.  Went pretty well, will have to dig through the results.
Wrote Python script to parse E5052B files and make plots.
Todo:
    Write some code to compute jitter.  Check against E5052B.  Allow variable bandwidth and spur suppression.
    Compute jitter impact of various changes.
    Do writeup of phase noise results.


7/16/2017
---------
Crazy week is over, now I can write up the phase noise stuff.
    Got a start on it, figures pasted in, need to write and do scripting.
    
7/19/2017
---------
Finished implementing jitter calcs with appropriate spur filtering
Added tables to document and redrew figures
Now just need to write commentary.

7/21/2017
---------
Finished commentary.  A few quirks with the integrated jitter, but need to move on.
Excess jitter from clock dist is around 0.15 ps, assuming I can fix the spurs.
Need to sanity check that this is OK before continuing with design of platform.

But I think it's time to go back to the isolator PCB design.

7/22/2017
---------
Isolator work

Issue: Mounting heat spreader.
    Added 3 more .25" pads for screws, down the middle where the regs are (center 2 modules).
    Required some tight rerouting and took copper away from -22 unreg supply input to reg.
    (Heat spreader will require large holes for 4 standoffs to pass through.)
    
Issue: Ground routing
    a) Added bead/resistor option to connect CGND to DGND in case the non-isolator option is used.
        (DGND and AGND already connected through a bead.)
    b) Where to connect regulator grounds (analog)?
        Close to the modules or back at the supply?
        It would seem that to minimize output impedance the connection should be close to the modules.
        What does Jan Didden say?  I think it was to connect at the input stage of the load if it was an amp.
        So, close to the load it is.
        One tweak is to only use the traces near the regulated supplies.  The ones by the unreg supplies might carry ripple currents.

Got an initial placement of everything.  288 airwires left.
    Slight annoyance: Don't think I have enough room right of the barrier to put serdes chips.
    Oh well, probably won't make much difference.  Can slit the DGND plane if worried about that (probably counterproductive).

Tomorrow, to do:
DONE    - Route signals from modules into serdes chips above module 3
DONE    - Figure out power/ground distribution for isolators and other small chips
DONE    - Consider moving isolators to the left
DONE    - Route direction control signals to isolators
DONE    - Route the carrier signals starting from the left end of the connector, just enough to properly position the isolators
DONE    - Route clocks (both sides of isolators)
DONE    - Route data buses (module side)
DONE    - Route everything else on the module side
DONE    - Route carrier side.  Strict direction rules per layer to allow tapping off for debug.

Reminder: Need to test regs for the max current.


7/23/2017
---------
Routing along and marking things as done.

What are the capacitances going to be like?
    a) Each trace (10 mil  = 0.254 mm wide, 35 um thick) to the ground plane beneath (0.18 mm spacing)
    12" of 0.1" wide trace - top layer to DGND plane will be ~30 pF
    With 10 mA drive from isolator, should be 3 ns/V - 10 ns rise time
        Max BCK freq: 64 * 192 kHz = 12.288 MHz - 81 ns period
    b) Traces to each other: assume 15 mil = 0.381 mm spacing which is usually the case.

Got to first complete route.  Dinner break time.

To do:
1.  Make component names make sense.
    Categories:
        - Regs - 3xx (+special codes 5xx for LM317 only options)
        - Isolation 2xx (+special codes 4xx for bypass resistors and ground connect ferrite)
            Isolators for mod 0 are 20x, mod 1 are 21x, mod 2 are 22x, mod 3 are 23x
            Dirchan inverter is 24x
            Unidirectional isolators are 26x
            Dirchan deserializer is 27x
            3.3 V supply is 28x
        - Other digital and support regs 1xx, in other words the "base" components
            Chips are 11x
            Clock receiver is 12x
            3.3 V supply for ser/des is 18x
    DONE.
    Also tweaked silkscreen to avoid overlap.
    
1b. Add test points

2.  Review
    - Schematic sanity checks
    TODO: Add pulldowns for some of the signals coming from modules (HWFLAG? MISO? figure out which ones)
    - Power planes
    - Clocks
    - Test points
    - Mechanical (mounts, heat spreader, keepouts)
    - Whether to test Jung reg under heavy load first

3.  Make module-adapter board
    AD9515/ADM7154 clock receiver; SMA clock output; ensure SPI works for either DAC or ADC; tie off unused signals 

4.  Gerber generation
5.  PCB ordering
6.  Component ordering

[Then after all this]
7.  Design new ADC8/DAC8 modules.

7/24/2017
----------
Started on a module adapter board.  Should go to work though.
    Actually going to be hard to fit everything I thought of.
    Stare at the layout a bit...
    
7/26/2017
---------
Trying to tie up layout.   Some nets will not be fully connected, they will be one side or the other.
    +15: OK, left only - 1 airwire
    -15: OK, right only - 1 airwire
    D3.3: OK, some from both sides - 1 airwire
    
    A5.0: OK, left side only - 1 airwire
    
    D7VU: OK, left side only - 1 airwire
    A7VU: OK, left side only - 1 airwire
    AP22VU: OK, left side only, 1 airwire
    AN22VU: OK, left side only, 1 airwire
    
    AGND: OK, module is connected from right.  3 airwires
    
    DGND: TODO, 14 airwires
    A3.3: NOT CONNECTED -> just threw down a cheap DPAK reg. NCP1117.  Not going to be best performance.
    
Got everything connected (though DGND is kind of shitty).
Next up are:
-   Sanity checking 2 level serdes scheme
-   Adding pulldown resistors and other features I thought of to isolator

7/30/2017
---------
Did Verilog sim for 2 level serdes.  Can be made to work, but definitely need srclk2 to be routed to modules.
    Have some paper notes on this.

SRCLK2 dilemma:
    Only 2 DGND pins in the signal routing portion of the module connector
    Both are used as clock shields.
    -> Eliminate a clock shield, or enlarge the connector?
    Look at the layout to see if enlarging is feasible.
    Connector availability: 1x27 pin female header?  currently 26.  
        Doesn't look like there is any difference in availability.

Implementation fix:
    - Stretched out module header by 0.1", 27 pins each side.
    - New DGND at 16L, new SRCLK2 at 15R.  On each side, other pins moved down.
    - Implementation on module adapter: have to shift some stuff around, but otherwise not bad
    Keep hole positions or move outward?
    Look at isolator board before deciding.  

Adapter board: airwire checks
    +15 OK 1
    -15 OK 1
    +5 OK 1
    A3.3 OK 0
    D3.3 OK 1
    AGND OK 3
    DGND OK 0
    +22U OK 1
    -22U OK 1
    D7U OK 1
    A7U OK 1
    Total airwires = 11 - matches total from Eagle.  Everything is connected.
    Connection robustness = OK, as good as it's going to get with this crappy layout.
    
Time to update isolator...
    I think there is space to spread out the holes.
    Holes are currently 3" apart.
    Let's make that 3.1".

That wasn't as bad as I expected.  DRC and airwires are clean again.
Now following up on review. (7/23)
    1b. Add test points - all done, along bottom edge
    - Schematic sanity checks
        Who needs pulldowns?  
        DIR - pull up -- Default direction should be 1 (DAC)
        CHAN - pull down
        HWFLAG - pull down
        MISO - pull down
        [N/A] I2S lines - don't pull since, if there is no module, dir will be DAC so FPGA will drive them
        What's the right pull down value?  33k = 0.1 mA.  If I use 10k (0.33 mA), current draw will be max 4 mA.  So that's OK.
    -> Pulldowns done
    
    - Power planes
    Unreg.  D7VU OK.  A7VU OK. AP22VU OK.  AN22VU OK.  
    Reg. D3V3 OK.  A5V OK.  AP15V OK.  AN15V OK.  D3V3SD OK.  D3V3ISO OK.  C3V3 OK.
    Ground  DGND OK. AGND OK.  CGND OK.
    -> Power planes OK
    Biggest weakness is the 86 mil inner layer traces connecting the modules.   (100 mOhm across all of them)
    
    - Clocks - check each on module side and carrier side
    
    MCLK - OK
    Module diff clocks - OK
    SCLK - OK -> note close spacing/coupling on carrier side.  Some close spacing, not much, on module side
    SRCLK - OK
    SRCLK2 - OK
    -> Clock checks done
    
    - Test points
    Done above
    
    - Debug headers
    SRCLK2? Got it.
    -> Debug headers look good

    - Mechanical (mounts, heat spreader, keepouts)
    Dimensions: 14 x 5.  OK.
    Heat spreader dim: 2.5 x 5. (2x6 will work for initial testing)
        HF has a bench top drill press for $70...
    Plenty of holes.
    Board conflicts?
        Clock source may hit the isolation barrier; consider a redesign of the clock source?
        -> Move it 0.1" to the right.  Fixed.
        Accessing the debug connector is going to be a little harrowing (right next to PSU caps), not much I can do.
        I put components under the shielding barrier.  Doh.
            (Bottom side - D3V3ISO reg)
        -> Rearranged that.  Fixed.
        No components on top in module area
        Only isolators and caps on top in carrier area
    -> Mechanicals look good.
    
    - Whether to test Jung reg under heavy load first
    [Decide over dinner]
    
    I want to test it, but how?  Test board doesn't have the ability to dissipate heat, esp. from the input regulator
        And also doesn't have separate inputs for the LV regs.
        But I bet I could check the +/- 15 V regs without much trouble.
        What should happen when you overload the reg?
        a) Over current - base drive to the pass transistor will be starved 
            But if HFE is > 100, this will happen over 2 A
        b) Thermal - something gets too hot and dies
            I don't think the reg is protected against this.
            For +/- 15 regs, preregs will limit drop across the pass transistor to 2.3 V.  And it's a beefy device that will be heatsinked.
            So if we have 22 V in, the LM317 will see about 4 V.  And that shuts down at Tj=180 C.
            Seem to have good design margin... 
        c) Line regulation of unreg supply -- 0.5 ohm resistors currently.
        So basically, there should be no problem at 1 A.   But should test with a module plug-in board.
        
    1.  Prototype the test procedures on the LM317 board.
    2.  2 stages of load current:
        200 mA - should carry indefinitely
        500 mA - should get hot
        1 A - ???
    -> NM, just going to order 
    
    Also, what about making a dummy load board?
        that plugs into the module slots and draws (selectable by jumper) currents and has heatsinks?
    That would be a better test.
        2.4 x 3.5" board should be really cheap and quick to design.

    Module adapter board
    -> Done
    
    Power load test board
        Let's say each board can draw up to 500 mA from each rail, in 4 increments (125-200-375-500).
        +/- 15 V - 125 mA from one is 2.25 W - use 10 W sandcast resistors from PE
        Resistor pad spacing 2" for 10 W, 1" for 5 W resistors
        Resistor width (including some space for airflow) = 0.5"
        Area = 1 in^2 for one resistor used
        This is a problem for area... the two headers are only 2" pitch apart
        -> OK, step back to 5 W resistors.  125 mA * 22 V = 2.75 W.
        Well, why not use a load that can be accommodated by 1 W resistors, for 7 V.
        125 mA should be OK for 7 V... 8 V would give 1 W
        11 mm body length for the RSF1 resistor; assume PE resistors are close to that; 12.5 mm lead spacing
        4 mm body diameter - assume 6.35 mm / .25" pitch
    -> Done, this will be a fun board.
        For each one, order:
        8x 100 ohm, 8x 180 ohm (5 W)
        8x 56 ohm, 4x 39 ohm, 4x 27 ohm (1 W)
        8x 4x2 male 0.1" header
        2x 27x1 male 0.1" header

    
[Re-check schematics - both boards]
Power load: OK
Module adapter: OK
Isolator
    Sheet 1 OK
    Sheet 2 OK
    Sheet 3 OK
    Sheet 4 OK
    Sheet 5 OK
    Sheet 6 OK
-> OK

4.  Gerber generation
Isolator: done, checked in EasyEDA

5.  PCB ordering
Done

6.  Component ordering
That's a project for tomorrow.  Parts lists have been exported.

Done for the day.  Todo:
-   Component ordering (note: include hardware like standoffs)
-   Start AKM 8 ch DAC/ADC designs

8/2/2017
--------
Putting together component orders
PE: $45 for resistors?  Wow...
    Ebay has 10-packs of 5 W resistors for $3, which would save a few dollars.
    Wow, Digikey is cheaper? $0.33 each at qty 30 for the 5 W resistors.
-> Good to know, just get resistors from DK

Got the Eagle exported parts lists merged into one spreadsheet.
Need to clean up which parts are needed for which isolator stuffing option
Then: Python script to compute required quantity of each part type for a "basket" of boards
    2 module adapters
    4 power loads
    2 isolator baseboards
        1 bypass option
        1 isolator option
        1 Jung option
        1 LM317 option
Say, I could probably just process the exported parts list myself... oh well.
    That would require extra effort to deal with variants based on part indices.
    
Then: identify suppliers and order
    I have a feeling headers are going to kill me.  16x 27 pin female headers?

8/3/2017
--------
Tracked down parts suppliers.
What to do about headers?
    They could get expensive.
    Need 16x 27-pin female header, for isolator module sockets.
    Can get these from Samtec at $1.52 - DK is $2.10 (difference: $9.25)
    
8/4/2017
--------
Parts ordering:
    27 pin female headers: direct from Samtec, $24
    LME49710: Mouser, $13
    Passives and a few chips: Digikey, $105 + tax/shipping
    Fancy chips: Arrow, $51
    Standoffs/screws: Ebay, $31

Mechanical stuff:
    Let's count up the hardware.  Just standoffs for now, can get screws anywhere.
    PSU: 
        4 standoffs. (already have, with #4-40 screws)
    Isolator: 
        6 main standoffs
        16 standoffs under modules
        3 clamps to heat spreader
        Total = 26 standoffs + 20 that go on top = ~50 per assembly
        4 standoffs under clock and carrier boards
    Standoff height must match heat spreader and D2PAK power device height.
        Earlier meas. of D2PAK = 0.182"
        Vishay says 0.16 to 0.19, Onsemi says 0.17 to 0.18
        Figure 0.18 + 0.25 bar = 0.43" = 7/16, or 11 mm
        10 mm is a common size, but that's too small
            -> unless, put a washer under each one 
            -> unless, you find a supplier for 11mm standoffs on Ebay
    Securing modules:
        SSA height will be .215 (insertion depth up to .130)
        Male header plastic height will be .098 (note: post length .230, so sticks out an extra .100?)
        Stacked height expected to be .313 = 5/16" = about 8 mm
    So, can get another set of standoffs that are 8 mm long, and short screws
    Also, I need female headers for the clock and carrier boards.  Oops.
        -> Just get extra single-row headers and parallel them for same height
        OR, order more from Samtec: SSW series is a std female header
            $1.680 for the 27x1 one... should have just gotten that, oh well
            Height over PCB = 0.335, which means 0.433 = 7/16", with insertion depth up to .250
        For standoffs, should assume taller height.
            With SSW, 0.433 PCB spacing = 11 mm
            With SSA, and 0.230 long male pins at 11 mm spacing, insertion depth will be 0.120 which is fine
        -> Just get a shit ton of 11 mm spacers.
    Spacer size: probably should do M2.5 instead of M3, since the plated holes are about .118 ID
        which is the same size as an M3 screw, which is supposed to have 3.2mm = .126
        M2.5 screw is .098 dia with .104-.110 recommended hole dia
        vs. 4-40 screw which is .116-.129 hole dia
        So why aren't there 4-40 spacers?  Not used in China, I guess.
    Confirmed: Al bar + D2PAK device thickness = .432 = 11 mm
    Bought both M3 and M2.5 screws/spacers (qty 50 each) so I can try both.   $12.54 for M3 and $18.45 for M2.5.

Also, I'm going to need a lot of RCA connectors and cables when I do the 8 channel AKM modules.
    Monoprice has 2m RCA stereo cables for $.87 each: https://www.monoprice.com/Product?p_id=659
    PE has stereo RCA jacks (typical solder lug) for $1.95/pr: 090-278
    or buyout PCB mount jacks $.68 each: 099-003
    Digikey: RA RCA jacks are $.73 - CP-1402-ND and CP-1401-ND
    Could make a cheap PCB that just has tons of connectors on it.  (in which case it would be easier to have a vertical RCA)
    Anyway, deal with this later
    Ebay: $11 for 10pr of chassis mount jacks http://www.ebay.com/itm/20-Pcs-24K-Gold-Plated-RCA-Female-Chassis-Panel-Mount-Jack-Socket-Connector-/282590956304?hash=item41cbbbcb10:g:bb0AAOSwvT5ZfDQx

    Already have cheap 3x2 connectors (6) -- this will work for a cheesy test
    
That raises the questions of what the build configurations/plan will be.
    Initial isolator boards: 2
        Isolator A: LM317 regs and bypassed isolators
        Isolator B: Jung regs and ADUM isolators
    Initial module adapter: 2
        Used to test v1 DAC2/ADC2 and DAC8/ADC8 boards

Desired end state:
    Complete low cost build (Ministreamer, 2 channel DAC without isolation) in Pesante chassis
        This is just to make a point--not sure I would use it.
        Should probably have Rpi/USBstreamer/DAC8 to be useful as digital XO/streaming server.  Cost would be around $400.
            Or is there a suitable FPGA cheaper than USB streamer?
            Also, DIYINHK has a USBstreamer competitor: http://www.diyinhk.com/shop/audio-kits/101-xmos-multichannel-high-quality-usb-tofrom-i2sdsd-spdif-pcb.html
        Give it to Mike, maybe.
    Complete high end build (RPi/FPGA, isolators, Jung, ADC2 + 2x DAC2 + DAC8--2 in, 12 out) in Slimline chassis
    Testing build in wood protochassis
        Use for: developing Bluetooth/SPDIF, modules; debugging

Steps:
    Update FPGA design for v2 isolator (constraints, 2-level serdes, etc.)
    Assemble isolator A and module adapters
    Test/debug isolator A with v1 modules in wooden proto chassis
    Assemble isolator B and test/debug in wooden proto chassis
    Build v2 DAC8/ADC8 modules; using isolator B, debug full 16 channel I/O performance
    Build v2 DAC2/ADC2 modules
    Build Bluetooth/SPDIF input option (prototype, then revise carrier board)
    Assemble Slimline chassis with heat spreader and chassis divider
    Test regulators under load
    
When I want to make a wider heat spreader: see https://www.remingtonindustries.com/raw-materials/aluminum-flat-bar-1-4-x-2-1-2-6061-general-purpose-plate-12-length-t6511-mill-stock/

For modules - AKM parts to use
    DAC2    AK4490 (SNR 120, THD 112) DK 974-1060-1-ND $5.08
    DAC8    AK4458 (SNR 115, THD 107) DK 974-1082-1-ND $5.97
    ADC2    AK5572 (SNR 121, THD 112) DK 974-1116-1-ND $8.29
    ADC8    AK5558 (SNR 115, THD 106) DK 974-1128-1-ND $9.09
    Got the datasheets.  May as well design/order the 4 boards together.
    Feasible to have diff I/O on all boards?
    Sure, why not?  But 8 ch boards will use multipin headers.
    Seems pretty straightforward.  Let's make some footprints.
    
Let's make some footprints
    AK5558 is 64 QFN.  Pads are .25 wide .4 long .5 pitch.  package is 9 mm square.  exposed pad 6.15 mm square.
    Let's give ourselves .1 mm on inside and .3 mm on outside for solder adhering.
    X: -4.5 - .3 = -4.8 to -4.5 + .4 + .1 = -4
    
Let's make some boards.
    AK4490 config: Each output (p/n) swings +/- 1.4 V which is 1 V RMS.  Rated SNR is 120 dB A-weighted.  So let's assume 10k BW; 10 nV/rtHz.  Amplifying this will amplify the noise.  But the standard is 2 V... and feedback gets harder for ADA4899-1.
    Stick with unity gain.
    
    If we have no gain, we'll get 1 V SE or 2 V diff.
    Load capacitance (for op amp): coax cable seems to be 100 pf/m.  Assume 1 nF max.
    10 ohm series res. + 1 nF cap. gives 16 MHz zero which is fine.

ADA4899-1 quiescent current is 15 mA.  We have 4.
    Assume 10 mA load current, regs need to supply 100 mA at +/- 5 V.
    The ADP7142/7182 will be OK.  Just need to get footprints (annoying).

Notes on connectivity
    AGND 3
    AP22VU 1
    AN22VU 1
    A7VU 1
    D7VU 1
    D3V3 1
    A5V 1
    AP15V 1
    AN15V 1
    DGND 1
    -> Adds up to 12.  We're good.
    
Got DAC board done.  Dinner break then ADC2.

ADC2: architecture decision
    What input structure to use?  I want something that can withstand 2 V RMS single-ended.
    i.e. input is from -2.8 to +2.8
    output is from 1.1 to 3.9 V
    ADA4932-2 would be nice.  $9, and seems to hold up with diff output swing up to 9 V (+/- 2.25 each side)...
    Not quite enough swing.  Specs say within 1.2 V of the rail.
    Of course, we could just shrink the gain a tiny bit... -1 dB is enough to prevent ADA4932 from clipping with 2 V RMS SE or diff input
        ADC performance is specified out to -1 dB anyway.
        How's the noise?  Depends on the resistors.  With 1k resistors, 11 nV/rtHz diff.
        AK5572 input range is 2 V RMS diff. (3.9/1.1 to 1.1/3.9 = +/- 2.8 V = 5.6 Vpp)
        and its claimed SNR is 121 dB A-weighted, which is about 10k Hz. -> 1.78 uV diff. -> 17.8 nV/rtHz.
        They recommend NE5534 with 3.3k resistors (620 in the feedback).  Aren't those resistors a bit big?
            NE5534: 3.5 nV/rtHz
        OK, so 11 nV isn't too bad, but 1k is a tough load for the source.  Desire 10k+.
            -> Add op amp buffers powered by +/- 15 V?
        That takes away a lot of the benefits.
        But let's see if a good quad op amp is available.
        ADA4004-4 (SOIC or LFCSP) seems OK, but probably not that linear.  See what's speced for linearity.
        -> Just try it.
        
Almost got draft of ADC2 done also, not quite.  Need sleep.


8/7/2017
--------
More layout.  Airwire countdown:
    AGND 3
    AN15V AP15V D3V3 A5V D7VU A7VU AP22VU AN22VU - 1 each
    This should be 11, but I have 14.
    Fixed, just some DGND junk.

OK, time for bed.  Clean up silkscreen, DRC tomorrow and it'll be ready for (later) review.

8/8/2017
--------
Got boards.
    Visual inspection is good, except for some nonuniformity of soldermask on vias.  And some extra solder on big mounting holes?
    Mechanically, looks like it will fit but the clock board comes close to front edge of chassis, so might have to shift rearward.
    Probing with multimeter:
        Supplies and grounds appear to be hooked up right, no shorts.
        Data signals are getting across to the isolators, and from isolators to carrier connector.
    Should just assemble and see.

To do before boards assembly (Wednesday?)
1.  Finish ADC2 layout (initial version, pre-review) -- done
2.  Prepare FPGA design

Got started on FPGA design (including constraints), but need to finish combing through the code and updating everything.
    Especially hwcon and hwflag stuff.
    Need to get simulation working - add better test code when possible (not now).

8/12/2017
---------
Most parts are here, starting isolator assembly.
2 boards, one is low cost, one is full feature.
Assemble all common parts and then all needed for low cost board.


Notes from assembly:
    Got 0805 caps instead of 1206 for 1u value.  Used for C35* and, on Jung board, C361/362.  Will need substitutes for C363, C364, C371. -> Used 0.1u 1206
    1k 0603 resistors not needed, Jung only?  R301 R302 R353 R363 R382
    Good to check supply shorts.. found one from -15 to gnd on Jung board (32 ohm).  Reason: bad soldering around C362, fixed.
    My solder syringe sucks.  Need a new one.
    Have some extra solder paste I'm guessing; should reflow chips with hot air.
    On Jung board, lifted trace near U116 moved - HWCON probably will be broken
        May need to remove chip to fix with reflow
    Installed regs and big caps only on LM317 board.  Headers too - only go ahead with those if things look good.
    Test point pads had soldermask over them - rub out with fiberglass pen

Bypass/LM317 board is ready for testing 1 module.
Time to assemble the module adapters.

It is hilariously hard to insert/remove a module.
    Find looser headers?

Didn't do pwrload boards yet.  Nothing to test.

Should be able to to power supply and bring up of bypass/LM317 board tomorrow.

8/13/2017
---------
Initial bringup - isolator with bypass/LM317
    Power supply connections checked out.  No shorts, just big caps.
    Voltages:   Initial     +Adapter
        D7VU    7.56        7.13
        A7VU    8.22        7.44
        AP22VU  22.9        22.8
        AN22VU  -22.9       -22.8
        D3V3    3.37        3.36
        A5V     5.11        5.11
        AP15V   15.28       15.27
        AN15V   -15.13      -15.13
    All OK, though digital supply being lower is somewhat surprising.  It does have some small loads though.
    +/- 22 V supply still discharges slowly (not dangerously; couple of minutes to get under 5 V).
    Local 3.3 V supply on adapter: 0.52 Analog, 3.31 Digital
    Serdes supply on isolator: 0.53 (digital)
        Maybe I hooked up the regulators wrong...
        NCP1117: GND, OUT, IN (tab is OUT)
        UA78MXX: IN, GND, OUT (tab is GND)
        Yep.... ok, definitely need to order some 78M33s.  (Part: UA78M33CKVURG3 , $.56 on Arrow)
        Thank goodness for whatever protection is in the NCP1117.
    Should be able to test clocking regardless.
    With clock board, D7VU is down to 6.41 and A7VU to 7.35.
        Adding module adapter dropped it by 430 mV
        Adding clock board dropped it by 720 mV
    Transformer is rated 2.5 A from each secondary, 5 V AC
        1.65 V clock output observed at the oscillator but not on adapter board.
        Differential clock shows continuity.  Will need to examine signals more on adapter.
    Another screw up: Clock receiver for FPGA is powered by D3V3ISO, meaning the 2nd regulator is necessary.
    
    Input levels for AD9515 look OK but clock output is at 0 V.
    Try other adapter board?    Why not.
        This one does have a clock output.
        So, investigate the soldering on the first one.
        D7VU is  6.59 on this one, also (180 mV higher).
        

With no isolators, should be able to bring up carrier if the MCLK supply issue is fixed.
    Have any DPAK UA78M33 lying around?
    The one I used on the clock board was SOT223-4 not DPAK.
    The ones I used on the regtest board were 5.0 not 3.3 V.
    So, definitely need to buy more before I can do anything, but:
        Jury rig the supplies (D3V3SD, D3V3ISO) to 3.3 V regulated?
        (After removing the NCP1117s.)
    On the plus side, original DAC2 and ADC2 don't use A3V3 supply, so I don't need to worry about the reg on the adapter yet.

It would be nice if I could screw the board down... looking forward to those standoffs.
    
Carrier fits in... overall stacking height = about 2.625
    Should be able to try it and probe signals at the adapter, since it has its own supply (with RPi)
    Well, SCLK is already getting to the module... from the previous FPGA design
    Shouldn't need MCLK for anything to do with SPI.
    But chip select won't work because serdes is out.
    Oh well, check data?

End of day notes:
Ordered regs, but they won't be here for a while.  Mean time, get SPI working and then hack around regulator issues to get I2S working.    
In the process of debugging SPI.
    SCLK looks OK.  Data is getting in.  Need to figure out why it isn't getting to slot controller control FIFO (then to SPI master).
    Continue ILA debugging next.

8/15/2017
---------
Moved VM to HDD for now after SSD ran out of space.  New SSD on the way.

SPI issue is reproducible in simulation.  If MCLK isn't running then the slots don't come out of reset.
    I guess that needs to be fixed?
    -> Yes.  Just hack the supplies to make MCLK work and then things should work.  Or at least you can debug with ILA.

8/16/2017
---------
Did a few things:
    New UA78M33 regulators arrived (though oddly, someone had torn the packaging apart and left the tape of 10 chips untouched on my front porch).
    Removed NCP1117 regulators, replaced them with UA78M33
    Added reg for D3V3SD on bypass board (needed for MCLKF)
    Reflowed AD9515 on the module adapter that wasn't driving clock properly

So tomorrow I can try things out (SPI) and debug with Logicport/ILA.


8/19/2017
---------
Power up
    A5V     5.11
    A7VU    8.22
    AP22VU  23.2
    AN22VU  -23.2
    AP15V   15.28
    AN15V   -15.13
    D7VU    6.79
    D3V3    3.36
    Clock: running  - CMCLK appears OK, at least to multimeter
    A3V3 on module adapter: 3.27

SPI still doesn't work, at least according to ILA.
    Slots don't appear to be in reset
    cs_n isn't getting serialized.
    ss_cycle_counter appears to increment, but that's just to create the right pulse width on cs_n out
    bit_counter not monitored, but probably not incrementing
    With lots of ILA probing: data_ser_next looks OK but then srclk gets there before srclk, and it gets reset
    

Also, I've been overloading the input of the ADM7154 all this time.  Max input is 5.5 V.
    Need to update PCB designs with a prereg to 5.0 V.
    78M05 of any shape would be fine... max load = 600 mA
    Absolute max input is 7 V.  Hmm... most likely I'm triggering the ESD protection diodes.

Upgrade to Vivado 2017.2....
    Sim doesn't work the way it used to.  Why?
    Changing FX2 model did the trick.  Weird.
    I know there were some oddities in the simulation...
    This may have been a bad idea.  JTAG issues too.  Had to switch VMware to USB 3.0...
    Can get debug core to appear when I program the device via FWLoader rather than JTAG
    SPI test just hangs.  Can't tell what is going on.
    -> Wait no.. it just takes a really long time
    Comment out resetDevice and we're good.

Finally, SPI works.
What about I2S?
    Doesn't look like it.  All zeros.
    Pinout, constraints?
    Poking with multimeter: RESET_N, SRCLK2, MCLK look ok
    Maybe the signal names within da_platform didn't change yet (still hardcoded for DSD1792).
    Easy enough to fix that.  (Re-synthesize...)
    While that works... let's bring up a DAC2 module, make sure nothing explodes.
        11.2896 MHz Tent XO still works.
        Power supplies show nothing broken although 22V is now 20.9.
        With no signal, DAC output spectrum via ARTA is around -146 at mid/high freq (44.1k/64k/Hanning)
        Some spurs which may be related to the sound card.
    With a signal... doesn't look clean, probably some glitches (bad I2S connections?)
        Try replacing the jumper wires.
        Try pulling out Logicport.
        Oops, now we have a new problem: -22 unreg rail is broken (now at +5)
        Shorted?  Blow a diode with inrush?  Or maybe a resistor?
            It was when I heard a sharp click when flipping the power switch.
            I'm pretty sure one of the resistors is open, and I didn't buy any extras.  (A109908CT-ND)
            Note: PSU layout should probably have more copper for cooling them.
            Inrush current can be up to ... 40 A.
            Good reason to get an inrush current limiter... though they're like $2 each.
            Also, I bought some 0.5 resistors for the regtest boards.  Look for those.  (1 ohm was used)
        But something else probably got hit too.  Seeing 93 ohms to ground from -22 V, on PSU board.
        Dammit.  Cap?
            Yes, 10uF tantalum.  Have more, I think...
            Rated 35 V.
            Fine, leave it off until we have more.
            And get 50 V rated ceramic caps next time.
        Anyway, now I can see the signal without the Logicport around.  And it is bad.
            -> need more cap on I2S lines?
            Try setting drive to 4 mA. (Options are 4/8/12/16)  .  There is also a slew attribute (fast/slow).
            Wow, that cleaned it up right away.
            More THD than I expected (0.0085 = -80 dB or so?)
            Try full scale. -> Looks like .0018/.0020 = -95 dB / -94 
            So what's up with the lower amplitudes?
                -40 dB level, THD = 0.1% or so (-60 dB)
                That's not so great.  Oh well, should just listen to it.

Say, does CLKSEL work?
    Yes.  I set it to 0, it plays at 2.176 kHz = 96/44.1.
    How about 192 kHz?
        Can't program SPI registers.  Let's make DRIVE=4 only for the slot data... in case that was it.
        -> Yep, now SPI is reliable.
        But still, SPI registers won't change the sample rate.  You have to change BCK.
        This is currently hardcoded in the design.  Oops.  Well, that's the next upgrade.  Until then it's 44.1 or 96 kHz.
        And when I use the Crystek 22.5792, it'll be 88.2 or 96 kHz.
        
        
Planning time.
    Seems that DAC2 is going to work OK with the bypass/LM317 board.
    Next steps (options)
        Bring up ADC2 and test loopback, same board
        Bring up iso/Jung board and try DAC2
        Test aux features like HWCON / HWFLAG
        Mount board in chassis and put it in the audio system
            Note: Wood chassis won't ever have the heat spreader, so it's OK if it's up high
    My desired course of action is
        Add ADC2, get it working (note: includes adding more headers, and debugging 2nd module adapter)
        Mount up and listen to the DAC part
        Meanwhile, solder iso/Jung stuff on the other board.

2nd module adapter: still no clock out.  How to diagnose?
    Supply is OK.  Input clocks are OK.
    Can see ESD diodes to ground on the input pins, but not the output pin.
    Poke the output pin itself, and I get a reading, but nothing on the resistor.  So, focus on that pin.
    A dab of extra solder paste fixed it.
    
Time to try ADC2.
    S0 = LRCK S1 = BCK S2 = Data
    It does something.  But LRCK isn't what you'd expect.
    DIR = 0, so it knows it's an ADC
    How's HWCON working?
        Might be that's part of the problem - ADC2 board has its own deserializer for HWCON.
        The module adapter shows what I'm expecting the module to do: shift in with SRCLK and load with SRCLK2.
        But on the ADC2 board, it's shifting in with SCLK and loading with SRCLK. That will not do the right thing.
        Try setting HWCON to 0 to get something stable.
            -> Yes, clean LRCK, but no DATA.
        What can I do with HWCON?
            Set all slots to same thing?  No, doesn't work.
        As a last ditch effort, let's try using it with HWCON = 0.  Just to feel good.
        Seems to work reliably, but wrong frequency and poor analog performance.
        Freq = 2.76 kHz.  Oh, maybe it needs the other clock.
        My clock frequencies aren't what I thought they were?
            Logicport says 12.288 / 5.644 MHz.  1/2 of expected.
    Maybe I should put in DAC2 as well to check this.
    Try SPI?  There is no SPI.
    I guess the main question is why the analog performance is so bad.
    I think I just have shitty I2S connectivity.  Flying leads are no good (unless you can limit the drive...)
    So, give up on ADC2 for now.

Let's mount this shit.
    Got it.  In stereo, initial test was free of obvious problems.

Plan for tomorrow: assemble other board (Jung/iso)
    Test Jung regs first before soldering $100 worth of isolators.
    Then transfer boards over and see if it sounds/performs any different.
    And while you're at it, test HWCON/HWFLAG on the two adapters I have.

8/20/2017
---------
Soldered Jung/iso board.  Didn't follow my earlier advice about testing.
Bringup: (no boards installed) all voltages good.
    Clock seems OK.
    With module adapter: SE clock OK.  No change in voltages.
    With DAC installed: SPI seems to work but DIRCHAN are all 0, so we can't send I2S data
    
    Let's pull out the Logicport.
        DIR at the board = 1, chan = 0
        At other DIR pins (modules 1-3): also 1 (due to pull ups)
        DIRCHAN (isolated domain) - hard to probe
        SCLK, SRCLK, SRCLK2 reaching modules all look OK
        Suspect bad soldering around those chips
        Oh, let's look at CDIRCHAN.  -- pretty sure it's just low
        So, to really debug, need to look at the dirchan serializer.  (Bottom of PCB)
        .55 V on pin 1 (SRCLK) of U111?
        -> that pin has no solder.  Fixed.
    Try with FPGA before flipping everything over again.
    Yep, now we think there are DACs.
    It plays.  Same distortion as before.
    -> Remount everything...

Back up and running.  Next:
    Review/order new ADC2/DAC2 boards
        At the very least, need prereg for ADM7154.
        But this was the main goal for "before vacation" (besides isolator/chassis bringup)
    Try getting rid of startup pop-  was it select_clock()?
    And, stretch goal would be Bluetooth
    Think about background noise/hum, does it just need shielding?
    Determine power dissipation, why are transformers so hot?
    Mount connectors (DC power, audio out)
    Try ADC2 on new iso board, see if results are any better?
    
Also, looking ahead to connectors:
    4x2 RCA jack is  	SC1537-ND  (make a small PCB with that and connector for ribbon cable?) - $3.89
    Width of that is 2.165" so there is room.  Height = 1.063"
    My XLR connectors mounting panel are about 1" x 1.25"
    Indiv RCAs are going to need .75" x .75"
    Should probably think more about twinaxial cable/connectors for diff IOs
        DAC2/ADC2 will have coax/twinax cable soldered directly to indiv. connectors
    As it stands, for each module I can fit either:
        4x2 RCA for DAC8/ADC8
        2 XLR and 2 RCA for DAC2/ADC2
    Can't do both.  (Not enough room)
    -> Chassis holes will depend on the desired module configuration

8/21/2017
---------
First, some listening notes:
    Only listened to bypass/LM317 version briefly.
        Good dynamics, especially in the bass. Impressively distinct beats.
        Maybe a little grainy?
    Iso/Jung version:
        More liquid (this came to mind with crooning electric guitars).  Treble is clean.
            (Except maybe Better than Ezra treble, grainier than I remember?)
            Maybe a little better in this respect than the v1 version?
        Bass doesn't seem to stand with out as much crispness, but can still be fairly intense.  Clean.
        Sonichrome sounded really rough at 90+ dB, but not that fatiguing.
        Upper midrange slightly nasal/congested, not painful but still not right.
            Maybe the speakers need to break in again, they haven't been used like this in a while.
            Or maybe this is the way they sound. :)
        Overall downward tilted tonal balance, it seemed, on everything but Sonichrome.
            Will need to listen more to determine whether any clarity was lost.

BTW, the startup pop is fixed.  Was resetting on every file.
    Now have 1 startup script that does the reset and sets clock freq, when MPD is started.
    There is still the issue of preventing a pop when changing the clock freq.

Updating DAC2/ADC2
    Easy enough to stick a DPAK 3-term reg in there to protect the ADM7154

8/22/2017
---------
Need to do some planning to figure out what boards to order and when.
    Goal is to get ALL boards done, in other words complete electrically, by end of Sept.
    Enclosure and firmware/software work can then happen in Oct.
    Concerned that DAC/ADC2 will take too long to get useful feedback before ordering DAC/ADC8.
    
8/23/2017
----------
Attenuator plan:
    1 Diff. attenuator per channel with 4 SPST switches
    Parts: Try DG9424EDQ-T1-GE3CT-ND .  ADG1613 is drop in replacement (16 TSSOP).
    
Started drawing on schematic:  To do:
    Finish hooking up, make readable
    Add HWCON deserializer
    Test HWCON (and HWFLAG?) on existing board
    Figure out layout
    Check it over and order boards

Finishing this up and ordering is only remaining goal for this week.

Did some layout work.
Note: cap size B for op amps can be larger than 10 uF recommended in datasheet
    This may be necessary for low frequency filtering... but maybe not, who knows.
    Imagine: 1 V RMS (+/- 1.4 V) into 100 ohm.  14 mA peak current.  Will get dumped into ground.
    The problem is the ripple currents.
    P15085CT-ND 68 uf 10 V has the lowest ESR of any cap that size.

Think I got it done.... 12:07 am.  Tomorrow:
- Check over boards especially vs. DAC/ADC datasheet
- Test HWCON on iso platform
And Friday, order boards.


8/24/2017
----------
First some listening.
    Seems clean and relatively relaxed in the midrange, with Basia Bulat or Alison Krauss at 75--80 dB.
    Tone is somewhat dark, but I'm listening with the fan on.  I bet the detail's still there, check by listening in quiet room.
    On the compressed recordings you can tell they're compressed; doesn't seem to extract more impact like some setups.
    DMB Remember Two Things sounds great, even though you can tell it's an amateur recording.

HWCON testing:
    Off the bat, get all zeros.
    Logicport to investigate.
    SRCLK and SRCLK2 look normal, but my commands aren't making HWCON move from 0.
    Going to start synthesizing with ILA and meanwhile probe around on board.
    All looks good inside, slot_hwcon is getting set according to SW and iso.hwcon looks like a serial bitstream.
    Time to probe HW, what does CHWCON look like?
        DC value definitely responds to SW commands.
    OK, time to figure out bottom side probing.
    DC of both CHWCON / HWCON is about 0.61 steady state
        SRCLK at deser = 3.06
        Definitely some missing solder on the power pin of the deser.
        Pins 4 and 5 appear shorted.  (S2_HWCON / S3_HWCON)
        Fixed power to deser.  DC on outputs: 1.2 V for slots 2,3, 0.0 V for 0,1
        DC at in is still 0.61, would expect more.  Try to get JTAG in there for ILA?  Or Logicport.
    Now, the HWCON register per-slot isn't being updated. ???
        No clock?  Solved that problem.
        At end of test with all slots 0xFF, modules 2/3 have 3.3 V and 0/1 have 0 V
    Let's reflow this shit.
    Now HWCON looks good going into the module, that means the deser on the iso board is working.
    But the indiv outputs on the module adapter are all low.
        Nothing is ever easy...
    Inspect solder?
        Reflowed, no change.
    Run jumper wires to module adapter.
        Wait a minute.  SRCLK and SRCLK2 are swapped.
        That sucks.  Looks like isolator and DAC/ADC2 are OK.
        Can swap wires on the headers now...
        Actually, never mind, it's just the label on the module adapter that's messed up.   Ordering is OK.
            Probe voltages...
            SRCLK 3.06 at debug header, 0.12 at deser pin -> investigate
                Resoldered the pin, didn't fix it.
                2nd time is the charm.  Ugh.
                
            SRCLK2 3.24 at header, 3.24 at reg pin
        OK, now Logicport it up again.
            Getting there.
            Bit 5 is bad.  When all 8 bits are high, it's high.  But 0x20 doesn't work.
            -> Fixed.  All 8 bits behave as expected.
In summary: My soldering sucks.  But HWCON works.
    11:56 pm
    
Tomorrow: review and order boards I guess

8/25/2017
---------
Late start.
Reviewed ADC2 board, seems clean.  Generated Gerbers.
Same for DAC2.  Ordered boards.  $42 with DHL shipping.
    There was a small issue on bottom silkscreen, didn't bother fixing.
    
Next: order parts.  And relax.
    Do this Sat morning.
    Build 2 boards.
    
8/26/2017
---------
Sorted through parts - had quite a few already
Placed parts orders
    Digikey $52 - passives, AKM, other chips
    Arrow   $56 - ADI parts
    Digikey $26 - ADA4899-1 which Arrow didn't have
-> Cost of building these boards is around $180.

Time for vacation...?

When I get back, todo is:
    Build/test DAC2 and ADC2 v2 boards 
        (with RCA/XLR connectors, but not mounted to chassis because I want to leave room for the 16/16-channel setup...)
    If that goes well, design/order DAC8, ADC8 and RCA connector boards
    And the next steps are
        a) chassis integration
        b) Bluetooth/SPDIF


9/5/2017
--------
Back from vacation.  Notes from memory:
For DAC8, going to use AK4458 datasheet suggested output topology.  SE output only.
    Main

Both ADC/DAC8 will have low cost deserializer, but with a decent regulator (ADM7160?)

For ADC8, TI has a fully diff amp with 4 amps/pkg.  Cheaper than ADI.
    Also, OPA1604 looks like a good quad op amp.
    Still need op amps in front to increase input impedance

ADC8 may actually end up better quality than ADC2.  We'll see
    Esp with the channel summing feature - need jumpers at input to support this.
    SE input only.

OK, time to assemble DAC/ADC2.
    Hot air first.
    Ugh.  DAC fucked up.
    ADC was a breeze by comparison.

9/20/2017
---------
After much delay due to traveling and being tired, it's time to resume DAC2/ADC2 assembly.
Got all ICs and some passives on.  No obvious supply shorts created.

9/21/2017
---------
Assembly continued. Why am I missing parts?
ADC: R1, R3, R7-10, R12, R13, R21, R26, 
DAC: R1, R2, R3, R9, R10, R30-35
Values: 22, 1, 100, 825, 1k
All of which I should already have.  dig around.
Found.  Probably just fell out of the box.

2200u ref decoupling caps can wiggle after soldering - consider hot glue

Next: testing.

9/23/2017
---------
Installed DAC2, ADC2 in iso/Jung board.
Bring up: 
    - High pitched sound (ridiculous oscillation + microphonics?).  What the heck?
        Note: probing the clock output (AD9515) on ADC2 board changes the sound.  So may be related to that supply.
        LF50 reg outputs have 0.125 V AC on them?  (input to ADM7154)
            1u cap on input, 10u on output (both ceramic)
            LF50 datasheet asks for a 2.2 uF (min.) electrolytic cap.  Probably wants some ESR.
            Datasheet mentions ESR from 0.1 to 10 ohm.
            10u 1206 cap datasheet shows ESR of 6 mOhm.  Hmm, maybe the reg is oscillating.
            How to solve?
            Stick a lytic on there?
            -> Yes. Fixed.  There was 120 mV AC on each LF50 output, now closer to 0.
            
        
    - Supply voltages normal
        Local regs on both boards look fine (+/- 5 for amps, +5/+3.3 for clock recv)
    - Clocks: 1.6 V DC at AD9515 output on both modules.
    - SPI: Can't read DAC SPI regs--should investigate
        Also try reading ADC SPI regs
        There was a Python code bug.
        OK, I can read registers, but they're all 0.  SPI format should be?
            16 bit transaction.  First byte is 
                [7:6] Chip address
                [5] Read/write
                [4:0] Address
            Second byte is data.
        Oops. AK4490 and AK5572 are write only SPI.  Can't read them.
        So, should probably get some connectors wired up.  See what the AK4490 puts out.

        
    - I2S: FPGA delivers reasonable looking I2S for DAC. (at least when I look at DC)
        BCK input seems to draw a lot of current.
            DC voltage at module input is 1.1 V, 0.8 on other side of 50 ohm resistor
            Other modules: 1.65 V
            Diodes/short at input?
                Same 1.1 V drop to ground on all I2S lines (AK4490 + AK5572) - might be isolators
            What's on carrier side?
                1.65 V, i.e. 50%
            DC current
                1.143 to 0.807 over 50 ohm -> 6.7 mA at DC
        Also, 1.2 V at D0 when I'd expect 0s.  Significant DC current there also.
            LRCK appears fine.
            
        Why does it seem the DAC is driving currents out of its I2S inputs?
            Suspiciously similar drop across 50 ohm res. for BCK (.335) and D0 (-.335)
        They are all inputs in all modes.  Doesn't make sense.
        Anything that could be wrong with the isolator?
            Check DC levels with the module removed, I guess.
        
        Other DAC pins:
            No VREF current, VREF pins at 5 V
            VCML = 0.15 V VCMR = 0 V
            VOUTL = 0.45 V VOUTR = 5.0 V
        I bet the DAC is FUBARed.  Too much soldering.
        Try reflowing it, just to be sure.
        Nope, bent the pins.  Got to be more careful.
        
    - DAC analog out: lots of junk there at idle.
        LPF op amps have 0.56 V at input and output. Why?
        With disable pin floating, ADA4899-1 has typ. -6 uA of input bias current.  Meaning it sends 6 uA to the input.
        And I have a 100k load. -> 0.6 V
        -> Need to connect disable pin to +Vs.  How?
            tiny wire wrap wire?
            Also add resistor to V- to draw off current (but exact value not known, could be very large)
            Definitely a PCB error.
        Alt. for now, decrease DC resistance. 
            1 uF + 100k -> 1.6 Hz
            1 uF + 10k -> 16 Hz, which is probably fine.  And that will reduce the offset to 60 mV.

Outcome of all this: ordered more AK4490 chips.  Move on to testing AK5572, which seems to have a better chance of success.

Then did some AK5572 testing.
    Wow, got some valid samples right off the bat. (Driving input differentially, through isolation transformer.)
    Lots of 60 Hz and harmonics, but no major THD at 1k/-20 dB.
    Try to configure registers for 44k sampling.
    Nothing I do (writing 0x22) seems to have an effect on SPI.
    DC levels?
        Input: 0
        Opamp out: 0.
        Diff amp out: 2.41
        ADC in: 2.41
    AC levels?
        Input: .112
        Opamp out: .108
        Diff amp out: .097
        ADC in: .097
    Crank it up a bit.  (Gen at -20, speaker vol at max.)
        No difference.  Set gen to -0.
        AC is now 0.946 / 0.955.  See what samples look like.
        Crazy clipped. -> Not actually clipping, just numerical format.
        Ideally I could switch to I2S... this is because it's MSB justified.
        Well, with soundcard gen at -6, I get a clean waveform.  About -95 dB THD.  Lots of 60 Hz though (-65 dB). And a spur at 19k.
        -> Don't know how much of the junk is coming from the sound card.  Will need loopback.
        Note that when I tested with inputs floating, I got a reasonably flat noise floor, no 60 Hz.
        With input floating (100k SE input) RMS = -81 dB.
        Same with input shorted.  What?  Should be lower noise.
            Short P/N to ground separately... same.  -80 dB.  Investigate later.
            
    Main task for now is to figure out why SPI is broken.
    Once DAC is working, can do loopback tests and analyze audio quality
    But wait.  I have a DAC, it's just an older DAC.  (DSD1792)
    Will need to update loopback_test script with code from ztex_test.py
        Or make somekind of multithread capable driver. Not really that hard.


Connectors will need to be added.
    Plan for this enclosure is:
        - Support 8ch SE IO for all 4 modules - drill to pattern of 8 ch connector that I can find on Digikey
        - And for each module also have 2 XLRs.
        - Plus 2 indiv RCAs for 2ch modules SE IO?

Todo:
    DONE    Add connectors to chassis panel (for XLRs, order DAC-ADC-DAC-ADC)
    Figure out why SPI to AK5572 isn't having an effect (e.g. I2S mode, sampling rate control) - Logicport?
    DONE    Get loopback working (DSD1792 to AK5572)
    
9/24/2017
---------
Looking at noise, ADC spec is 112 dB SNDR / 121 dB DR
    ADA4932-2 diff amp config. gives output diff 11 nV/rtHz
    Assuming the ADC has perfect front end filtering, that integrates over 22k Hz to 1.6 uV -> 122 dB
    But if you assume we only have the RC filter on board, F3 = 530k and integrated noise is 7.8 uV -> 108 dB
    So, experiment with that filtering (resistance/capacitance) and see if it impacts noise at all.

Adding connectors.
a)  4x2 RCA array
    Hole dia. = 7/16 = .4375 (connector centering ring dia = 0.394, 10 mm)
    This allows for some slop / drill tolerance.
    Hole spacing = 0.551 vertical, 0.551 horizontal (14 mm)
    -> Array width = 2.165 in, height = 1.063 (but don't mount it right at the bottom, need clearance for PCB)
b) XLR input (female)
    Plate dims (behind panel) = 1.013 x 1.252
    Centering ring dia = about 0.93
    Probably wants a 15/16 hole for exact fit.  But I don't think I can drill that accurately.
c) XLR male
    Same diameter/shape
    Screw holes (#4?) - 15/16 V spacing, 

What a pain, that took like 3 hr.
    And the acrylic split a lot.
    Use aluminum next time, and get a drill preess.

9/25/2017
---------
Starting loopback testing - DSD1792 to AK5572
1.  With no signal - reasonably flat noise floor with a couple humps, no 60 Hz, a little 120 Hz
    RMS = -74.8 dBFS
2.  Time for loopback code.
    With gen level = -20 dB, 1 kHz.  RMS = -17.9, FFT is clean except for noise.  
    No harmonics visible above the noise floor of -100 to -105 dB.
    Some spectral spreading (but we did window it)
    I think some 60 Hz harmonics "grass" are visible.
    Overall, the noise is my main concern.
    Increase the level to clipping... just below clipping is -11.3 dB.
    (6 dB lost to numerical clipping - MSB justified vs. I2S.  should fix that.)
    But still, no visible harmonics.  Noise floor is the main concern.
    Signal ampl = 78.2, noise around -35, so it's better than -110 dB THD.
    Also, setting level to -80 (68.7 less) makes signal ampl 9.5 (68.7 less).  Linear?  So far.
    
Cool.  That was easy.

So, what causes the noise?
    I don't remember the DAC having a noise problem.
    So let's focus on the ADC.
    First, let's get the levels straight.
    At -11.3, AC RMS (differential) is 1.120 according to multimeter.  This makes sense.
    Interestingly, I got some distortion products (2nd and 3rd) and 60 Hz harmonics to come out when I probed.  Try again without probing?
    Maybe it's the EMI environment.  60 Hz harmonics are still there at -17 dB (-95 rel. signal)
    Record for a shorter time and they're gone.  Interesting - interaction with FPGA or something?
        Seems to be true.  Investigate later (but for now, record short clips)
    With noise floor at -115 with 64k FFT, integrated noise is -67 (rel 1.12 V RMS) which is 0.5 mV RMS.
    
Uhh...
    Input buffer?  Op amp has 1.8 nV/rtHz down to 10 Hz.    PSRR starts to roll off at 100 Hz, but noise floor is flat.
    Diff amp?  Total diff output noise was expected to be 10.8 nV/rtHz or 9.5 uV at 500 kHz BW. (Not nearly what I'm seeing.)
    Diff amp oscillating and that crap getting folded back into the audio spectrum?
    How would I tell?
    Multimeter shows a few millivolts on each of the diff amp outputs (after series resistance)
    Noise looks about the same in both channels.
    Should check the power supplies (+/- 5) also
        Hey, what about using the scope?

Todo for Tuesday:
    1) Debug noise (about 500 uV RMS diff) with the help of a scope
    2) Debug SPI - note max CLK is 5 MHz
    3) Collect more measurements if you can
    
    
9/28/2017
---------
Noise debug:
    Hard to see things on the scope, because everywhere I probe, I see an oscillation of about 50 mV p-p at just under 2 MHz.
    Even from AGND on 1 side of the board to the other. (Smaller signal when I probe the same AGND pin the scope lead is attached to.)
    What could be causing that?
    Well, +15 supply has a 175 mV p-p oscillation at that frequency.
    -15 supply is quieter (same as AGND); other supplies have different waveform shapes, but all have smaller noise and no obvious oscillation
    Note that +7 digital supply has a lot of ripple (400 mV p-p?)... By design, I guess?  (Heavy load... consider bumping up cap.)
    
OK, so what could be screwing up the +15 supply?
    a) Bad design
    b) One of the modules
    c) Really big oscillating load current / resonance
    What decoupling do I have?
        - 100 uF in the Jung
        - Smaller caps distributed on the modules

Also, what impact does this have on +/- 5 V supplies used on ADC2?
    They look fine.  In fact, better than the other supplies (local regulation...)

Note that the +15 supply powers ADA4004-4 at a frequency where it has about 20 dB of +PSRR (10 dB of -PSRR).
    So... looks like about +/- 200 mV at that pin. (140 mV RMS)
    Is the op amp causing the oscillation?  Maybe it needs more decoupling.
    But anyway, this would put 14 mV RMS at the output, at 2 MHz, and the diff amp would pass it on.
    Not sure what kind of CM to DM conversion would be taking place.
    -> Try more decoupling.  At the opamp.
    Added 100 uF across the existing 0.1 uF.
    Same oscillation is there, maybe a little smaller (especially at the opamp).
    No major change in noise.   Lowers the LF noise floor of the channel coming from the DAC (good I guess?)
    SMA output of module adapter shows same osc. on 15 V supply, and apparent noise/osc on other supplies.
    So I guess the only good regulator is a local regulator.  Oh well.
    But in the meantime, would 2 MHz junk degrade ADC noise-floor?
        Input clock is 11.2896 MHz.
    Noise doesn't appear correlated between the two channels...
    Try removing other modules. DAC2v1 is easiest.
    -> Actually this helped a bit.  Oscillation is smaller, a few dB less noise.
        Still not low enough to see the noise of 100k resistors (floating vs. shorted input).
        Logical question is what happens when I remove DAC2v2?
    So, with ADC2 the only module installed, the noise appears to have fallen farther. (lb11.wav)
    And maybe I can see the difference between 100k res. and shorted?
        Don't know which channel is which, but one integrates to -79 dBFS and the other is -78.4
        Still pitiful regardless.
    100k res noise would be 40 nV/rtHz SE, 64 nV/rtHz diff, integrated over 40 kHz is 12.8 uV
        And right now 0 dBFS = 1.12 V diff.  So that would be close to -100 dB.
    Nope, just getting terrible noise still.  Around 100 uV, not 500 uV.  Progress.
    Try adding decoupling to reg. supplies?
    This helps by another 0.4 dB?

Other interesting note: noise floor rises above 20 kHz.
    Restricting the bandwidth from 130 to 20k: now the integrated noise is -94 and -89 dBFS
    (dBFS/bin = about -130 and -135)
    Add 41 dB to dBFS/bin to get dbFS over 20k BW
    -89 dBFS = 40 uV.  Not explained by resistors only.
    
9/29/2017
---------
Ideas for further investigation:
-   Turn off SCLK (optionally; user should be able to enable it to get HWFLAG back)
-   Turn off I2S clocks for modules not being used (definitely needs user input; big glitches if starting/stopping an I2S interface)
-   Tie AGND/DGND at isolator board (short ferrite bead)
-   Tie AGND/DGND at ADC2 module
-   Add local decoupling for negative supply (opamp input buffer)
-   Move big decoupling caps around; try removing one at a time and see which supply has the most impact

Added some HDL features and tried them out.
    I2S turn off: before = 93.69 89.17 after = 93.67 89.18 -> not much difference
    SCLK turn off: Actually, seems to be necessary to get clean output with current bitstream.
    MSB justified: doesn't seem to work
        Start of HW experiments: [-93.97952802 -89.29305024]
        Remove +5 cap: [-92.3448468  -88.75339128]
        Replace +5 cap, remove +3.3 cap: [-93.75603106 -89.11390528]
        Replace +3.3 cap, remove -15 cap: [-93.64773623 -89.13332926]
        Replace -15 remove +15: [-92.92768472 -88.84775391]
    Sensitivity to that cap: 
        +5 V: 1.63 dB
        +3.3 V: 0.22 dB
        -15 V: 0.33 dB
        +15 V: 1.05 dB
    Tried adding a wire between AGND/DGND - at module 3 connector, not great, but we'll see
        [-93.44559658 -88.97882576] -> degraded (but repeated runs showed about the same)
    Tried short AGND to DGND, wire on left side of module: [-93.4734368  -88.85719646]
    Tried adding decoupling to -15V at op amp buffer.  No significant difference.
    Soldering big decoupling caps to module.  No significant difference.
    CM vs diff short at input.  No significant difference.  (It was actually shorted.  Good.)
    
Tomorrow: Poke around with the scope.  Still have about 20 dB to go.
    Current -93.5 dBFS (ref 1.12 V) = 24 uV or 170 nV/rtHz.  
    Should have -117 dBFS (ref 2.25 V) = 3.2 uV or 22 nV/rtHz at 44.1k sampling.
    Also, why not change the pace and look at SPI.  Glitches?  Can even use scope...
    
Other note: floating input, in addition to 100k resistor noise has op amp input current noise dropped on 100k
    1.2 pA/rtHz -> 120 nV/rtHz -> 126 with resistor noise added -> 179 diff -> 25 uV over 20k BW
    -93.5 -89.0 dBFS -> 25uV 40uV
    I can almost believe that's why I'm seeing the increased noise in that channel

DC bias (VOCM) = 2.40 V.  VDD = 5.01 V, so I'm at 0.48 VDD.
    Datasheet recommends being closer to 50%, but I can't see that making much difference in noise.
    
More brainstorming/ideas
    Increase series resistance at AD9515 output to slow MCLK edges (but this increases phase noise...)
    Increase filter caps at ADC input to see if HF from ADA4932-2 has anything to do with it
        Put the corner in the audio band?
    Re-check supplies on scope with new setup
    Reflow AK5572, incase the ground connection was bad or something
    And again, see what the deal is with SPI.
    
9/30/2017
---------
Visual inspection
    Looks OK, but could use some cleanup.
    No obvious opens.
    VREF cap isn't flat on the board, pad seems to have lifted a bit, but multimeter indicates it's hooked up.
    
Did a (iron only) solder cleanup.
Also put 1u 0603 cap across C5 (AIN1)
    [-94.12610469 -91.28382535]
    So, not much improvement; this leads me to believe that most of the issue is in the ADC itself.
    Short both inputs to see.
    [-93.73258163 -94.26296504]

Poking around with the scope again.
    Supplies, e.g. 15/-15, have smaller ripple at what looks like higher freq (4 MHz?)
    AGND pins on the right side of the board have sharp spikes at 11.2 MHz (MCLK)
        Could be scope related, but... they are 130 mV p-p.
    -> Definitely try increasing clock output series resistor.
    Right now, 22 ohm, = 150 mA (15 V/ns with 10 pF).  Try 249 ohm (13 mA, 1.3 V/ns)
        Same spikes, same performance.
    But it could just be the supply for the AD9515 indep. of output current.
    What to do about that?
    Or, what if it's the logic within the AK5572 itself
        It is after all, connected to AGND (both digital and analog grounds) as recommended by the datasheet.
        And there's a bit of modulation to it which probably corresponds to the AK5572
        Try decoupling VDD18 and/or TVDD pins better?
        VDD18 only has C6 (4.7u).  Maybe needs something better at HF?
        Or a bypass wire from C6 GND to the upper right AGND pins, so the return currents don't go through the GND traces under the board/ADC

So, experimenting with AK5572 grounding/decoupling
    Soldered a heavy wire from - side of C6 (VDD18 digital decoupling cap) to AGND
        [-96.97392311 -97.06734616] - a 3 dB improvement.
    A little thinking: If power is usually 33 mA (5 V) = 150 mW, then each spike at MCLK is ~14 nJ 
        (if all power goes to switching, which isn't true)
    Add a smaller decoupling cap with better HF resp.?
        0603 0.1u + 0805 1u
        [-96.74108611 -97.04142715] - not much different
    Add a wire from - side of C10 (VREF cap) and C9 (+5V cap)
        [-95.30628292 -95.94232311] - actually made things worse.  Remove.
        [-95.72658942 -96.20077468] with the wire connected to right side AGND module pins.
    Move heavy wire from C6 GND to left side AGND pins
        [-94.16624331 -94.6058271] - go back...
    Increase C9 with parallel cap
        [-101.29791305 -101.73399057] - nice. (4 dB improvement)
    What does this tell us?
        AVDD, as seen by the AK5572, was noisy.
    Try cutting trace on bottom so digital decoupling paths (C3/6/7) don't go under ADC?
        [-101.43229136 -102.16842924] - a little better, but not much different
    Voltage spikes seem biggest at the ADC itself.
    Basically, this chip really needs a local 5 V regulator close to the pins.
        (Separate reg for VREF maybe.)
    ADC8 will be 4 layer... and ADC2 will be ditched.
    D3V3 supply looks oscillatory too.  At least relative to AGND.  DGND shows the same thing so it's probably not the reg.
        6 MHz or so?
        Try shorting AGND/DGND again.   [-101.42095217 -101.98143631]
        No difference from the ADC's perspective, but maybe for other modules it would hurt.
        
Well, now I have the noise down to about 10 uV.  And I know the ADC2 board is shit.
Things that I can do:
    Keep thinking about noise.
    Debug SPI
    Try loopback with DAC2v1
    Try DAC2v2 with new AK4490

First, DAC2v1 loopback.
    No signal: [-87.27420565 -87.53835008] -> 14 bits
    Max signal: Still -11.3 dB because MSB justified isn't workinig.  (ILA)
    THD: 2nd at -109, 3rd at -113.
    Noise: Noise floor is a few dB better than it was... [-86.4754508  -87.35540303]
    But still a lot worse than with just the ADC.
    THD goes down once I back off amplitude by 3 dB.  But it's not as good as it was.  (Why?  Supply decoupling hacks?)
    At 5 kHz, HD2 is -110 and HD3 is -112... that's good I guess
    At 10k, HD3 creeps up to -105 in one channel.  (But that's 30 kHz.)
    At 100, 60 Hz stuff is higher than harmonics.  Still works though.

SPI: It looks like SPI is broken since I can't read from DSD1792.  So, that will need to be ILAed.
    That and MSB justified.
    ILA thinks SPI is OK.  Scope?
    SCLK and MISO look fine.  CS isn't driven.  (Works for slot 2).  Probe around...
    Move to slot 2? -> Bingo, works fine.  I2S and 44k.
    Note for HW debug: CS come from a deser chip on bottom of PCB.  So it's going to be annoying to get at.

MSB justified: fixed.  2 bugs, one software and one hardware.
    Now I can get some distortion out of it...
    Clip level is -5.3.  At -6 dBFS drive (2 V RMS), HD2 is -99 and HD3 is -96.
    Noise now looks lower: [-92.64288797 -93.74413098] - 15.5 bits
        (but distortion is higher than I'd like at full scale, so this doesn't really count)
    At -9 dB and below, higher harmonics go away
    
Results at 44k sampling
    Noise floor (dBFS) [-95.70748569 -95.34048273] rel 2.24 V.  38 uV.
    Can't tell if any of the improvement is from moving away from the DAC...
    With DAC running but inputs shorted: [-96.77356674 -96.22544276]  34 uV.
    With DAC removed, module adapter still there: [-110.82683514 -110.87028153].  
        Wow.  That's getting closer.  6.5 uV.   (6 dB worse than datasheet.)
        Because the CS input was floating?  Is slot 2 better for some other reason?
        Now I have to try slot 0 also.
    Note: not much difference without module adapter.
    Moved ADC2 to slot 0.. [-110.64330492 -110.14000147]
        So, about the same as slot 2.
    Back in slot 1 and tie CS high?
        Doesn't make a differenec. [-79.61088475 -79.91222932]
        So what's wrong with slot 1?
            It is above some regulators...
            But there's a shield (DGND) in between.

OK, now focus on how to reduce the impact of adding the DAC.
    Noise floor is -110 dB without DAC, -96 dB with it.  14 dB worse.
    As I recall, 5 V supply was the most problematic for the ADC.
    DAC2v1 actually has a decent amount of decoupling on A5V.  About 100u in total.
        47u from VCC1 to each of VCOML/R ("internal bias decoupling pin")
        10u+0.1u from each of VCC2L/R ("channel DACFF" supply) to AGND
        10u from VCC1 to AGND
    Why not add 100u on the module adapter...
        Only caveat is that module adapter draws A5V from left side, but connects AGND on right side.
        Straddle?  No, use right side, where GND is.
        No benefit; -95 dBFS noise
        Decouple the digital one too?  It's powered through a bead (smart).
        What about +/- 15?
            More caps... don't help.
    Latest loopback result: [-94.97746058 -94.87805132]

Lesson learned: should probably downscale the input to the DSD1792 to reduce distortion,
    as long as noise isn't too bad.

What next?  Getting tired of ADC2...
    Try to get AK4490 DAC2 working.
        Going to clean up, take DAC2v1 out for now.
        Get ready for "fresh start" on DAC2v2.
        Though it will probably have some of the same issues as ADC2.
    ADC8 (AK5578) design will be next.
    
Questions to ponder
    1) why it was so hard to keep the addition of the DAC from screwing up the ADC performance.
    2) what's wrong with slot 1?

Tried putting on a new AK4490
    Ref. pins shorting to ground?  Not good...
    Too much heat for caps?  I hope it's the caps.
    I powered it up, and ref. voltages are 1.27 and 3.05.  What?  (Resistors and 5 V supply are OK)
        So they're drawing... 170 mA and 90 mA
    Digital inputs appear to be inputs at least.
    Outputs at 2.63 V on one side, 0.98 on the other.
    AC ?  None.

    I don't know, it looks like I may have killed this one also.
    -> PCB redesign needed.

Calling it a night.  Need to replan.

10/2/2017
---------
Short term plan is:
1)  Redesign DAC2 and ADC2 boards.  
    Figure out how to do things right before moving on to ADC8/DAC8. 
    Don't skip anything.  It will take time.
2)  While waiting for parts, get this thing open sourced.
    You don't know how long it will take to be "done".
3)  Secondary concern, start planning for chassis construction.
    Need to have a "testing" model and an "active stereo" model.

Checked in board files...

So, DAC2 first.  Changes needed:
    DONE    Better footprint for DAC - longer/square cornered pads
    DONE    Local regulators
        Already have A3V3 - ADM7160 from A5V.  This makes sense since ADM7160 has limited rejection. 
            But it's small and only needs 1 uF (0603) in/out caps.  Yay.
        Need D3V3 - another ADM7160 (can probably get away with hanging it off A5V)
        Need VREF supply (sharing left/right? probably fine with separate 22 ohm resistors)  Filt BW = 3 Hz.
            So, 100 nV/rtHz will be closer to 3 by 100 Hz.
            ADP7118 will do.  AUJZ is $1.70, 5 pin TSOT-23
                But its LF noise is pretty high - 1 uV/rtHz at 10 Hz 
            Ah, just use another LT3042.  They're small.  And you won't worry about noise.
        Need VDDL/R 5 V (sharing OK I'm going to say) - LT3042
        Note: Both ADM7160 and ADP7142 are about 10 uV from 10-100k which is 100 nV/rtHz.
        LT3042 (200 mA) or LT3045 (500 mA) look pretty good.
    4 layer board - solid AGND plane

10/3/2017
---------
Doing some DAC2 layout
Question of VREF comes up.
    I have 2 big caps to filter VREF (RC filters)
    AK4490 datasheet says nothing about RC filtering.
    Does it draw significant VREF current?
    Going to put 0 ohm resistors for now.  Try increasing if there is a noise problem, but it probably won't matter.
    
Got initial layout done, will check over later after doing ADC2 also.

10/4/2017
---------
ADC2 schematic changes and layout changes done

DAC2 layout: need to check grounding around VREF supply, looks close to digital reg.

Also, need to add DSD support (hook up the appropriate pins to connector) to DAC/ADC2.  Shouldn't be that hard.
    Done for ADC. Still need to do for DAC
    
Todo:
    DAC - add DSD connections
    DAC - add (regulated input) bulk decoupling
    DAC - check VREF grounding
    Check attenuation (DC levels) on board I currently have
    Silkscreen/DRC cleanup
    PCB Ordering
    Open sourcing / documentation of what I have
    Later: parts ordering - DAC2/ADC2 minus ICs, and parts for another isolator
    
10/5/2017
---------
Progress:
    DAC already had DSD pins hooked up.
    Added regulated input bulk decoupling
    Adjusted grounding around VREF regulator
    DAC DRC/silkscreen cleanup done
    ADC DRC/silkscreen cleanup done

DAC airwires: +15 -15 +5 A7VU D3V3 D7VU -22 +22 = 8
ADC airwires: +15 -15 +5 +3.3 A7VU D7VU -22 +22 = 8

HWCON attenuator testing
    Slot 2 doesn't work.  OK, already knew that.
    Slot 0: With HWCON set to 0xFF, HWCON input voltage is 3.3.  Good.
    Of the 5 vias near the switches, all are high except the middle one.
        Leftmost is +3.3 V supply, other 4 are (left to right) 0, 1, 2, 3
        So what's up with HWCON1?  Probably bad soldering or bad PCB.  Just solder a little wire once I find the break.
        Got an intermittent connect when I was fiddling around.
    OK.  Added 1k on top of R8 to bring the offset down.
        Left outputs are:
        HWCON = 0: 0.009 0.577 = 568 mV 
        HWCON = 1: 0.290 0.295 = 5 mV   41.1 dB
        HWCON = 2: 0.284 0.301 = 17 mV  30.5 dB
        HWCON = 4: 0.264 0.320 = 56 mV  20.1 dB
        HWCON = 8: 0.203 0.381 = 178 mV 10.1 dB
    Yes.  Whew.
    So they cause attenuation at DC.  And hopefully they will at AC too, without much nonlinearity.
    Peak voltage = 1.4 V either side (2.8 V diff)
        100 ohm load each side -> 14 mA
        Switch resistance is about 1.5 ohm -> voltage across switch is 21 mV * 2 = 42 mV
        Resistance changes by about 0.5 ohm over 3 V -> 0.17 Ohm/V -> change should be <7 mOhm -> error < 100 uV (-80 dB)
    So we'll see.  Concept is validated though.

PCB ordering
    DAC2 looks good.  Swapped LF50 output cap from ceramic to electrolytic.
    ADC2: same, and cleared AGND plane under the ADA4932-2 to reduce cap. load
    Done.  $97 including DHL.
    Hope this works.

Anyway, next up:
    Open sourcing (write documentation this weekend?)
    Parts ordering
    Also think about chassis ordering and tools

10/10/2017
----------
Open sourcing.  
    SVN to Git conversion done.
    Need to clean up and make sure licensing is clean before pushing to Github.

Licensing questions came up:

- Using code that came from other sources (verilog/contrib): Need to make sure it is OK for publication
    MIT: Still have to figure this out or re-write the modules.
    ZTEX: E-mailed them to ask what acceptable licenses would be.  Solderpad/LGPLv3 acceptable.
    Micron: no license, public domain; probably OK
    P&B (MIG model): no license, public domain; probably OK

- Xilinx IP: Probably shouldn't publish the MIG code.  (Though others have definitely done that.)
    -> Need to re-do Vivado projects in Tcl script form.
    Can check in XCI core file for MIG, but not the .v sources that get generated.
    Done

Remaining work:
    Replace modules that originated at MIT
    Split licenses
    Clean up software dirs
    Write some basic documentation

10/13/2017
----------
PCB assembly notes:
    Digikey messed up, sent me 2 74LVC574 when I wanted 4.
    Need 3 for isolator, 1 for DAC.  Grr.
    Going to leave out HWCON (U116) and put in for SPI CS (U113) and DIRCHAN (U272).
    *NM* They were on top of each other in the tube.  *Thin* shrink SOP indeed.
-> Got most chips (sans isolators) on isolator.



10/16/2017
----------
Finished isolator, PSU and ADC2v2 assembly.

Initial ADC2v2 bringup:
    Supplies nominal
    Regulators on ADC2 appear to be working
    Clock output is 0
        Did I kill the AD9515?  Or just solder it wrong?
        It's powered... touch up the soldering a bit.
    After some poking around, I could get output from the ADC2.
    -114.65 -114.93.  About 2-2.5 dB worse than the datasheet...
Maybe some bad conections or something?  Results fluctuate.
Close to -115 dB.  Good.

Now going to try it with DAC2v1 in another slot.
    Plugged in and running.  ADC inputs still shorted.  Noise floor is same -115 dB.

Not bad.  That's it for the day.

Recap: I was expecting
    -   ADA4932-2 diff amp config. gives output diff 10.8 nV/rtHz
    -   ADA4004-4 voltage noise is 1.8 nV/rtHz (SE - diff is 2.5) - add -1 dB gain of diff amp, get 2.23
    -   AK5572 SNR of 117 dB = 2.82 uV ref 2 V = 19.0 nV/rtHz
Sum of those (uncorrelated) = 22.0 nV/rtHz = -115.7 dBFS
    What I measured was -114.9 which is 24.2 nV/rtHz.  
    Not far off.  (Well, off by 10 nV/rtHz.  Or 0.8 dB.)


10/17/2017
----------
DAC2v2 assembly.  Paranoid about the DAC chip which is a pain in the ass to solder.
Did an early power u with DAC and its power supplies only.
    Supplies are OK.
    DAC outputs are at 0.08 V.  I want VDD/2.
    Is the chip powered down because it has no clock?  Sigh, go add the clocking stuff.
    OK, clocks added.
    DC levels at outputs are now 2.62 V.  Yay?
    Can't get AC out of them though.  Should look into this more.
    D7VU is sagging a bit (6.28 V) due to 3 modules installed.
    Moved to slot 2 and took out DAC2v1.  AC ho.

OK, now solder everything else.

10/18/2017
----------
DAC2v2 assembly completed.  Initial results look promising.
But one channel is stuck at -20 dB attenuation.
    When powered off, R46/41 are shorted to each other
    -> Check soldering
    Fixed.
    
Attenuation control is broken in current config.  because HWCON is broken for slots 2/3
    Solution: swap DAC+ADC.
    That did it.
    
OK, now want to test single-ended.  What do I do?
    Seems to maybe work, but with buzzing?  SNDR 70-75 dB.
    Well, why not try it in the stereo... seems OK.  I have isolation transformers, bet that helps.

Tomorrow: listening and chassis work.  (When to do DAC/ADC8?)

Note: 10k AC coupling resistor is causing significant bass droop.  Replace ASAP.


10/19/2017
----------
Some listening.
    Initial impressions (overall): Still has slightly dark/muddled treble balance like I noticed with the DAC2v1 in the iso/Jung chassis.
        Maybe that's the speakers/recording.  Don't feel this way about all recordings.
    Bass is (slightly?) light due to resistor mishap, but has enough energy ("jump", as in "makes you want to jump out of your seat")
    Overall sound is smooth as you could ask for.
    Not a lot of clutter in the soundstage.  Slightly recessed?  Nothing jumping out of the speakers, even relatively loud.
    John Williams: Great tone color on the horns.  Bass seemed oddly compressed?
    Better than Ezra: "Hard" tone is distinctive, but doesn't bother me.  Very clear/neutral.
    Pink Floyd: Bass transparency may have improved, but it's hard to tell since the frequency response is different.
        This one ("Mother") has the dark/muddled treble.  Along with Wynonna Judd's "Father Sun".
    Phillip Phillips: Noticed some texture in the voice that I hadn't before.
    Train: Wow, I had it much louder than I usually do.  (Avg >90 dB in chorus).  Sounds good is all I can say.
    Stanley Clarke: Went overboard a bit on the bass (90-95 dB).  But the rest isn't too loud to bother me.  Very clean.
    
So maybe it's just that I hadn't listened in a while and got excited.
    Differences between DAC2 versions probably pretty small.
    But things sounded good.

10/21/2017
----------
Chassis work.
    Drilled Slimline chassis bottom and tapped.
        Poor alignment on some holes for isolator.  Oh well.
        Recommended procedure: carefully mark/drill/tap holes for the 4 corners, then screw a bare board to the plate and centerpunch the remaining hole locations through the board.  This reduces the chance of marknig errors.
    Skipping heat spreader for now.  Get another Al bar that's the right size.
    Need to transfer transformers from wooden prototype;
    
Main question is how to do the back panel.
    Eventually this chassis will probably have 2x DAC2, 1x DAC8 and 1x ADC8.
    But the panel is easy to remove, so I'll go with incremental drilling for the modules that I'm using at a given time.
    Modules/features will be evaluated on the test setup before being installed in this chassis.
    Initial: 1x DAC2.
    How to drill large holes for XLRs?
        
    How to cut non-circular cutout for AC inlet?
        Dremel?

10/22/2017
----------
Transformer swap
Part 1. Moving from bench supply to protochassis.
    Done.  But blew a resistor in the process.
    Old F8-28 transformer hums.
    
Part 2. Moving from protochassis to metal chassis.
    Transformers are there.  But no sense in wiring them up until I have the back panel components mounted.
    
Will also need to do bringup/debug:
    - New PSU board (and transformer wiring)
    - New isolator board
    - Assemble another clock source and/or carrier?  For now, transferring between setups.

And design of DAC/ADC8 - timeline is important.
Order:
    Design rear panel cutouts/holes in spreadsheet.
    While waiting for drill bit and Dremel cutters, design DAC8 and ADC8.  (Schematic then layout)
    
DAC8 design:
    Going to use 1k attenuator at main buffer output with another opamp follower for output drive.
    OPA1664 op amp
    For attenuator, what about running the filter at a CM of 2.5 V so a low voltage single-supply switch can be used?
        e.g. MAX14662 which costs $2.64 and has 8 SPST switches
        Say it claims to handle "beyond the rails" switching... look at Ron linearity.
        Distortion is a little over -100 dB, so why not try it.  Especially if I'm using it with small swing.
        Plus distortion should include even harmonics if used single-ended.
        2 switches (-10, -20 dB) per channel - need 2 chips.
    AK4458 DAC: min load is 3.8 kOhm.  Recommended circuit uses 3k resistors min.  Noise is 16 nV/rtHz from filter alone.
        Seems not great.  Noise from DAC itself is -112 dB ref 2 V = 5 uV = 35 nV/rtHz.  Maybe filter is already included?
        Output circuit simulated in akm_dac8_output.asc.  Response looks good.  Don't muck with the values.
    Give the output buffers some decoupling but running on global +/-15V supply is fine.  They have PSRR.
    DAC needs local regs for all supplies.  Use same circuitry as DAC2.
        1x 3.3 V (digital) with ADM7160 from A5V, 2x 5V (analog) with ADP7118 from A7VU
    Try for a compact layout.  Components on both sides.
    Clock receiver: LVDS with a good regulator - ADM7160 is good/cheap, just hook up to A5V or better yet, put an NCP699 in front (cheap)

10/23/2017
----------
DAC8
    ADP7118 in/out caps: 587-1431-1-ND (0805 2.2u 16v)
    
10/29/2017
----------
Wasn't taking notes for a few days, but finished up DAC8 layout.
    Upped attenuator series R to 2k since that's what OPA1664 is happy with as a load
    Some crosstalk concerns, especially around attenuator; build it and see.
    
Starting ADC8 schematic/layout.

Also did some listening to DAC2.
    Beautiful relaxed tone, clean.
    Maybe lacking some dynamic impact at low volumes.  Can't tell if it's reduced drive, harmonics, or what.

Ordered ribbon cables from Ebay.
    Connector is S9023-ND 

Cap for ref decoupling (100u 6.3 V) PCE3853CT-ND 

10/31/2017
----------
PCB layout's been happening.  Finished up DAC8, ADC8 and RCA adapter.
Still need to revise clock gen. if I'm going to squeeze that in.
    Made the mods.  Looks OK.
    
Now time to review the main PCBs.
DAC8:
    -   Schematic
        OK
    -   Power dist. and grounding
        OK.  Added some vias near DAC.
    -   Digital signal routing incl. clock
        OK
    -   Analog signal routing
        Lines coming out of DAC have a decent amount of cap. and no series resistance until summing/filter circuit
        Length: up to 3.5 in. (8.89 cm)
        Est capacitance (SE) = 8.2 pF.  An op amp can probably drive that...
            Example for fast op amp is ADA4899-1.  Some overshoot with 15 pF, but doesn't oscillate.  I bet it's fine.
        Crosstalk concern around attenuator - coupling capacitances
            Already examined; build it and see.
            
    -   Ratsnest OK
    -   DRC OK
    -> Go for production.

ADC8:
    -   Schematic OK
    -   Power dist. and grounding OK
    -   Digital signal routing incl. clock
        MCLK routing is hacky.  But couplign has been minimized.  Moved a via for less coupling to VREFL/H.
    -   Analog signal routing
        Maybe some crosstalk in the input routing, if the source impedance is high?
            Build it and see.
        Amp routing is about as clean as can be
        Routes to ADC inputs are long.  And maybe some crosstalk.
            But they have big caps as close as possible to the load.
            Coupling to supplies in nearby planes - assume those are AC grounds
            
    -   Ratsnest OK
    -   DRC OK
    -> Go for production.

Ordered all 4 sets of boards, $109.
Parts will probably be much more... but that's a task for tomorrow.

11/1/2017
---------
Parts inventory and ordeirng.
    Arrow for regulators - $15
    Digikey for everything else - $143


11/4/2017
---------
Listening note:
    Spent the last few days pulling out recordings that were sometimes hard to listen to.
    Henley Douglas RnB: remember thinking this sounding compressed/edgy (after an awesome live performance).
        Now I can notice the problems but I'm not paying attention to them.  
        Easier to appreciate the (admittedly limited) dynamics and the groove the band gets into.
    Weezer, Pinkerton: This is definitely a grungy sounding recording.
        Remember finding it grating (in its own unique way) when I first got it, though it was good on a friend's system with generous subwoofer help.
        But to be honest, on this system it sounds pretty awesome.  "Garage band" tone, but clear and uncompressed.
    Definitely expands the set of recordings that I want to listen to regularly.
    Overall surprised at how euphonic the SE output of the AK4490 sounds.
        -> Have to confirm after fixing bass response and experimenting with different digital filter settings.

11/5/2017
---------
Looking at rear panel cutting options
    1. Pololu (lasercut) - $25 min.  Should submit a design for quote.  ABS or acrylic - looks good, but no shielding.
        Can do stainless steel, but with 1/16" thickness.  Better shielding, not as good, and also not black (unless I paint it).
    2. Hifi2000 (CNC) - EUR 8 for blank panel, EUR 45 for CNC service with >20 holes. Shipping unknown.
    3. Front Panel Express (US branch of Schaffer AG) - seems to have end to end service including CAD etc.
        Check the cost... $47 for plain panel with just corner holes and AC inlet.  (Before tax/shipping... location is Seattle)
        Worth considering because they can do engraving/screen printing also.
        Lead time is probably long.
    3-D printing in Al is prohibitively expensive
    Ask Ed for advice?

First bringup in new chassis (warning: untested isolator board)
Part 1. PSU/transformer wiring
    Nothign blew up.  No load LV supplies are 8.4 V, HV is 23.3.  AC 6.11, 16.9.
    Did not check neg. supply.
    Need to discharge through a resistor before hooking up isolator.
    ... nah, never mind.  Nothing blew up.
Part 2. Isolator - regulation
    All OK.
Part 3. Isolator - functionality
    Install carrier and clock source.
    Clock source - OK
Part 4. System with DAC - functionality
    All supplies OK.  Clock OK.
    DC offsets range 0 to -20 mV... OK, investigate later
    Output doesn't seem there.
    HWCON DC = 1.23 V despite setting to 0; check ser/des
        3 of the 8 bits are high (not sure which)
        This might be unintentionally engaging the mute
    BCK, LRCK, SDATA0 look OK at DC at least
    
Back panel cutouts note: Completely forgot about Ethernet.
    Next time order 1528-1572-ND
    (Do the cutout whenever you do the cutouts for the other modules)
    
For now, run without top panel... so the Ethernet cable can get out.
    Or go wireless?

11/11/2017
----------
DAC8/ADC8 assembly done (1 board each)

Now debugging new chassis/isolator board again.
    HWCON seems to be screwed up.  
    Module/DC:
        (Cmd=0xFF) 0=1.23 1=2.47 2=0.0 3=0.0
        (Cmd=0x00) 0=1.23 1=0.0 2=0.0 3=0.0
    Check serializer/deser connections.  And SPI chip select while you're at it./
    


11/16/2017
----------
Chassis/isolator:
    DAC2 is working after re-checking SPI and HWCON connections and fiddling with software.
    THD is -90 something single ended.

DAC8:
    A5V is shorted to GND.  Doh.  Good that I checked.
    So, what's connected to A5V?
        Attenuators and their decoupling (back)
        One of the DAC regulators (the digital one)
        One big 220u decoupling cap (C9)
    Well, let's remove them...
        Not C9.
        U11/C78... wow, it was one of them.  Try resoldering.
        -> Fixed.  OK, try now.
    Supplies: All nominal
    Clock: Ok
    Outputs: At least some of them show AC... maybe even the right amount of AC.
        Which ones work?  Out ampl left to right is 0.9, 0.9, 0, 0, 0, 0, 1.0, 1.0.
        Ah.  But I wasn't driving the other 4.
        Now I get 0.9, 0.9, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0.
        Ampl. of missing channel R3 is good going into opamp, so it's not the DAC.  Probably a bad connection.
        And what's with the 0.9 V ones?
        Anyway, this is encouraging.
        
    Going to need a place to hook them up, though.
        Move to test chassis?
        Or drill more in main chassis 
        OR: Get ADC8 going and hook up with ribbon cable directly?
        
ADC8:
    No supplies shorted.
    Sticking it in slot 1 next to DAC8.
    Voltages nominal. Clock OK.
    With Python script I can gather data from all 8 channels.  Yay.
    No idea if it's valid.  Noise floor is between -83 to -93.  (Alternating?)
    [-93.52469968 -84.00097216 -93.46761827 -83.96389035 -93.4793445 -83.93253704 -93.40382672 -83.9633308 ]

Will have to do a loopback test... looks promising though.

OK, what's the plan.
First, things I need: (before ordering parts for duplicate boards)
    Way to hook up DAC8 to ADC8 for loopback.  (Jumper cables?  Ribbons are somewhere in the mail, ordered 10/30.)
    Chassis cutouts in main chassis for:
        DAC8
        ADC8
        2nd DAC2
        S/PDIF in
        Ethernet
    Listening test of DAC8
    Some loopback measurements of DAC8/ADC8/DAC2/ADC2

11/17/2017
----------
    
Tonight: Loopback tests (+errands)
Tomorrow: Chassis cutouts

Fiddling with loopback:
    Looped back first channel of DAC to channel 1R of ADC.
    On ADC, 4 channels are getting a (messy) signal and 4 are not.
    Check "mono" settings?
    Look to be correct... (jumpers and SPI)
    Waveform:
    1) Bursts of something then (3/4 of the time) nothing
        Indicates possible buffer underrun or format mismatch
    2) 4 channels are indeed nonzero
        But they have a rel. phase shift... not numerically the same
        How am I getting that...
        Try hooking up the left channel too.
        Now I get all 8 channels.  Hmm.

Things to fix. One at a time.
1) Getting a continuous waveform with no breaks
    SW performance limited?
    My runtime is about 4x the audio time.  (Chunks of 1k samples)
    Underlying RTL cannot read and write at the same time.  So we need to rely on interface buffering for full duplex.
    Or change the RTL?
    There are a lot more software things to try before doing that.

11/18/2017
----------
Still working on getting the audio to be real-time.
    How can I understand what's going on?
    Probably need the ILA.  So let's do it-  just the top level state and interface.
    We are hanging after the audio read command is received and 4 words (the header) were sent out.
    Ah. Looks like 8-ch ADC functionality was never implemented.
    I was getting the first 2 channels?  At 1/4 the rate?
    May not need to do this USB stuff.  
Back to the (RTL) drawing board.
    Simulate this 8-ch loopback thing.

11/19/2017
----------
OK, added 8 ch ADC support in RTL design.  Trying (first without ILA, then with ILA).
    At first, can pretend there is no change necessary to the software.
    But it will be interesting to see how fast the current blocking I/O scheme is, assuming it works.
    
Some difficulty with the clock routing constraints for BCK... (should be routed to clock capable pins in future?)
ILA debug notes
    It looks like slot_controller isn't writing to the audio TX FIFO.
    It is getting LRCK and counting cycles though.
    Recording not properly enabled?
    adc_fifo_write_count = 2... doesn't know it's 8ch?  (shouldn't matter here)
        Well, after a reset it is 8.  So dirchan is probably OK.
        Got a few cycles of BCK (startup?) and it went from 8 to 2.
        May have something to do with the serdes of dirchan at startup.
        The real issue is that recording doesn't seem to be enabled.
        Confirmed: recording_enabled registers not going high when command is issued to start recording.
        slot_controller: byte_counter not being reset to 0 after prev command?
    -> Actually, there are many local changes to the code in cdp dir
        which were not copied over when I moved to da_platform dir.
        So, have to update my code.
    This explains most of the problems since I started ILA debugging and had to stop using the old
        design loaded in flash on the FPGA..
        (was hanging on the set-ADC-format command)
    OK, merged all those changes.  Rebuild bitstream.
    Now what?
        Hanging at audio write.
        -> This seems to have fixed itself?

Yay, continuous waveforms.
    With occasional glitches (probably flaky connections)
    One channel is bad from a distortion point of view.
    Test is supposed to be -3 dBFS with 1 kHz signal.  This seems OK.
    Good channel - blue
        Ampl = -4 dB 
        HD (2, 3, 4, 5) = -99, -101, -125, -130
    Bad channel
        Ampl = -5 dB (1 dB low) and noise floor is higher
        HD (2, 3, 4, 5) = -50, -60, -90, -77
    Also, crosstalk to the other 6 channels is -72 to -82 dB
        See if this improves when they're driven.
        100k is a large load to couple to.

Questions to answer:
1) Bad channel: is it DAC or ADC?
    Moved one of the wires on the DAC... still bad.
    Moved the other... still bad.
    So it's the ADC I guess?  Try using different channels (currently 1/2)
    OK, with ch 3/4 the artifacts are gone.
    Distortion is about the same as ch 2 -98 HD2, -102 HD3

    
2) How's crosstalk between driven channels?  (Test with different freqs)
    Looks like -82 for the good channel...
    Test with 0 dB drive.  HD2 is around -94, HD3 around -95, higher harmonics are peeking above the noise floor.
    Crosstalk is bad: as much as -73 dB
    How about with a higher frequency?
        At 5 kHz: HD significantly worse; HD2 = -78, HD3 = -83
        Crosstalk at -59 (14 dB worse, about what you'd expect from capacitive coupling)
    Lower level: -10 dB drive results in HD2 around -85, HD3 = -103

3) How about summing?  Or at least driving all ADC inputs with the same signal.
    a) Stereo - seems to work
        Noise floor of the 4 channels with inputs grounded varies between -108 and -111 and looks uncorrelated
            More like -111 consistently now, maybe there was a bad connection
        Crosstalk is -111 at 5 kHz.  This suggests the DAC is the one screwing up the crosstalk.
        There are a bunch of smaller tones showing up at evenly spaced freqs below the fundamental and each harmonic... aliasing?
            Exact frequencies depend on stimulus freq.
        Try swapping L/R...
            Works fine. Don't see a bad channel now.
        Fs/4 test looks good as you'd expect.
    b) Mono - seems to work, elevated noise floor? and distortion
        And what looks like correlated noise.  Maybe the DAC's having trouble driving the load.
        At -20 dB drive, harmonics are down but the noise is still high.  I sense oscillation.
        How about driving only 6 channels instead of 8?  Nope.  Still high noise.
        4 channels?  Still, worse noise than it should be (but not as bad... not oscillating all the time?)
        Input cap of OPA1664 is only 2 pF so it isn't that.  (Not with 50 ohm series res. on DAC which should be there)
        Whatever I do, putting the 1R jumpers back to 2/8 channels makes the problem go away.  Weird.
        Not entirely sure if this is a DAC or an ADC issue.

4) Let's see if attenuation settings on the DAC affect this at all.
    (Measurements so far done at 0 dB)  Still using full scale drive
    a) -10 dB    
        Appears to work just fine.  Harmonics definitely lower (so maybe those are from the ADC?)
            HD2 invisible, HD3 around -100
        Crosstalk looks about the same in a relative sense.  Try with 2 channels driven...
        Rel crosstalk is about -84 dB.
        At 5 kHz, crosstalk is still shit.  HD2 pops up at -97, HD3 at -95.
    b) -20 dB - also works fine, not much different from -10 dB
    
Summary of results so far:
-   Possible bad channel (flaky connection) - ch 1 or 2 on ADC, but it seemed to go away after warmup
-   DAC attenuator works fine.  Attenuation value is accurate, and doesn't introduce significant distortion.
-   DAC distortion is good, but crosstalk is terrible (as bad as -54 dB at ~20 kHz).  Probably needs layout revision.
-   1 ch summing on ADC doesn't work, but 2 ch is fine.
-   ADC noise floor is around -113 (ADC) or -112 rel 2 V RMS (1 ch).  This is 5 uV or 36 nV/rtHz.  (Datasheet: -117)
-   Loopback noise floor is around -110 rel 2 V.  This indicates the DAC noise is pretty low.   (Datasheet: -112)

Plans / todo:
    Check loopback (mono/stereo) between ADC8 and DAC2.  That will tell us if the 1ch summing issue is the DAC8 or ADC8.
    Drill chassis holes for ADC8 and DAC8 in main chassis (but won't be able to listen/characterize until I get ribbon cables)
    
After receiving ribbon cables:
    Perform a more thorough 8 ch loopback test to determine:
        if there are any bad channels
        THD/N plots vs. freq for each channel at 0, -10, -20 dB (and with attenuator)
        crosstalk matrix at 1k, 5k, 20k - see if it can be correlated to PCB layout
    Do some listening:
        a) DAC8 used as stereo SE source for active crossover
        b) DAC8 used as multichannel source with digital filters
        c) ADC8 uses as input, DAC8 used as multichannel source

More notes...
    - Moved DAC8/ADC8 to modules 2 and 3; still works.
    - Added DAC2 to module 0; loopback works fine, HD3 is -100 or so
        Noise is -91 (bunch of 60 Hz stuff..) but it went to -106 when I held the two wires together.  Ah, differential signaling.
    - Ordered some insulated RCAs for when I put in the second DAC2.

Decisions...
    Whether to revise DAC2 before building second one?
    (Second board required for main chassis completion)
    Problems include:
        High noise of -105 dBFS -> not really a problem, it's just an LF corner (maybe in the DAC itself)
        60 Hz stuff getting into SE output (maybe it's just EMI?) -> not really a problem, since if you care, use differential
        Bad frequency response -> needs investigation -> not going to care, just going to try different filter caps and see
    Uncertainties include:
        Haven't listened with 100k LF filter resistors
        Haven't listened in balanced mode
        Haven't listened with attenuator
        
    Whether to revise DAC8 before building second one?
    (Second board required for 16 ch demo)
    Problems include:
        Hilarious crosstalk of up to -54 dB
    Uncertainties include:
        Haven't characterized all channels -> full characterization will wait for ribbon cable, but all are functional
        Haven't listened (with or without attenuator)

    Whether to revise ADC8 before building second one?
    (Second board required for 16 ch demo)
    Problems include:
        Somewhat high distortion -> Wow, really high at high freqs.  What did I do wrong?
    Uncertainties include:
        Haven't characterized all channels

    Notes:
      - PCBs are not that expensive compared to building boards.  
        So if I don't want to do 16 ch demo in the near future, may as well revise.
      - If the main chassis completion is the main short term goal, the critical path is:
        Figure out what exactly is lacking in DAC2 performance.
        IF NECESSARY: Revise DAC2 and order boards.
        Order parts; assemble 2nd DAC2 board
        Drill out chassis; assemble, configure software

Looking at DAC2 performance some more
    1) Loopback with ADC2
    The noise appears worst at LF.
    Limiting noise measurement BW to 20--20k improved noise floor to -110.7
    Limiting to 100--20k improved it to -112.2 (Datasheet: ADC=-117, DAC=-117, target=-113.5 ish given -1 dB ADC input gain)
    What would I have expected?
        Datasheet: with -1 dB gain, rel 2 V noise of 4.24 uV = 30.3 nV/rtHz
        ADC: About 12 nV/rtHz - mostly the diff amp
        DAC: Almost nothing - ADA4899-1 and a bunch of small resistors
        30.3 + 12 = 32.6 nV/rtHz = 4.56 uV = -112.8 dBFS
    I think this is close enough.  The main question is where is the LF corner coming from?
    Note: noise floor went up by 3 dB with the bandwidth around 13 Hz.  So the noise is ~40 nV/rtHz at that frequency.
    Noise density at 10 Hz:
        ADA4899-1: 10 nV (SE)
        ADA4004-4: 2 nV (SE)
        ADA4932-2: 24 nV (diff)
    To see if ADA4932-2 is responsible, look at the noise of a shorted channel:
        BW = 100 Hz: -115.2.  BW = 10 Hz: -114.7 (not significant change)
        -> This is on the DAC side.
        What about a noise penalty due to the filter (1 uF / 100k ohm) at input?
        But the DAC is driving it, so it should be a low impedance.
        Maybe this noise corner is in the DAC.
        
    Also: looking at gain droop
        Adjusted 1 kHz to -10 dB.
        10 kHz = -0.437
        20 kHz = -2.028
        100 Hz = -0.785
        40 Hz = -1.036
        20 Hz = -0.385
        10 Hz = -0.163
    Whaat?  Something seems wrong.  Try a sweep someday.  (Those were consistent from run to run.)
    
    a) HF rolloff - try using sharp rolloff filter in AK4490
        SD = 0 for traditional filter, 1 for short delay filter
        SLOW = 0 for traditional filter, 1 for slow rolloff filter
        Default = short delay, sharp rolloff
        ADC: default is traditional sharp rolloff, no rolloff by 20k
        DAC: default still shouldn't have any rolloff by 20k
       Now response is -1.8 dB at 20k regardless of which filter I use
       With 100 ohm series on the output, how much cap would it take to get -1.8 dB?
        Impedance of 400 ohm at 20k = about 20 nF.  Don't have that much.
        
        Try with ADC8
        10k = -0.437, 20k = -1.809, 40 =  -1.034
        -> same as ADC2. I know ADC2, ADC8 are the same chip, but IMO this points to DAC2 as the problem.
        
        Try other channel: -1.036 @40, -1.81@20k - same
            i.e. unlikely a bad connection
        
    b) Effect of attenuator
        Tried -20 dB.  This messes up the noise floor, but maybe will still give useful frequency response.
        20k = -1.864
        40 Hz = -1.046
        --> doesn't seem to make any difference.  What's happening is not in the attenuator.
    
    c) Distortion
        1 kHz: 0 dB gives a bunch of higher harmonics.   (Clipping something?  Check with ADC8.)
            -1 dB gets rid of clipping harmonics but 5th is at -130.
            5 kHz: not much worse
            20 Hz: not much better
        But with ADC8, clipping harmonics at max drive go away.
            0 dB, 1 kHz: about -100 dB HD3 (others much smaller)
        -> DAC isn't clipping.
        Added 20 dB attenuation so ADC isn't the source of nonlinearity.
            (Why can't I get a clean spectrum?  Bad HWCON?)
            Now harmonics are much lower.
        Added 10 dB so I could see better:
            HD2 = -117, HD3 = -104 at 0 dB
            No significant change at -1 dB
            HD2 = -116, HD3 = -110 at -3 dB
            No visible harmonics at -10 dB
        I have a feeling that either the ADA4004-1 or ADA4932-2 is letting me down.
            ADA4004-1: not the best linearity
            ADA4932-2: limited output swing (it can go within 1.2 of the rails: 2.5 to 3.8), which is not quite 1 V RMS.  It's -0.73.
                Of course, this is why there is -1 dB of gain.  But the guaranteed spec is: within 1.4 V of the rails (-2.1 dB)
                CM range is V- + 0.2 to V+ - 1.8
                So, powering from asymmetric rails would help.
                Pos rail is ADP7142, neg is ADP7182 (both 5 V)
                Cut/jump hack with resistors (sense terminal) could boost ADP7142 output
                And ADP7182 is available in 2.5, 3.0, adjustable
                
        Far as DAC2 is concerned, I think -104 dB is good enough.  Even though the datasheet says -112.
        
Before building another DAC2:
    Do freq resp, THD/N sweeps of both channels in ADC2 loopback.  (And can try ADC8 loopback also, if there are unanswered questions.)
    Do some listening with the new LF filter resistors.
        Option 1: Put main chassis in stereo system, listen while prepping the software for sweeps.
    --> Option 2: Do sweeps first on the bench 

Started working on a stepped sine test. (within loopback_8ch.py)
    Automatic alignment of input and output waveforms is a challenge.
    Once that's done, I can slice it up and FFT it out.
    At the moment there's no gap between frequencies.
    Continue this tomorrow.  Followed by some debug to figure out what causes the FR shape you see.

[Simpler stepped sine FR/THD/N test]

11/20/2017
----------
Back to one tone at a time. Notes on that:
    Programming is easy.
    Lots of waveform glitches - bad connection?
    Don't think so, tried another set of jumper wires.
    Timing / interference?
    Try shutting off SCLK.  Doesn't help
    Try shutting off clocks to unused modules.  Doesn't help.
    Check FPGA timing report and constraints.
        All failing paths are on ifclk - USB interface
        All I2S signals are set to 4 mA drive.  (Note: we have isolators here, so load is not huge.)
        Going one further by setting slew to slow.  (Only affects carrier side: no series resistors at iso outputs, though each board has some.)
        Interesting.  This eliminates dropouts but frequency is wrong, indicating SPI programming failed.
        Restoring SPI signals to 8/fast.
        Now, no SPI issues, but audio dropouts.
        OK, try all 4 mA and slow.  (All isolator outputs)
        Now I get LIBUSB_ERROR_OVERFLOW?
        -> False alarm, had programmed with wrong design.
        OK, SPI is OK but still have audio dropouts.  Doh.
        With just DAC2 /ADC2 I get lots of nastiness.  Revert, revert.
        Using strong drive for "DC" signals like reset.  I2S still 4 mA.
        Maybe I messed something up on my ADC2 board.  ADC8 seems fine.  (With DAC2 in slot 0, ADC8 in slot 1)
        Pretty sure I broke SPI though, experimenting with drive settings.
        
    Check using DAC8 as source.
        Doesn't help.  (Works but with dropouts)
    Try different chunk sizes (and USB async?)
        Doesn't help.
    Try removing unused modules.
        Doesn't help.
    
    These issues suggest we may need resistors on the carrier (or FPGA board?)
        to keep the rise times reasonable.  Any problems on isolator side can be managed with resistors.
        (Note: SPI signals, HWCON etc. don't have resistors.)
        
Now I have good sine stepping code but too many audio dropouts to get good numbers. :-(
    Try 8 mA drive for slotdata?    Nope.
    Are the glitches in the DAC output, or the ADC output?
        TBD.  Need to use computer for DAC capture in that case.
    I've heard a funny sound when turning the AC power off.  Is a regulator oscillating?  (look into that another time)
    
    General hypothesis is that something has gotten screwed up in the hardware since the last time I tested.

11/21/2017
----------
Brainstorming ideas:
    Look at the clock.  Actually, look at all signals with the scope.
        Including the clock input to the FPGA.
        And try re-seating the oscillator and the clock board.
        Note that the large ripple on D7VU might have caused problems for the ADM7154.  Could make a new clock board if this was the case.
        Or for a quick test, substitute with the other clock board.
    Suspect the DAC, when seeing audio dropouts.  
        The transients at the start/stop of the dropout wouldn't occur if we just dropped some of the samples coming out of the ADC.
        But when we get all zeros, or the sampling frequency is wrong, that could be the ADC.
        (Clock or supply dropout during SPI programming would explain bad sampling frequency.)
    Keep a fixed HW configuration, don't go moving modules around.
        And don't randomly experiment with the IO constraints in Vivado.  That didn't help.
    
    
Notes:
    Maybe dropouts have something to do with warmup?
    ADCLK chip is actually quite hot - 53 C; ADM7154 is 54 C (nothing else in the chassis appears to be that hot)
    Let's turn the fan on.
        Lowers the temp a few deg. (to 47), no difference in behavior.
    Reseat osc. and clock PCB.
        No help.
    Well, next time you can try 2 things
    1.  Other clock board (needs a resistor jumper put back)
    2.  Probing around with scope
    3.  Using old bitstream (the one in flash)
    
    

And on THD/ampl meas.
    There's definitely an inconsistency between RMS ampl. and carrier amp.
    At 1k, RMS = -11.13, carrier -12.44
    At 1001.294, RMS = -11.12, carrier = -11.13
    Added frequency "snapping" to FFT bins for sine loopback test.
    Now there's no droop at 40 Hz.
    At 20k, get RMS of -11.8; 10k, -11.34
    Was expecting 0.1 dB drop by 20k, but got 0.7.
    At least the LF rolloff is what I expected. (No detectable drop by 15 Hz, about 0.1 dB at 10 Hz)
    At HF, do I have to do anything different in the stimulus?  (besides just sampling the sinewave)
        I would assume no, since the DAC should have a sinc reconstruction filter
    So is -0.65 dB rolloff at 20k a big issue?  (-11.13 to -11.78); -0.21 dB at 10k
        For the sound, probably not.
        For my understanding, probably yes.
        After the dropouts are fixed, try DAC8 and see if it's the same.
    Filter options:
        With traditional, short delay filter, 20k ampl is -11.79
        Slow rolloff filter: -16.42 (vs -11.12 at 1k, -11.39 at 10k) -> 0.27 dB at 10k, -5.30 dB at 20k
         (that is about what the datasheet says)
    
    Also, note that THD/SNDR measurements are broken at lower freqs.  Even 200 Hz SNDR is bad.  THD OK by 40 Hz.
        Can try not using a window, right?  Integer number of periods?  (Unless affected by dropout...)
        Still gives a "bump" at LF.  (Peak sure looks sharp...)
    
11/23/2017
----------
Thoughts on HF rolloff:
    DAC output filter is simulated to be -0.1 dB at 20k.
        But if I switched the 3.3n and 4.7n caps it would be -0.35.
        Multimeter meas.  
            [4.7n] C52=6.12n C68=6.65n C27=6.10n C60=6.62n
            [3.3n] C26=8.71n C52=11.21n C51=8.71n C67=11.22n
        Heat damage?  Or messy measurement?
            Sim with those values 6.1, 8.7 -> 1.1 dB loss
            6.7, 11.2 -> 1.8 dB loss
        Any other NP0s I can measure?
            C25 - 1n -> 4.63n
        One of the 15n caps at ADC input was 120 or so.  Not a clean measurement.
        Also says the ADC buffer input is 2n. That makes no sense.
    -> If the caps were messed up, that would do it.
    But it's unlikely to be matched perfectly.  So check all channel combinations.
    
    Simulate ADC input circuit.  -0.005 dB... not that.

Tomorrow: Think about and probe around for audio dropout problem (try 3 ideas above)

11/24/2017
----------
Looking into audio dropouts. 3 ideas to investigate

1.  Other clock board (needs a resistor jumper put back)

2.  Probing around with scope
    Clock reaching the module appears rock solid
    What about giving a repeatable I2S pattern?
    Going to use Fs/4 since DC doesn't give any signal (just noise; dropouts don't make a difference?)
        But if the dropouts were on the DAC side wouldn't we see transients from that?
    Oh also: use computer to check for dropouts on DAC 
    How long are the dropouts?  (First invalid sample to first valid sample)
        2299 to 2360 = 61
        Just a few (3?)
        1260 to 1285
        2304 to 2317
    There might be a regular pattern.  Without dropping any samples from ADC at beginning (so we lead with 0s),
        a) Got dropouts at: 1172-1246, 2268-2349
        b) Start at 142.  Dropouts at 1165, 2257, 5348 (~1k period)
    Seems related to chunk size.  The 1k period was with a chunk size of 1k.  With chunk 256, dropouts closer together.
    Try 2k, 4k...
        2k: 163, 2250, 8473; 182, 2250, 4336, 6423, 12592
        4k: 598, 8782
    OK, definitely related to chunk size.  Software issue?  Now can try async...
        Or RTL, something gets stuck when dealing with I/O.
        Audio out FIFO depth (at top level) is 128 samples.
        Async runs, but dropouts are still there, and very regular.
        Async with really small chunk?
        When using chunk 256, get an overflow error? Fixed, software bug.
        When using chunk 64, there's a dropout after basically every chunk.
        So let's try overlapping chunks... hmm.  Buffer underrun I guess.
        Write a 1k chunk at beginning before reading...  that solves the problem with Fs/4.
    Now, move to a different Fs. like 100 Hz.
        Regular glitches, every chunk, like the buffer is being overwritten.
        That was another stupid software bug.
        Now?

3.  Using old bitstream (the one in flash)
    Dropouts and other similar issues from the beginning.
    -> What this means is: not a FPGA regression, and adjustments to constraints/drive are unlikely to help.
    To eliminate this variable, start using new bitstream and hash it.
    Current bitstream is: 494b1a5a198dd82e35690b80b87dd1eb
    After changing bitstream, can't do anything (hang on reset_slots)--what's happening?
        Have to ILA and find out, I guess.
        No debug cores show up.  -> Clock  (ifclk) probably not getting in.
        Weird.  Probed with scope, there is a clock there.  Now ILA appears too.  And audio works.  (Still dropouts though.)

4.  What about an RTL bug?  (FIFO/CDC/etc.)
    Haven't done an I2S loopback test since before switching to Vivado 2017.2 (or a lot of other changes)
    
I think the dropout issue may be resolved.
    Remember to never allow buffer underrun.
    
Now, a couple more minor things:
1) Correct THD/SNDR/ampl calculation
    a) SNDR.  Why bad at LF?
        We're masking out a wide portion of the FFT and it's going below ind 0
        -> Fixed
        Now, when I do a sweep, some freqs have bad SNDR.  Why?
        When "display" is on, and text is printed to the terminal, this doesn't happen.
        -> Zero samples at beginning.  Longer startup delay?
    Also added some re-testing for when there are glitches once in a while

OK, I think I can go back to dealing with the HF rolloff.
    First, try the other channel combos. (and save plots)
    The 2 DAC channels are identical when driving ADC ch 1
    Now switch to the other ADC channel.  No difference there either - 0.65 to 0.7 dB of rolloff.
    Looking at reviews, a lot of DACs roll off by 1 dB or more before 20 kHz.
        Not all - Benchmark DAC3 doesn't appear to, though it's hard to tell for sure.  
        (And as I've seen slow rolloff filters with 3 dB or more are common.)
        Bryston BDA-3 has 0.25 dB of rolloff at 20k regardless of sample rate.
            (More at 44.1k due to digital filtering I guess.)
            
    Why not just try at 88.2k and see what happens? (i.e. separate analog vs digital filter)
    Actually 96k is easier.
        So, at 44.1k: 0.2 down at 10k, 0.7 down at 20k
        At 96k: -0.05 at 10k, -0.17 at 20k, -0.86 at 40k
        -> Much of the rolloff is coming from digital filters.
        So the datasheets are wrong?  Or at least don't properly account for what happens at 20k.
    Let's do a full range test at 96k BW.  20 to 46k Hz.
        In this one it appears 20k is about 0.3 dB down from the max. 
        Max = -1.14, 10k = -1.26 (bottom of ripple) 20k = -1.37 30k = -1.68 40k = -2.07
        Convert to relative: 10k = -0.12, 20k = -0.23, 30k = -0.44, 40k = -0.83
        Ripple is about +/- 0.02 dB.
    LTSpice sim: -0.02 at 10k, -0.09 at 20k, -0.20 at 30k, -0.36 at 40k
        So, it looks like the frequency scale shifted a bit relative to what I expected.
        Just try with different caps next time.
        To move the -0.1 dB point to 33k: use 3.3n and 2.2n caps, or 3.9n and 2.7n.
        Now -3 dB is 160 kHz.
        Just experiment as needed.
    I guess the obvious question is why don't I try now?
        See what NP0 caps are on hand. 2x 3.9n, 2x 1n, and then (1206) 1.5n and 3.3n
        I don't think 1206s will fit sadly.
        -> Just wait until the 2nd board comes to experiment with cap sizes.
        
        
Did get one hang when running at 96 kHz.  Well, that's a separate issue (timing?)
    96k has more/worse slip ups that have low SNDR - should probably be able to find an example by spot checking
    
Also, want to do sweeps with SE output.
    Distortion:
        At -0.1 dBFS, -99 HD2 and -106 HD3.
        At -3 dBFS, -102 HD2 and -114 HD3.
        At -10 dBFS, -107 HD2 and -123 HD3.
    Sweeps saved in plots dir - see README
    Same FR, no major problems jumping out (assuming differential sense / isolated connection)
    SNDR is around -91.  (10 dB worse than diff output)

    With attenuator (10 dB):
        At -0.1 dB, -89 HD2 and -107 HD3.  (HD2 due to loading of amp?)
        At -10, -99 HD3 and -115 HD3.
        Should try listening with it.  But it doesn't appear to increase HD3 and definitely doesn't reduce HD2.
    
    Crosstalk:
        Can't see any crosstalk from the DAC outputs.  ADC crosstalk does exist, -100 dB or so.    

Other note to remember: Occasional startup/SPI problem still happen, leaving us with wrong sample freq. or no output.
    Maybe this is ADC only?

I think I'm comfortable with:
    Ordering parts for a 2nd DAC2.
    Punching out chassis holes.
Why not do a little bit of DAC8/ADC8 characterization?
    At least check all the DAC8 channels.
    First 2 DAC8 channels look bad. (0, 1)
    No signal on channel 5
    Well, 5 out of 8... (Distortion at full scale is about -100 dB HD3, -110 HD2 with atten at -10 to prevent ADC from contributing.)
    a) Missing signal on ch5. (OUTR3)
        Output buffer on bottom, right side of board.
        There is signal reaching the input of that buffer.  So the buffer is probably the problem.  Check soldering.
        -> Attempted fix (soldered a pin that was lacking)
    b) Bad distortion on ch0/1 (OUTL1/R1)
        Amp is U12 - may have been a bad supply connection
    OK, try again.
    Now we appear to have signal from ch 5 (looks clean).
    What does the ch0 signal look like?  Waveform...
        Doesn't look too dirty; the HD is -50 dB... but definitely modulated.
    What do ch0+1 have in common?
        1) Buffer op amp (but not really... the same op amps are used for ch 2-3)
        2) DAC reference/supply ... pins 20/21 are the ref.
            Might be some bad soldering... try touch up.
        -> Yep.  Fixed.
    OK, now all the channels are good.  Want to try stepping?
    Try -3 dB.  Same as ADC2 tests.
        Appears to have rising distortion, especially HD2, at higher freqs.
        Freq response is good. -0.1 dB at 20k, like it's supposed to be.  Maybe slight peaking before that though?  (0.04 dB)
    Try a different channel.
        Same.  Saved results (20171124_181047)
        Oh.  But most of the distortion is coming from the ADC.  (Or the output buffer?)
        Time to use the attenuator. (10 dB)
            This makes dist about -104 HD3, -100 at 6k
            HD2 does rise gradually from the noise to -105 at 1k, -96 at 5k, -90 at 10k
        Also, I heard some mechanical sounds from the board (not sure why?)
        5k spectrum shows nothing too unpleasant.
        Interestingly HD2 goes down when I change the attenuator from -10 to -20, so ADC is contributing -100 dB even at -10 dBFS in.
        And at 0...HD2 -78 HD3 -82; and DAC crosstalk is worse than when the attenuator is disabled. (-83)
    So why is distortion so bad?
        OPA1664 op amps are the same as the DAC.
        THS4524 is supposed to not be a bottleneck.  Doesn't have limited swing either.  Bad layout?
        Bad capacitors (not NP0) somewhere?
        Common mode problems getting converted to differential at the DAC?
        DC load current being drawn from op amps (due to CM shift of diff amp)
        Lack of VREF decoupling? It's being driven by a reg... oh wait, and 100 uF caps.
        I'm stumped.
        Power supply current modulating VCM?  A5V is used to power THS4524.  But on scope, A5V doesn't move during operation.

Put DAC2 back in system.  Listening notes:
    Took some time for the system (ears?) to warm up, hasn't been used in a while.
    May have some of the dynamics back.  Train concert, which I know was compressed, had good drive.
    Still relaxed.  Highs still slightly soft. I can't tell if it's congestion or just a more revealing texture.
    Bass is about what I expect.  (But need more time for break-in.)
    Guitars from Redbird have ... vitality.  Sounds pretty natural.  This may not be distinctive characteristics of the DAC.

Tomorrow: all holes on main chassis.  Install all connectors (except Ethernet, dammit).





Anything else to do before chassis punching?
    Nothing.  Just going to listen to DAC2 now that the filter resistors are fixed.
    (Can try listening with attenuator, too.)


11/25/2017
----------
Got the chassis ready for other modules.  It was a long ride.

Couldn't get AK4490 phase invert bits to work (of course, there are many places I could invert a channel...)
    So I rotated the connector.

Got things working late, didn't do any listening.

Tomorrow:
    Buy DAC2 parts + Ethernet cable (there is now a rear panel cutout for it...)
    Listen (and try attenuator?)


11/26/2017
----------
Ordering parts for 2nd DAC2 build:
    Arrow  - ADI/LT stuff: $42
    Digikey - All else: $40+tax/shipping

Listening: 
    Sounds good.
    12 Songs is really cute.  Not fatiguing even with the plaintive, close miked violin (and clarinet?)

But there is a functional problem.
    play_stream.py hangs, takes mpd with it.

To think about before trying active mode:
    How to control volume?
    Proper solution would be a proper driver.
    But Python script could poll for changes to a file, for relative changes, and communicate back
        Need to make sure it's impossible to accidentally set the volume to 0 dB.
    I think it's important that volume control changes be acknowledged.
        Maybe?  Client at least needs to know what the volume setting is.

11/30/2017
----------
Assembled 2nd DAC2 over the last two nights.
    Dammit, should have ordered those 50k resistors.
    Hacked with 1206 100k resistors for LT3042 Rset...

Replaced 5 V power inlet.
Installed Ethernet connector (from behind; cutout wasn't quite large enough.  Try again?)

Initial bringup: nothing blew up, voltages OK.  But:
-   Too much noise.
    Arta: Noise is -64 with no signal.
-   Too much gain.
    With an input signal of -60 dBFS, Arta shows -43 dBFS.  
    Arta issue?  Multimeter shows me 0.1 V at -20 dBFS...

Never mind, now Arta is happy.
But: Attenuator issues.
    Attenuator at -10: Correct amplitude but lots of spurs.  (Common mode?)
    Spurs don't look like harmonics.
    Persists at -20 atten
    Persists with -10 dBFS signal
    Does the other DAC2 board do this?  No.  But also its attenuator isn't working?
        Think that's an isolator problem.  Odd.

That's enough for tonight.

12/2/2017
---------
Attenuator issues with new DAC card in slot 1
    Hard to see on spectrum what it is.
    Time domain shows: random spikes (near peaks of sine wave?)
    Stopping SCLK fixes it?
    No, just makes the problem different:
        Mixing with 60 Hz, and higher harmonics.
    Seems to become more apparent as signal amplitude is reduced.  Weird.
    Problem is visible as "walking spikes" on sinewave in time domain.
    SCLK back on - seems to not make a difference?
        ARTA shows clean sine wave at 0 dBFS, but spikes on sound card scope?
        Suspicious.  Let's look at a loopback test, and differential.
        XLR cables come out.
    In differential loopback, I don't see any problem.
    So either it was a common mode issue, or a soundcard issue.
    All looks good, for now, with slot 1.
    
Slot 0?
    Looks fine.  Attenuator works.

Alright, let's put a lid on it.  And start using it for digital filters.

Setup with XLS1500 and test speaker.  Notes:
    Slot 0 left output is dead - maybe bad connection?
    Right output is fine.  And slot 1 is fine.
    Noise level: hold that thought...
    OK, -80 dB tone.  Not sure the Crown likes those.
    Not going to be easy to gauge until I run filters and open up the gain.
    
Ah, encountered problem with play_stream hanging.
    Is it recoverable?
    Maybe, I just ran setup_clock.py, it errored out, ran it again OK and can play stream.
    Will keep trying to find out what causes this and how to get around it.

Anyway, wired up the speaker for active crossover mode.
How to play music through FIR filters?  I've done this before...
    Have a play_stream_4ch.py, will need to modify for split-slot setup
    Now trying to resurrect the speakers lib...
    Crash on startup - seg fault loading dynamic library
    -> Probably fixed, had 
    
Now I just need to setup the ALSA/PA audio devices correctly.
    Dammit, this is annoying.
    What I need is an ALSA input device which receives the sample from an ALSA output device that MPD is playing to.
    The runspeakers script will use that input device and, for output device, play_stream_4ch.py
    Ok, I'm trying to use the hardware loopback device...
        Everything seems like it's working, but there's no output.
        I do know play_stream_4ch.py works.  I can make tones with it.
    
12/3/2017
---------
Debugging the ALSA/runspeakers flow.

1.  Getting data to the input device (loopin).
    MPD is configured to send audio to loopout.
    Use arecord on loopin.
    arecord gives nonzero data with default config: 8 kHz mono 8 bit
    I can change to stereo and to other formats incl. 16 bit int
        32 bit int just zero-pads the 16 bit ints
        float doesn't work ("can't install hw params")
    But I can't change the sample rate?
        Actually, I can change it to 48k.
        But I can't change it to 44.1k, it receives no data.
    Had a similar problem before.  Forced sample rate conversion using "plug"...
    What's interesting is arecord -v shows the loopback device as having sample rate 44100
        So when I select a non-44100 sample rate, it inserts the libspeex converter.
        What about 22050?  That and 88200 don't work.
        Anything that's an integer ratio of 44100 doesn't work? (Or close... 44000 works, but 44050 doesn't)
        Weird.  Customize buffering somehow?
        -B option doesn't seem to help.  Same for -M
    WTF... I can only get samples out if I ask for a sample rate conversion?
        Interesting, the VU meter runs when I'm at 44.1... so maybe the problem is arecord.
    Put this on hold for now.  Allow Python code to report amplitude of incoming samples.

2.  Monitoring amplitudes at I/O of runspeakers
    Initial test shows that I do get data, but it's all zero.
    Maybe my conversion to double precision was a bad idea.
    PortAudio supplies data in float32 form.  There is no float64.
    That's fine, just need to convert to the NUMERIC (double) type on the way in.
    OK, now I got some nonzero looking output samples.  (Maybe they were there before too?)
    Now, switch to play_stream_4ch output device.
    
Sound!
Is it any good?
    The tweeter is shit.
    Is it worth trying to measure it and optimize the filters?
        No.
    But should get volume working.
        Obvious idea: alsamixer, but that doesn't work.
    Things to try:
        1.  DAC2 attenuator.
            Seems to work.  Will need to brainstorm various reliability concerns.
            At -20, peak SPL with XLS1500 cranked is about 90 dB on the desk near the speaker.
            Add -5 dB tweeter pad?  (What was used in original speaker?)
            -4 dB sounds OK (though I'm wearing earplugs)
            Noise?  Definitely some, though it could be the amp somehow.
                -> I think it is the amp, because with atten at -30 it's still about the same.
            DC28 noise does increase as the amp is cranked, but it's tolerable - need to be close to speaker.
            Perhaps not the SNR I want though.
            With -30 dB setting, peak SPL is tolerable at full scale, amp wide open
                Scary to think about what would happen if that failed.
                
            Is there any way to verify that the attenuator is engaged to the desired level?
            
        2.  AK4490 internal volume control
            Doesn't seem to work.  Maybe something is wrong with the SPI?
            Doesn't seem to work for either slot 0 or 1.
            (Had a similar problem where I couldn't invert phase.)
        
        3.  Polling for file and scaling in play_stream_4ch script.
            Probably want to use this most often, as fine changes may be requested.
            Good frameworks/libraries for remote control?
            http://electronut.in/talking-to-a-raspberry-pi-from-your-phone-using-bottle-python/
                Uses Bottle.  Single-file function.
            Another idea: JqueryUI slider
            -> Implemented.  Took a while to figure out, but it runs.
            I ended up using sqlite so there would be no missing file during an update.
            

Gain structure notes
    XPA-5 has gain of 40 dB, so 1 V RMS drives it to clipping.
    

Notes on reliability:
    Ctrl-C on Python runspeakers: stops gracefully, no pop
    Startup: from zero to music instantly
    Was able to get the USB device stuck after perhaps Ctrl-C at a bad time?
        See if I can get ZTEX software to reset the thing.
        FWLoader works, I guess.  Had to reset the FPGA and the EZ-USB controller.
            (run once with -rf and once with -ru)
    Note that running setup_clock creates a big transient.  (But it's limited by the attenuator?)
    There was a sudden stop when I went to measure the speaker level - why?
        Nothing seemed broken afterwards - restarted runspeakers
    Switching clocks seems to generate a pop, even when attenuators are enabled.
        Not sure I understand why?
        That's on the to do list for the future.
        For now, clock is selected at system startup. Not during operation.  (Power off amplifiers)
        There may be a bug in da_platform.sv: not all slots are reset?
            But regardless, when you do reset a slot, hwcon gets set to 0.
            So that might explain why we can't use attenuator during the clock change.

Todo:
    Measure FR of active crossover (so I can construct equivalent filters)
        It would be nice to do this without removing the cover - in order words, need to get loopback script working on Rpi.
        (Shouldn't be too hard - verify with ADC8 and one of the DAC2s)
        
    
    
    Figure out what was up with the left channel
        No signal, still, slot 0 left.  Open it up.
        It works fine.  The problem was a bad connection when I smushed up the cables by closing the chassis.
        Cover back on, no problem.  But watch for dropouts in the future.
        
    
    Develop safety plan
        1. Wear earplugs.
        Main question: How to detect signal level before turning on the amplifier?
            
        
    Install in main system
        
Let's go ahead with crossover char.
First, software update...
    Loopback script hangs on RPi.  (Except when data is all zeros since SPI messed up?)
    Not enough BW for 8 ch ?  No I doubt it.  Might hint at another problem.
    Seemed to work with chunk size 1<<8 (not 1<<9)
    Not reliably.  Turned off async mode for now.
    Also, SPI is broken (ADC operates at wrong samplerate)
    Seems to work once after reset then hang after first write on second run?
    It's stuck in USB write.  Does that mean buffers are full, or that we didn't read all available samples?
    Skipping start flag at beginning (which causes dropouts) doesn't help
    If I run loopback in a loop, it doesn't break until the program finishes and I start it again
    Any asymmetry?
        Reading leftover ADC samples?
        FIFO status doesn't seem to update when we do this.
            (Even when retrieving after the fact.)
        There are very many leftover samples - maybe it times out?
        Can get it to claim it read all leftover samples (many... 100k+?)
            ADC operating at 2x sample rate might cause this.
        Need to read leftovers in chunks?
    This is so strange.  Now I have to look at the result when running from PC.
        Yep, same problem.  Bisect.
        Fix seems to be: constructing DAPlatformBackend with reset=True
        Huh?
        Oh well, it works.
        
    Now trying to figure out why the spectrums aren't clean (but they were, sometimes, when I wasn't resetting.)
        Waveform: big spikes at beginning (and then once in the middle)?
        Try a blocker?  Doesn't help to block slots until after first write.
        Attenuator taking effect late?  Maybe.  Added 1/2 sec sleep and it's somewhat better, still not right.
        Waveform shows: random spikes
        Chunk size reduction didn't help
        Async vs sync - no difference
        Both channels spike at the same time, so it's a digital issue most likely
        Zoom in?
        Spikes appear short, only a few samples, so not really dropouts
        Any periodicity?
            1700, 3600
            1600, 1950, 2650
            



XLR to SE adapters?
    With female XLR:
        Pins 1, 3 connected to RCA shield
        Pin 2 connected to RCA center
    With male XLR:
        Pins 1, 3 connected to RCA shielf
        Pin 2 connected to RCA center
    So those won't be very useful at least connected to outputs of DACs.
        Even though DAC2 would clearly be able to tolerate it since the attenuator is designed to have its output shorted.
    But hell, why not?  Sure saves time over having to re-wire for RCA.
    

12/18/2017
-----------
Lots of distractions at home, but back to debugging loopback on Rpi.
Waveform: Lots of little spikes.
    Spike magnitude is close to full scale even with DAC attenuator at -20.  So, probably ADC related.
    Getting zeros a lot of the time too?
    Chunk size of 512 and display=True: fewer spikes but still a lot
    Decreased sleep in EZUSB backend read_and_write() to 1 ms - got a clean test
        Still sometimes get zeros, but glitches might be gone?
        Makes sense that on RPi, asking to sleep 10 ms might be too much
        when 512 chunk size = 11.6 ms
    -> seems we're good for now.  Try THD/SNDR sweep.
    Without display=True, get zeros?
    Added a yield to the main loop.  Still bad results on sweep.
    Maybe the difference is 0.5 vs 1.0 sec?
        At 1.0 sec, single tone FFT is ugly but first few samples look OK.
        Spikes are appearing in the second half of the waveform. (Software getting backed up?)
        Try without display?
        Same thing, more or less.
        Change chunk size?  1024 -> clean but no THD/N extracted?  No, seems THD+N was extracted.
        OK so just use this for sweep?
        Got a decent loopback meas.  SNDR around 80 with 20 dB atten.  THD around -100 but funky at low freqs.  (Why?)
        Check 40 Hz single tone: looks like a lot of higher order harmonics.
            Increase drive to 0 dBFS?
            About the same.  Worse in one channel than the other.
            -10 dBFS?  About the same.
            Looks like 60 Hz stuff and not HD?
            Try a non harmonically related frequency like 43.
            Mixing?  Same set of products are there.
            EMI?  But this is a differential measurement...
            400 Hz tone shows: these products are always there (EMI/supply).  Should figure out what caused them, but it's not a nonlinearity.
        Other problem: Data coming back on wrong ADC channels?
        -> Seemed to go away.  Put an assertion to make sure we don't fetch an invalid number of samples, which could cause that problem,.
        
    How about single ended testing, now that I have ribbons... (6 weeks shipping on a boat from China to Los Angeles)
        After restarting, getting spikes again?  Signal is there, though...
        I think this is just software garbage.  Over time, it seems to be getting better.
        Found some sample counting bugs but they don't seem to affect spikes.
        
    Obvious question: do spikes happen when testing from PC?
        No.  Works great.  I'm going to use this to characterize the crossover.
        Any differences in code?
            None that look relevant.
        Rrr.

SE performance notes:
    SNDR is only 65 dB with 20 dB attenuation.  Reasonably clean spectrum, just more noise and 60 Hz stuff.
    With 0 dB, we get 69 dB.  There's just a lot more noise in SE mode.  And most of it appears to be DAC.
        (Note: crappy cables, not paying attention to EMI, etc.)
    HD2 is around -81 dB, no other harmonics visible (but high noise floor).

Alright, let's try that crossover.
    (First, woofer output)
    I can get a clean tone through it...
    With volume knob all the way up.  Let's run sweeps.
    Notes from looking at sweeps:
        Woofer channels are off by about 0.2 dB from each other.
        Bass EQ is slightly different freq (38 vs 40 Hz) but same depth of 2.6 dB
        Treble EQs look different between the two channels.
        a) Midband cut - 1.3 kHz, similar Q but one is deeper (limited frequency resolution?)
        b) Treble boost - peaks at 16 vs 18 kHz, 18k peak is higher
    OK, now to try and reproduce these results with speakers lib:
        Did a bunch of manual fitting, seems pretty close.
        Generally split the difference between L/R channels where they were different. (xover/xover_err.pdf)
        Couldn't do bass EQ with short filters - that is a project for later
        Tweeter HP ended up being 5th order to match final rolloff (and phase?)
        Concerns about tweeter EQ accuracy.  Can always adjust by ear.
    Distortion/noise...
        HD2 - around -80 for LP, -72 for HP
        HD3 - around -100 for LP but creeps up at lowest freqs (-70 at 20 Hz, -90 at 45 Hz); roughly -90 for HP
        High order HD - varies from -80 to -100 for LP, -80 to -90 for HP
        SNDR - 65 for LP; HP degrades with rolloff, about 45 dB at 1k
    So definitely an opportunity for improvement.
        
What's next?
    Test with test speaker/XLS
        OK
    Test in system
        DC, AC levels measured at amp outputs look OK.
        Right woofer silent. Other channels working.
            Try to fix this first...
            Fine,
        L/R out of phase.
            Both LP and HP.  What a coincidence.
            Easy enough to fix by swapping speaker wires.
        Lots of hum/buzz.
            Seems to vary per channel (but definitely louder in the tweeter due to sensitivity)
            Didn't get this with the XLS1500?
            Why?
                No earth?  AGND is isolated from earth in source, and amp has a 2-prong connection.
                Hypex app note: "correct shielding practice requires that pin 1 be connected to the chassis and nowhere else"
                This suggests ground loop currents are being dumped into AGND in the source and subject to CM/DM conversion somewhere.
                Easy enough to try changing the pin 1 connection on the XLRs.
            Try changing the attenuator setting, see if that makes any difference.
        Peak SPL not as high as I expected.
            Need to do the task below...
        Sound quality: hard to tell
            Nothing jumped out at me.
            Dynamics seemed OK - haven't tried rocking out.
            Bass bump definitely there, oh well.
            Treble, maybe a little more air/sizzle due to EQ?
            Maybe a little more depth apparent on Jack Johnson?
            Needs more listening once the buzz is fixed.

XLR pin 1 mod
    Where to attach shield on chassis?
        Could use AC inlet earth connection point - long wire
        But the right thing is to use the standoff pads on the DAC2 board - they aren't connected to AGND.
        Also, don't have proper screw lugs.  Going to solder directly for now.
            
    Look at amplitudes, evaluate attenuator settings
    
12/20/2017
----------
Testing XLR pin 1 mod
    Lots of buzz.  XLS amp is not happy.
    Why?
    Probably because I totally got the XLR pinout wrong.  Correct pinout is:
        1 = Shield
        2 = Signal P
        3 = Signal N
    What I did was
        1 = Signal N
        2 = Signal P
        3 = Shield
    So, in initial setup, amp was seeing difference between signal P and shield, i.e. the single-ended output.
    And in the current setup, amp was seeing difference between signal P and shield, i.e. the single-ended output relative to chassis ground.
    Rrrr....
        Crazy washer hack probably wasn't necessary.
        What is necessary is redoing the XLR connectors.
        (Didn't detect with loopback test since ADC has the same wrong pinout)

Testing with XLS amp:
    Left channel good.  (Some hum when first plugged in?)
    Right channel - tweeter good, woofer has hum.  Hard to tell if it's significant.
    Maybe it gets better with warm up?
    Will just have to test with the main system.

12/22/2017
----------
Continued hum/buzz debugging: XLS amp
    With chassis lid off, no buzz.
    Try putting it back on.  Maybe I accidentally shorted one signal to chassis.
    -> Confirmed.  Right woofer pin 1--2 are shorted, none of the others are.
    Now should be fixed.

Testing in main system
    Some audible hiss near speakers.
    Right tweeter also has a little buzz.  Not sure where it's from (amp?).  Not objectionable.
    More gain, but still some on the table.  Max looks like about 90 dB avg.  Need to play with input_scale option on filters.
        What SPL would I expect with 0 dBFS = 8 V RMS into woofers?  
        Say, 2 V -> 87 dB at 1 m from one speaker.  (After baffle step) 81 dB at 2 m; 84 dB from 2 speakers; 96 dB at 8 V.
    Run a few hours of music to get an idea of the sound.
        First impression is it's lacking some warmth relative to the analog crossover.
        Top octave might be tipped up a bit (adjust EQ?)
        Nothing objectionable yet.

12/23/2017
----------
More testing
    Sound is fine.  Will resolve hum before doing more eval.
    But the hum is confusing.
        XLS1500 had no hum (and acceptable hiss)
        XPA-5 has hum. Seems to vary on its own over time.
    Found lots of online discussions related to hum problems with XPA amps.
    
    Proposed explanation:
        Due to its home audio oriented design, XPA-5 has no Earth connection.  (*May* be useful for avoiding hum problems with RCAs.)
        Thus a large CM voltage develops between the XPA-5 internal ground and the source ground (AGND).  Say, 1 V RMS.
        The XPA-5 doesn't have infinite CMRR (say, 100 dB), so this gets through - 10 uV amplified to 320 uV.
            Assuming 100 dB, 1 m, 2.83 V tweeter sensitivity, 320 uV is 20 dB at 1 m.
            I think I have more than that... but the numbers could be different.
    Proposed experiment:
        Tie AGND (at the power supply) to earth.  Earth is then at least tied to XPA-5 neutral, somewhere.
    Other proposed experiment:
        Use XLS1500 for tweeter amp.
        (And long term switch to different amplifiers.)
        -> Works, tweeters have no buzz.
            Gain adj: XPA-5 is 32 dB, XLS1500 is 30--31 dB -> not that far off.  Adjust by ear.
        Woofers still buzzing, but not as sensitive.  (Can experiment with different XPA-5 channels for minimizing buzz.  Left channel is worse right now.)

Some listening
    Note: moved woofer channels around on XPA-5 to get somewhat better hum.
    Treble sounds a bit cloudy/gritty.  Not as clean or relaxed as the XPA-5.  But still not bad.
    Probably won't get to do a serious eval until I have a new amplifier.  (To use for treble; use XLS1500 for woofers?)
    Arggh.
    Seems a little dry/gritty in the treble.  Reduced HF peaking and overall level slightly.  but I think I need a 
    
Amplifier options besides designing my own
    Modulus-86 - bare boards $69/ch, which is ridiculous for a chip amp (but it does appear to be thought out)
        Note: Mark Johnson made a somewhat thoughtful PSU board called RingNot?
        Available, supported, not sure about subjective performance but that's not what it's about.
    "The Wire" LPUHP - not sure if it's still available - probably not
    Think about it.

Results of thoughts
    1) Try AGND/chassis jumper, just see what it does.
       It will be a learning experience.
       And if XPA-5 can be used in short term that will improve things subjectively.
       Where to connect at PSU?
        Transformer CT is the obvious place.  But that's not as clean as PSU out.
        Whatever, start there.
       Maybe reduces hum slightly but not enough?
        Ch3 is lowest hum.  ~1 mV.
        Ch5 is next lowest. ~4 mV.
    2) Build a Modulus 86.
       The amp PCBs are exorbitant but don't make up the majority of project cost.
       Probably want to use a RingNot[?] PSU board though.
       Work out chassis/parts details later.
       Also a learning experience to see what a "specs only" approach to amp design brings.
       
Overall plan:
    Chill out and listen to current system with XLS1500 for tweeters.
    Plan out a quick/easy Modulus-86 build.
    
Amp Build planning
    By the book.
    Transformer: 200 VA 22 V x2
    One recommended chassis is https://www.modushop.biz/site/index.php?route=product/product&path=204_205&product_id=725
        Cost is EUR 120 shipped.
        But check that it's big enough.  Might be a bit tight.
    Transformer:
        Example build has http://www.antekinc.com/as-2222-200va-22v-transformer/
        RingNot specifies this exact transformer (tested with, presumably)
        This one is reasonably priced at $32, but out of stock.  Check back before finding substitute...
    This chassis would look similar to Samoyed and is full width (360mm inside vs. 250).  Cost is EUR 149 shipped. 
        https://www.modushop.biz/site/index.php?route=product/product&product_id=193
    -> Will start separate notes for this as it's out of context of DA platform.
    

12/28/2017
----------
With main chassis nominally working in main system, and waiting for amp upgrade, it's time to focus on open sourcing.

Todo:
- Identify all license encumbered RTL file
- Rewrite all those and debug design after these changes
- Clean up hierarchy
- Add some basic documentation including licenses
- Push to Github

So what files have license problems?
    verilog/contrib/fifo_sync.sv:    Copyright 2014 MIT
    verilog/contrib/fifo_async.sv:    Copyright 2014 MIT
    verilog/contrib/fifo_async2.sv:    Copyright 2014 MIT
    verilog/contrib/delay.sv:    Copyright 2014 MIT
    verilog/contrib/mig_adapter.sv:    Copyright 2015 MIT

Plan:
    Making new SV async FIFO module that will be used everywhere
    Making new SV delay
    Rewrite mig_adapter - simpler/more elegant would be nice

Most modules have been converted to SV.  Sim compiles but doesn't do anything.


12/29/2017
----------
Agenda: simulation debug and MIG adapter redesign

After some debugging it looks like we're ready to do the MIG adapter.


2/8/2018
--------
After long hiatus including amp build, some listening notes in differential mode.

Smooth.  Very clean on high dynamic range recordings.  Low noise floor.
Rock music can be in your face at high volumes.  But it's probably supposed to be that way.

Hard to separate my impressions about the source from the amps, which have also been changing.



4/4/2018
--------

More general listening impressions:
    Clean but sometimes a little sterile on the top end.
    Definitely need a better woofer amp, XLS1500 is showing its weaknesses now that I've gotten to listen to it for a while.  Missing some richness and dynamics.
    All in all, needs further experimentation (incl. SE vs. diff, filter adjustments) after amp situation is remedied.
    Also, never measured top end response of DAC2 with different caps (slot 1), maybe there's something wrong there.

Have done a lot of code rewriting and simulation work.  Almost ready for open source.
Also cleaned up synthesis warnings and timing violations.
Now time for testing the new bitstream - obviously, doesn't work, need to debug with ILA.

First notes:
    Hang when running loopback test.
    Recording is enabled, data is coming into ADC
    Within slot controller, adc_fifo_write_count = 8 (normal)
    audio_tx_fifo_{wr,rd}_count = 0x10.  Which means audio_tx_fifo is full.
    Who reads audio_tx_fifo?
    Main state is 1    --handle input, why?
    When I stop execution before adc.audio_read_write, ILA shows what looks like normal operation.  
        FIFO status is 8M words writtein, 64 read.
        I can see the write count increment at what looks like the right rate.
        I can read 16 words 5 times before things go awry.
        The first time I read, the FIFO status shows read counter going up to 80.  Then it stays there.
        So at least I'm probably getting valid data?  The question is why does reading 16 words screw it over?
        I can also read 32 words, or 256, or 1k.  But after the first read it's screwed.
    Fair enough, let's try isolating this in simulation.
        See it in the arbiter.  port_out_sel is ready but not valid on 2nd batch.  (1st batch looks fine.)
        Looks like it goes back to mem cmd / MIG adapter: requested 0 words.
        FIFO to the top level is full (64)
    -> Fix applied to prevent FIFO arbiter from requesting 0 word transfers.
        Now I can run loopback script and get data...
    OK, now hook up some XLRs and try really looping back.
    Doh, it's RCA only for the ADC.  Try DAC8 to ADC8 as sanity check?
        Reasonable looking noise, but no signal.
        Multimeter confirms 0 V from DAC8.
        ILA on I2S lines?  Nah, multimeter.  Seems they're getting something.  0.8 V DC.
        Check register map / HW interface pins.
        Reset?  (pin 48) High (inactive) at module interface, couldn't probe directly.
        Supplies are good-1.8/3.3/5
        DC level of the outputs is 0.  Disabled internally?
        HWCON voltage is 2.47 which will definitely screw things up, because HWCON connects directly to SPI mux.
        HWCON vs slot is 3.3 (8), 2.47 (6), 2.47 (6), 1.64 (4).
        OK, HWCON is broken.  The same voltages are there when I write 0 to all HWCON registers.
        -> Examine this on ILA first.  Sim looks fine.
            Already had serialized HWCON on ILA.  Looks consistent with HW.  Need to find out why command didn't get through.
            8 word message - OK
            Checksums don't match?  Hard to tell...
            Slot 3 gets current_cmd = 0x80, which is right.
        What do you know, monitoring with ILA causing it to work.
        What about SPI? 
            SCLK divider ratio was set to 8.  Changed to 16 to reduce from 6 MHz to 3 MHz.
            (AKxxxx datasheet says 5 MHz max.)
        I2S lines look OK in ILA, nonzero data.
        
4/12/2018
----------
After computer hiatus, time for more debug.

Symptoms: (slot 2-3 8 ch loopback test)
    Can read plausible data from ADC, but no actual signal from DAC, it appears.
    Multimeter confirms 0 volts at outputs.
    On DAC8v2 board, R7/R8 are the first 2 channel outputs.
        But their DC is at 0 V?
        Something is disabled in the DAC.
        HWCON still messed up at the moment.  What?
        -> Debug again.  And look at warning messages?
        After setting HWCONs to all 0, get 3.3 on slots 0-2 and 1.65 on slot 3
        
Possibly a hold issue related to CS/HWCON serializers.
    At top level:
        Parallel clk: srclk_sync
        Serial clk: sclk_ungated
        -> Should be fine
    At slot level:
        Parallel clk: srclk2_sync ( = !(cycle_count % 64 == 63) )
        Serial clk: srclk_sync ( = !(cycle_count % 8 == 7) )
        Both of these are registers clocked on the rising edge of sclk_ungated
        The serializer checks clk_par (srclk2_sync) at the negative edge of clk_ser (srclk_sync), so clk_par should be stable before clk_ser falls
            IOW, srclk_sync should be delayed slightly after srclk2_sync
            
Implemented a fix which is to trigger srclk2_sync on negedge of sclk so it happens a bit earlier than srclk_sync - avoid hold violations
    Now we have audio of some kind... Not clean though.
    Must be way too slow.  Periods of valid audio with zeros in between.
    Maybe this is just the same software limitation I've seen before.
        -> Need a faster driver of course.
    Playing a tone through the 2-ch DAC, amplitude looked good.
    Playing music through FIR crossover (2-way), amplitudes look good.
        -> Proceed to testing with speakers.


4/21/2018
---------
From testing, there were relatively frequent audio glitches and the host Python script was very busy.
    Cause: stalling during audio write
    Fix: adjustment to FIFO arbiter state machine
    
Now, an earlier problem with the filters getting stuck seems to be resolved.  Everything ran smoothly overnight.
But frequency response is messed up (filters? wiring connections?).
    Seems to be a 10 dB attenuator difference.
    After setting LF DAC attenuation to 20 dB, sound is back to the same it was before.
    
Initial code cleanup, licensing and docs framework completed.  Ship it.

Next steps:
- Write docs (have some disorganized thoughts in writeup.txt)
- Pull code to RPi and debug
- Make sure latest HW designs, e.g. PCBs, are in repo
- Write issues to keep track of to-do instead of this horrendous text file




